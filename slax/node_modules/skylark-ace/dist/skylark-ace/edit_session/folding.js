/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(t,e,i){"use strict";var n=t("../range").Range,o=t("./fold_line").FoldLine,r=t("./fold").Fold,s=t("../token_iterator").TokenIterator;e.Folding=function(){this.getFoldAt=function(t,e,i){var n=this.getFoldLine(t);if(!n)return null;for(var o=n.folds,r=0;r<o.length;r++){var s=o[r];if(s.range.contains(t,e)){if(1==i&&s.range.isEnd(t,e))continue;if(-1==i&&s.range.isStart(t,e))continue;return s}}},this.getFoldsInRange=function(t){var e=t.start,i=t.end,n=this.$foldData,o=[];e.column+=1,i.column-=1;for(var r=0;r<n.length;r++){var s=n[r].range.compareRange(t);if(2!=s){if(-2==s)break;for(var l=n[r].folds,a=0;a<l.length;a++){var d=l[a];if(-2==(s=d.range.compareRange(t)))break;if(2!=s){if(42==s)break;o.push(d)}}}}return e.column-=1,i.column+=1,o},this.getFoldsInRangeList=function(t){if(Array.isArray(t)){var e=[];t.forEach(function(t){e=e.concat(this.getFoldsInRange(t))},this)}else e=this.getFoldsInRange(t);return e},this.getAllFolds=function(){for(var t=[],e=this.$foldData,i=0;i<e.length;i++)for(var n=0;n<e[i].folds.length;n++)t.push(e[i].folds[n]);return t},this.getFoldStringAt=function(t,e,i,n){if(!(n=n||this.getFoldLine(t)))return null;for(var o,r,s={end:{column:0}},l=0;l<n.folds.length;l++){var a=(r=n.folds[l]).range.compareEnd(t,e);if(-1==a){o=this.getLine(r.start.row).substring(s.end.column,r.start.column);break}if(0===a)return null;s=r}return o||(o=this.getLine(r.start.row).substring(s.end.column)),-1==i?o.substring(0,e-s.end.column):1==i?o.substring(e-s.end.column):o},this.getFoldLine=function(t,e){var i=this.$foldData,n=0;for(e&&(n=i.indexOf(e)),-1==n&&(n=0);n<i.length;n++){var o=i[n];if(o.start.row<=t&&o.end.row>=t)return o;if(o.end.row>t)return null}return null},this.getNextFoldLine=function(t,e){var i=this.$foldData,n=0;for(e&&(n=i.indexOf(e)),-1==n&&(n=0);n<i.length;n++){var o=i[n];if(o.end.row>=t)return o}return null},this.getFoldedRowCount=function(t,e){for(var i=this.$foldData,n=e-t+1,o=0;o<i.length;o++){var r=i[o],s=r.end.row,l=r.start.row;if(s>=e){l<e&&(l>=t?n-=e-l:n=0);break}s>=t&&(n-=l>=t?s-l:s-t+1)}return n},this.$addFoldLine=function(t){return this.$foldData.push(t),this.$foldData.sort(function(t,e){return t.start.row-e.start.row}),t},this.addFold=function(t,e){var i,n=this.$foldData,s=!1;t instanceof r?i=t:(i=new r(e,t)).collapseChildren=e.collapseChildren,this.$clipRangeToDocument(i.range);var l=i.start.row,a=i.start.column,d=i.end.row,h=i.end.column;if(!(l<d||l==d&&a<=h-2))throw new Error("The range has to be at least 2 characters width");var g=this.getFoldAt(l,a,1),f=this.getFoldAt(d,h,-1);if(g&&f==g)return g.addSubFold(i);g&&!g.range.isStart(l,a)&&this.removeFold(g),f&&!f.range.isEnd(d,h)&&this.removeFold(f);var u=this.getFoldsInRange(i.range);u.length>0&&(this.removeFolds(u),u.forEach(function(t){i.addSubFold(t)}));for(var c=0;c<n.length;c++){var F=n[c];if(d==F.start.row){F.addFold(i),s=!0;break}if(l==F.end.row){if(F.addFold(i),s=!0,!i.sameRow){var w=n[c+1];if(w&&w.start.row==d){F.merge(w);break}}break}if(d<=F.start.row)break}return s||(F=this.$addFoldLine(new o(this.$foldData,i))),this.$useWrapMode?this.$updateWrapData(F.start.row,F.start.row):this.$updateRowLengthCache(F.start.row,F.start.row),this.$modified=!0,this._signal("changeFold",{data:i,action:"add"}),i},this.addFolds=function(t){t.forEach(function(t){this.addFold(t)},this)},this.removeFold=function(t){var e=t.foldLine,i=e.start.row,n=e.end.row,o=this.$foldData,r=e.folds;if(1==r.length)o.splice(o.indexOf(e),1);else if(e.range.isEnd(t.end.row,t.end.column))r.pop(),e.end.row=r[r.length-1].end.row,e.end.column=r[r.length-1].end.column;else if(e.range.isStart(t.start.row,t.start.column))r.shift(),e.start.row=r[0].start.row,e.start.column=r[0].start.column;else if(t.sameRow)r.splice(r.indexOf(t),1);else{var s=e.split(t.start.row,t.start.column);(r=s.folds).shift(),s.start.row=r[0].start.row,s.start.column=r[0].start.column}this.$updating||(this.$useWrapMode?this.$updateWrapData(i,n):this.$updateRowLengthCache(i,n)),this.$modified=!0,this._signal("changeFold",{data:t,action:"remove"})},this.removeFolds=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i]);e.forEach(function(t){this.removeFold(t)},this),this.$modified=!0},this.expandFold=function(t){this.removeFold(t),t.subFolds.forEach(function(e){t.restoreRange(e),this.addFold(e)},this),t.collapseChildren>0&&this.foldAll(t.start.row+1,t.end.row,t.collapseChildren-1),t.subFolds=[]},this.expandFolds=function(t){t.forEach(function(t){this.expandFold(t)},this)},this.unfold=function(t,e){var i,o;if(null==t?(i=new n(0,0,this.getLength(),0),e=!0):i="number"==typeof t?new n(t,0,t,this.getLine(t).length):"row"in t?n.fromPoints(t,t):t,o=this.getFoldsInRangeList(i),e)this.removeFolds(o);else for(var r=o;r.length;)this.expandFolds(r),r=this.getFoldsInRangeList(i);if(o.length)return o},this.isRowFolded=function(t,e){return!!this.getFoldLine(t,e)},this.getRowFoldEnd=function(t,e){var i=this.getFoldLine(t,e);return i?i.end.row:t},this.getRowFoldStart=function(t,e){var i=this.getFoldLine(t,e);return i?i.start.row:t},this.getFoldDisplayLine=function(t,e,i,n,o){null==n&&(n=t.start.row),null==o&&(o=0),null==e&&(e=t.end.row),null==i&&(i=this.getLine(e).length);var r=this.doc,s="";return t.walk(function(t,e,i,l){if(!(e<n)){if(e==n){if(i<o)return;l=Math.max(o,l)}s+=null!=t?t:r.getLine(e).substring(l,i)}},e,i),s},this.getDisplayLine=function(t,e,i,n){var o,r=this.getFoldLine(t);return r?this.getFoldDisplayLine(r,t,e,i,n):(o=this.doc.getLine(t)).substring(n||0,e||o.length)},this.$cloneFoldData=function(){var t=[];return t=this.$foldData.map(function(e){var i=e.folds.map(function(t){return t.clone()});return new o(t,i)})},this.toggleFold=function(t){var e,i,n=this.selection.getRange();if(n.isEmpty()){var o=n.start;if(e=this.getFoldAt(o.row,o.column))return void this.expandFold(e);(i=this.findMatchingBracket(o))?1==n.comparePoint(i)?n.end=i:(n.start=i,n.start.column++,n.end.column--):(i=this.findMatchingBracket({row:o.row,column:o.column+1}))?(1==n.comparePoint(i)?n.end=i:n.start=i,n.start.column++):n=this.getCommentFoldRange(o.row,o.column)||n}else{var r=this.getFoldsInRange(n);if(t&&r.length)return void this.expandFolds(r);1==r.length&&(e=r[0])}if(e||(e=this.getFoldAt(n.start.row,n.start.column)),e&&e.range.toString()==n.toString())this.expandFold(e);else{var s="...";if(!n.isMultiLine()){if((s=this.getTextRange(n)).length<4)return;s=s.trim().substring(0,2)+".."}this.addFold(s,n)}},this.getCommentFoldRange=function(t,e,i){var o=new s(this,t,e),r=o.getCurrentToken(),l=r.type;if(r&&/^comment|string/.test(l)){"comment"==(l=l.match(/comment|string/)[0])&&(l+="|doc-start");var a=new RegExp(l),d=new n;if(1!=i){do{r=o.stepBackward()}while(r&&a.test(r.type));o.stepForward()}if(d.start.row=o.getCurrentTokenRow(),d.start.column=o.getCurrentTokenColumn()+2,o=new s(this,t,e),-1!=i){var h=-1;do{if(r=o.stepForward(),-1==h){var g=this.getState(o.$row);a.test(g)||(h=o.$row)}else if(o.$row>h)break}while(r&&a.test(r.type));r=o.stepBackward()}else r=o.getCurrentToken();return d.end.row=o.getCurrentTokenRow(),d.end.column=o.getCurrentTokenColumn()+r.value.length-2,d}},this.foldAll=function(t,e,i){void 0==i&&(i=1e5);var n=this.foldWidgets;if(n){e=e||this.getLength();for(var o=t=t||0;o<e;o++)if(null==n[o]&&(n[o]=this.getFoldWidget(o)),"start"==n[o]){var r=this.getFoldWidgetRange(o);if(r&&r.isMultiLine()&&r.end.row<=e&&r.start.row>=t){o=r.end.row;try{var s=this.addFold("...",r);s&&(s.collapseChildren=i)}catch(t){}}}}},this.$foldStyles={manual:1,markbegin:1,markbeginend:1},this.$foldStyle="markbegin",this.setFoldStyle=function(t){if(!this.$foldStyles[t])throw new Error("invalid fold style: "+t+"["+Object.keys(this.$foldStyles).join(", ")+"]");if(this.$foldStyle!=t){this.$foldStyle=t,"manual"==t&&this.unfold();var e=this.$foldMode;this.$setFolding(null),this.$setFolding(e)}},this.$setFolding=function(t){this.$foldMode!=t&&(this.$foldMode=t,this.off("change",this.$updateFoldWidgets),this.off("tokenizerUpdate",this.$tokenizerUpdateFoldWidgets),this._signal("changeAnnotation"),t&&"manual"!=this.$foldStyle?(this.foldWidgets=[],this.getFoldWidget=t.getFoldWidget.bind(t,this,this.$foldStyle),this.getFoldWidgetRange=t.getFoldWidgetRange.bind(t,this,this.$foldStyle),this.$updateFoldWidgets=this.updateFoldWidgets.bind(this),this.$tokenizerUpdateFoldWidgets=this.tokenizerUpdateFoldWidgets.bind(this),this.on("change",this.$updateFoldWidgets),this.on("tokenizerUpdate",this.$tokenizerUpdateFoldWidgets)):this.foldWidgets=null)},this.getParentFoldRangeData=function(t,e){var i=this.foldWidgets;if(!i||e&&i[t])return{};for(var n,o=t-1;o>=0;){var r=i[o];if(null==r&&(r=i[o]=this.getFoldWidget(o)),"start"==r){var s=this.getFoldWidgetRange(o);if(n||(n=s),s&&s.end.row>=t)break}o--}return{range:-1!==o&&s,firstRange:n}},this.onFoldWidgetClick=function(t,e){var i={children:(e=e.domEvent).shiftKey,all:e.ctrlKey||e.metaKey,siblings:e.altKey};if(!this.$toggleFoldWidget(t,i)){var n=e.target||e.srcElement;n&&/ace_fold-widget/.test(n.className)&&(n.className+=" ace_invalid")}},this.$toggleFoldWidget=function(t,e){if(this.getFoldWidget){var i=this.getFoldWidget(t),n=this.getLine(t),o="end"===i?-1:1,r=this.getFoldAt(t,-1===o?0:n.length,o);if(r)return e.children||e.all?this.removeFold(r):this.expandFold(r),r;var s=this.getFoldWidgetRange(t,!0);if(s&&!s.isMultiLine()&&(r=this.getFoldAt(s.start.row,s.start.column,1))&&s.isEqual(r.range))return this.removeFold(r),r;if(e.siblings){var l=this.getParentFoldRangeData(t);if(l.range)var a=l.range.start.row+1,d=l.range.end.row;this.foldAll(a,d,e.all?1e4:0)}else e.children?(d=s?s.end.row:this.getLength(),this.foldAll(t+1,d,e.all?1e4:0)):s&&(e.all&&(s.collapseChildren=1e4),this.addFold("...",s));return s}},this.toggleFoldWidget=function(t){var e=this.selection.getCursor().row;e=this.getRowFoldStart(e);var i=this.$toggleFoldWidget(e,{});if(!i){var n=this.getParentFoldRangeData(e,!0);if(i=n.range||n.firstRange){e=i.start.row;var o=this.getFoldAt(e,this.getLine(e).length,1);o?this.removeFold(o):this.addFold("...",i)}}},this.updateFoldWidgets=function(t){var e=t.start.row,i=t.end.row-e;if(0===i)this.foldWidgets[e]=null;else if("remove"==t.action)this.foldWidgets.splice(e,i+1,null);else{var n=Array(i+1);n.unshift(e,1),this.foldWidgets.splice.apply(this.foldWidgets,n)}},this.tokenizerUpdateFoldWidgets=function(t){var e=t.data;e.first!=e.last&&this.foldWidgets.length>e.first&&this.foldWidgets.splice(e.first,this.foldWidgets.length)}}});
//# sourceMappingURL=../sourcemaps/edit_session/folding.js.map
