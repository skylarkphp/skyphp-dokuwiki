{"version":3,"sources":["placeholder.js"],"names":["define","require","exports","module","Range","EventEmitter","oop","PlaceHolder","session","length","pos","others","mainClass","othersClass","_self","this","doc","getDocument","$onUpdate","onUpdate","bind","on","$others","$onCursorChange","setTimeout","onCursorChange","$pos","undoStack","getUndoManager","$undoStack","$undostack","$undoStackDepth","setup","selection","implement","selectionBefore","toJSON","inMultiSelectMode","toSingleRange","createAnchor","row","column","$insertRight","detach","markerId","addMarker","forEach","other","anchor","push","setUndoSelect","showOtherMarkers","othersActive","hideOtherMarkers","i","removeMarker","delta","$updating","updateAnchors","range","start","end","lengthDiff","action","inMainRange","distanceFromStart","$fromUndo","newPos","otherPos","insertMergedLines","lines","remove","updateMarkers","onChange","updateMarker","className","event","getCursor","_emit","removeEventListener","cancel","undoManager","undosRequired","undo","fromJSON","call","prototype"],"mappings":"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","file":"../placeholder.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n * \r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n * \r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar Range = require(\"./range\").Range;\r\nvar EventEmitter = require(\"./lib/event_emitter\").EventEmitter;\r\nvar oop = require(\"./lib/oop\");\r\n\r\n/**\r\n * @class PlaceHolder\r\n *\r\n **/\r\n\r\n/**\r\n * - session (Document): The document to associate with the anchor\r\n * - length (Number): The starting row position\r\n * - pos (Number): The starting column position\r\n * - others (String):\r\n * - mainClass (String):\r\n * - othersClass (String):\r\n * \r\n * @constructor\r\n **/\r\n\r\nvar PlaceHolder = function(session, length, pos, others, mainClass, othersClass) {\r\n    var _self = this;\r\n    this.length = length;\r\n    this.session = session;\r\n    this.doc = session.getDocument();\r\n    this.mainClass = mainClass;\r\n    this.othersClass = othersClass;\r\n    this.$onUpdate = this.onUpdate.bind(this);\r\n    this.doc.on(\"change\", this.$onUpdate);\r\n    this.$others = others;\r\n    \r\n    this.$onCursorChange = function() {\r\n        setTimeout(function() {\r\n            _self.onCursorChange();\r\n        });\r\n    };\r\n    \r\n    this.$pos = pos;\r\n    // Used for reset\r\n    var undoStack = session.getUndoManager().$undoStack || session.getUndoManager().$undostack || {length: -1};\r\n    this.$undoStackDepth = undoStack.length;\r\n    this.setup();\r\n\r\n    session.selection.on(\"changeCursor\", this.$onCursorChange);\r\n};\r\n\r\n(function() {\r\n\r\n    oop.implement(this, EventEmitter);\r\n\r\n    /**\r\n     * PlaceHolder.setup()\r\n     *\r\n     * TODO\r\n     *\r\n     **/\r\n    this.setup = function() {\r\n        var _self = this;\r\n        var doc = this.doc;\r\n        var session = this.session;\r\n        \r\n        this.selectionBefore = session.selection.toJSON();\r\n        if (session.selection.inMultiSelectMode)\r\n            session.selection.toSingleRange();\r\n\r\n        this.pos = doc.createAnchor(this.$pos.row, this.$pos.column);\r\n        var pos = this.pos;\r\n        pos.$insertRight = true;\r\n        pos.detach();\r\n        pos.markerId = session.addMarker(new Range(pos.row, pos.column, pos.row, pos.column + this.length), this.mainClass, null, false);\r\n        this.others = [];\r\n        this.$others.forEach(function(other) {\r\n            var anchor = doc.createAnchor(other.row, other.column);\r\n            anchor.$insertRight = true;\r\n            anchor.detach();\r\n            _self.others.push(anchor);\r\n        });\r\n        session.setUndoSelect(false);\r\n    };\r\n    \r\n    /**\r\n     * PlaceHolder.showOtherMarkers()\r\n     *\r\n     * TODO\r\n     *\r\n     **/\r\n    this.showOtherMarkers = function() {\r\n        if (this.othersActive) return;\r\n        var session = this.session;\r\n        var _self = this;\r\n        this.othersActive = true;\r\n        this.others.forEach(function(anchor) {\r\n            anchor.markerId = session.addMarker(new Range(anchor.row, anchor.column, anchor.row, anchor.column+_self.length), _self.othersClass, null, false);\r\n        });\r\n    };\r\n    \r\n    /**\r\n     * PlaceHolder.hideOtherMarkers()\r\n     *\r\n     * Hides all over markers in the [[EditSession `EditSession`]] that are not the currently selected one.\r\n     *\r\n     **/\r\n    this.hideOtherMarkers = function() {\r\n        if (!this.othersActive) return;\r\n        this.othersActive = false;\r\n        for (var i = 0; i < this.others.length; i++) {\r\n            this.session.removeMarker(this.others[i].markerId);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * PlaceHolder@onUpdate(e)\r\n     * \r\n     * Emitted when the place holder updates.\r\n     *\r\n     **/\r\n    this.onUpdate = function(delta) {\r\n        if (this.$updating)\r\n            return this.updateAnchors(delta);\r\n            \r\n        var range = delta;\r\n        if (range.start.row !== range.end.row) return;\r\n        if (range.start.row !== this.pos.row) return;\r\n        this.$updating = true;\r\n        var lengthDiff = delta.action === \"insert\" ? range.end.column - range.start.column : range.start.column - range.end.column;\r\n        var inMainRange = range.start.column >= this.pos.column && range.start.column <= this.pos.column + this.length + 1;\r\n        var distanceFromStart = range.start.column - this.pos.column;\r\n        \r\n        this.updateAnchors(delta);\r\n        \r\n        if (inMainRange)\r\n            this.length += lengthDiff;\r\n\r\n        if (inMainRange && !this.session.$fromUndo) {\r\n            if (delta.action === 'insert') {\r\n                for (var i = this.others.length - 1; i >= 0; i--) {\r\n                    var otherPos = this.others[i];\r\n                    var newPos = {row: otherPos.row, column: otherPos.column + distanceFromStart};\r\n                    this.doc.insertMergedLines(newPos, delta.lines);\r\n                }\r\n            } else if (delta.action === 'remove') {\r\n                for (var i = this.others.length - 1; i >= 0; i--) {\r\n                    var otherPos = this.others[i];\r\n                    var newPos = {row: otherPos.row, column: otherPos.column + distanceFromStart};\r\n                    this.doc.remove(new Range(newPos.row, newPos.column, newPos.row, newPos.column - lengthDiff));\r\n                }\r\n            }\r\n        }\r\n        \r\n        this.$updating = false;\r\n        this.updateMarkers();\r\n    };\r\n    \r\n    this.updateAnchors = function(delta) {\r\n        this.pos.onChange(delta);\r\n        for (var i = this.others.length; i--;)\r\n            this.others[i].onChange(delta);\r\n        this.updateMarkers();\r\n    };\r\n    \r\n    this.updateMarkers = function() {\r\n        if (this.$updating)\r\n            return;\r\n        var _self = this;\r\n        var session = this.session;\r\n        var updateMarker = function(pos, className) {\r\n            session.removeMarker(pos.markerId);\r\n            pos.markerId = session.addMarker(new Range(pos.row, pos.column, pos.row, pos.column+_self.length), className, null, false);\r\n        };\r\n        updateMarker(this.pos, this.mainClass);\r\n        for (var i = this.others.length; i--;)\r\n            updateMarker(this.others[i], this.othersClass);\r\n    };\r\n    \r\n    /**\r\n     * PlaceHolder@onCursorChange(e)\r\n     * \r\n     * Emitted when the cursor changes.\r\n     *\r\n     **/\r\n\r\n    this.onCursorChange = function(event) {\r\n        if (this.$updating || !this.session) return;\r\n        var pos = this.session.selection.getCursor();\r\n        if (pos.row === this.pos.row && pos.column >= this.pos.column && pos.column <= this.pos.column + this.length) {\r\n            this.showOtherMarkers();\r\n            this._emit(\"cursorEnter\", event);\r\n        } else {\r\n            this.hideOtherMarkers();\r\n            this._emit(\"cursorLeave\", event);\r\n        }\r\n    };\r\n    \r\n    /**\r\n     * PlaceHolder.detach()\r\n     * \r\n     * TODO\r\n     *\r\n     **/    \r\n    this.detach = function() {\r\n        this.session.removeMarker(this.pos && this.pos.markerId);\r\n        this.hideOtherMarkers();\r\n        this.doc.removeEventListener(\"change\", this.$onUpdate);\r\n        this.session.selection.removeEventListener(\"changeCursor\", this.$onCursorChange);\r\n        this.session.setUndoSelect(true);\r\n        this.session = null;\r\n    };\r\n    \r\n    /**\r\n     * PlaceHolder.cancel()\r\n     * \r\n     * TODO\r\n     *\r\n     **/\r\n    this.cancel = function() {\r\n        if (this.$undoStackDepth === -1)\r\n            return;\r\n        var undoManager = this.session.getUndoManager();\r\n        var undosRequired = (undoManager.$undoStack || undoManager.$undostack).length - this.$undoStackDepth;\r\n        for (var i = 0; i < undosRequired; i++) {\r\n            undoManager.undo(this.session, true);\r\n        }\r\n        if (this.selectionBefore)\r\n            this.session.selection.fromJSON(this.selectionBefore);\r\n    };\r\n}).call(PlaceHolder.prototype);\r\n\r\n\r\nexports.PlaceHolder = PlaceHolder;\r\n});\r\n"]}