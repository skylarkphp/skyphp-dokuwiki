/**
 * skylark-codemirror-base - A version of codemirror 5.45 core library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror-base/
 * @license MIT
 */
define(["../display/focus","../display/operations","../display/update_lines","../line/pos","../line/utils_line","../measurement/position_measurement","../measurement/widgets","../model/selection","../model/selection_updates","../util/browser","../util/bidi","../util/dom","../util/event","../util/feature_detection","../util/misc","../input/keymap","./key_events","./commands"],function(e,t,n,o,i,l,r,s,u,c,a,d,p,m,g,f,h,w){"use strict";const y=400;class v{constructor(e,t,n){this.time=e,this.pos=t,this.button=n}compare(e,t,n){return this.time+y>e&&0==o.cmp(t,this.pos)&&n==this.button}}let x,b;function D(e,t,n){if("char"==n)return new s.Range(t,t);if("word"==n)return e.findWordAt(t);if("line"==n)return new s.Range(o.Pos(t.line,0),o.clipPos(e.doc,o.Pos(t.line+1,0)));let i=n(e,t);return new s.Range(i.from,i.to)}function M(e,t,n,o){let l,r;if(t.touches)l=t.touches[0].clientX,r=t.touches[0].clientY;else try{l=t.clientX,r=t.clientY}catch(t){return!1}if(l>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;o&&p.e_preventDefault(t);let s=e.display,u=s.lineDiv.getBoundingClientRect();if(r>u.bottom||!p.hasHandler(e,n))return p.e_defaultPrevented(t);r-=u.top-s.viewOffset;for(let o=0;o<e.options.gutters.length;++o){let u=s.gutters.childNodes[o];if(u&&u.getBoundingClientRect().right>=l){let l=i.lineAtHeight(e.doc,r),s=e.options.gutters[o];return p.signal(e,n,e,l,s,t),p.e_defaultPrevented(t)}}}function R(e,t){return M(e,t,"gutterClick",!0)}return{onMouseDown:function(y){let M=this,_=M.display;if(p.signalDOMEvent(M,y)||_.activeTouch&&_.input.supportsTouch())return;if(_.input.ensurePolled(),_.shift=y.shiftKey,r.eventInWidget(_,y))return void(c.webkit||(_.scroller.draggable=!1,setTimeout(()=>_.scroller.draggable=!0,100)));if(R(M,y))return;let C=l.posFromMouse(M,y),P=p.e_button(y),T=C?function(e,t){let n=+new Date;return b&&b.compare(n,e,t)?(x=b=null,"triple"):x&&x.compare(n,e,t)?(b=new v(n,e,t),x=null,"double"):(x=new v(n,e,t),b=null,"single")}(C,P):"single";window.focus(),1==P&&M.state.selectingText&&M.state.selectingText(y),C&&function(e,t,n,o,i){let l="Click";return"double"==o?l="Double"+l:"triple"==o&&(l="Triple"+l),l=(1==t?"Left":2==t?"Middle":"Right")+l,h.dispatchKey(e,f.addModifierNames(l,i),i,t=>{if("string"==typeof t&&(t=w.commands[t]),!t)return!1;let o=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),o=t(e,n)!=g.Pass}finally{e.state.suppressEdits=!1}return o})}(M,P,C,T,y)||(1==P?C?function(r,f,h,w){c.ie?setTimeout(g.bind(e.ensureFocus,r),0):r.curOp.focus=d.activeElt();let y,v=function(e,t,n){let o=e.getOption("configureMouse"),i=o?o(e,t,n):{};if(null==i.unit){let e=c.chromeOS?n.shiftKey&&n.metaKey:n.altKey;i.unit=e?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||n.shiftKey),null==i.addNew&&(i.addNew=c.mac?n.metaKey:n.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(c.mac?n.altKey:n.ctrlKey)),i}(r,h,w),x=r.doc.sel;r.options.dragDrop&&m.dragAndDrop&&!r.isReadOnly()&&"single"==h&&(y=x.contains(f))>-1&&(o.cmp((y=x.ranges[y]).from(),f)<0||f.xRel>0)&&(o.cmp(y.to(),f)>0||f.xRel<0)?function(n,o,i,l){let r=n.display,s=!1,a=t.operation(n,e=>{c.webkit&&(r.scroller.draggable=!1),n.state.draggingText=!1,p.off(r.wrapper.ownerDocument,"mouseup",a),p.off(r.wrapper.ownerDocument,"mousemove",d),p.off(r.scroller,"dragstart",m),p.off(r.scroller,"drop",a),s||(p.e_preventDefault(e),l.addNew||u.extendSelection(n.doc,i,null,null,l.extend),c.webkit||c.ie&&9==c.ie_version?setTimeout(()=>{r.wrapper.ownerDocument.body.focus(),r.input.focus()},20):r.input.focus())}),d=function(e){s=s||Math.abs(o.clientX-e.clientX)+Math.abs(o.clientY-e.clientY)>=10},m=()=>s=!0;c.webkit&&(r.scroller.draggable=!0),n.state.draggingText=a,a.copy=!l.moveOnDrag,r.scroller.dragDrop&&r.scroller.dragDrop(),p.on(r.wrapper.ownerDocument,"mouseup",a),p.on(r.wrapper.ownerDocument,"mousemove",d),p.on(r.scroller,"dragstart",m),p.on(r.scroller,"drop",a),e.delayBlurEvent(n),setTimeout(()=>r.input.focus(),20)}(r,w,f,v):function(e,r,c,m){let f=e.display,h=e.doc;p.e_preventDefault(r);let w,y,v=h.sel,x=v.ranges;if(m.addNew&&!m.extend?(y=h.sel.contains(c),w=y>-1?x[y]:new s.Range(c,c)):(w=h.sel.primary(),y=h.sel.primIndex),"rectangle"==m.unit)m.addNew||(w=new s.Range(c,c)),c=l.posFromMouse(e,r,!0,!0),y=-1;else{let t=D(e,c,m.unit);w=m.extend?u.extendRange(w,t.anchor,t.head,m.extend):t}m.addNew?-1==y?(y=x.length,u.setSelection(h,s.normalizeSelection(e,x.concat([w]),y),{scroll:!1,origin:"*mouse"})):x.length>1&&x[y].empty()&&"char"==m.unit&&!m.extend?(u.setSelection(h,s.normalizeSelection(e,x.slice(0,y).concat(x.slice(y+1)),0),{scroll:!1,origin:"*mouse"}),v=h.sel):u.replaceOneSelection(h,y,w,g.sel_mouse):(y=0,u.setSelection(h,new s.Selection([w],0),g.sel_mouse),v=h.sel);let b=c;function M(t){if(0!=o.cmp(b,t))if(b=t,"rectangle"==m.unit){let n=[],l=e.options.tabSize,r=g.countColumn(i.getLine(h,c.line).text,c.ch,l),a=g.countColumn(i.getLine(h,t.line).text,t.ch,l),d=Math.min(r,a),p=Math.max(r,a);for(let r=Math.min(c.line,t.line),u=Math.min(e.lastLine(),Math.max(c.line,t.line));r<=u;r++){let e=i.getLine(h,r).text,t=g.findColumn(e,d,l);d==p?n.push(new s.Range(o.Pos(r,t),o.Pos(r,t))):e.length>t&&n.push(new s.Range(o.Pos(r,t),o.Pos(r,g.findColumn(e,p,l))))}n.length||n.push(new s.Range(c,c)),u.setSelection(h,s.normalizeSelection(e,v.ranges.slice(0,y).concat(n),y),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{let n,l=w,r=D(e,t,m.unit),c=l.anchor;o.cmp(r.anchor,c)>0?(n=r.head,c=o.minPos(l.from(),r.anchor)):(n=r.anchor,c=o.maxPos(l.to(),r.head));let d=v.ranges.slice(0);d[y]=function(e,t){let{anchor:n,head:l}=t,r=i.getLine(e.doc,n.line);if(0==o.cmp(n,l)&&n.sticky==l.sticky)return t;let u=a.getOrder(r);if(!u)return t;let c=a.getBidiPartAt(u,n.ch,n.sticky),d=u[c];if(d.from!=n.ch&&d.to!=n.ch)return t;let p,m=c+(d.from==n.ch==(1!=d.level)?0:1);if(0==m||m==u.length)return t;if(l.line!=n.line)p=(l.line-n.line)*("ltr"==e.doc.direction?1:-1)>0;else{let e=a.getBidiPartAt(u,l.ch,l.sticky),t=e-c||(l.ch-n.ch)*(1==d.level?-1:1);p=e==m-1||e==m?t<0:t>0}let g=u[m+(p?-1:0)],f=p==(1==g.level),h=f?g.from:g.to,w=f?"after":"before";return n.ch==h&&n.sticky==w?t:new s.Range(new o.Pos(n.line,h,w),l)}(e,new s.Range(o.clipPos(h,c),n)),u.setSelection(h,s.normalizeSelection(e,d,y),g.sel_mouse)}}let R=f.wrapper.getBoundingClientRect(),_=0;function C(t){e.state.selectingText=!1,_=1/0,p.e_preventDefault(t),f.input.focus(),p.off(f.wrapper.ownerDocument,"mousemove",P),p.off(f.wrapper.ownerDocument,"mouseup",T),h.history.lastSelOrigin=null}let P=t.operation(e,i=>{0!==i.buttons&&p.e_button(i)?function i(r){let s=++_,u=l.posFromMouse(e,r,!0,"rectangle"==m.unit);if(u)if(0!=o.cmp(u,b)){e.curOp.focus=d.activeElt(),M(u);let o=n.visibleLines(f,h);(u.line>=o.to||u.line<o.from)&&setTimeout(t.operation(e,()=>{_==s&&i(r)}),150)}else{let n=r.clientY<R.top?-20:r.clientY>R.bottom?20:0;n&&setTimeout(t.operation(e,()=>{_==s&&(f.scroller.scrollTop+=n,i(r))}),50)}}(i):C(i)}),T=t.operation(e,C);e.state.selectingText=T,p.on(f.wrapper.ownerDocument,"mousemove",P),p.on(f.wrapper.ownerDocument,"mouseup",T)}(r,w,f,v)}(M,C,T,y):p.e_target(y)==_.scroller&&p.e_preventDefault(y):2==P?(C&&u.extendSelection(M.doc,C),setTimeout(()=>_.input.focus(),20)):3==P&&(c.captureRightClick?M.display.input.onContextMenu(y):e.delayBlurEvent(M)))},clickInGutter:R,onContextMenu:function(e,t){r.eventInWidget(e.display,t)||function(e,t){return!!p.hasHandler(e,"gutterContextMenu")&&M(e,t,"gutterContextMenu",!1)}(e,t)||p.signalDOMEvent(e,t,"contextmenu")||c.captureRightClick||e.display.input.onContextMenu(t)}}});
//# sourceMappingURL=../sourcemaps/edit/mouse_events.js.map
