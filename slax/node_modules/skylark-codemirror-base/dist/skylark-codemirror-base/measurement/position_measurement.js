/**
 * skylark-codemirror-base - A version of codemirror 5.45 core library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror-base/
 * @license MIT
 */
define(["../line/line_data","../line/pos","../line/spans","../line/utils_line","../util/bidi","../util/browser","../util/dom","../util/event","../util/feature_detection","../util/misc","../display/update_line","./widgets"],function(e,t,i,n,r,l,o,a,d,s,c,f){"use strict";function u(e){return e.lineSpace.offsetTop}function h(e){if(e.cachedPaddingH)return e.cachedPaddingH;let t=o.removeChildrenAndAdd(e.measure,o.elt("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,n={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(n.left)||isNaN(n.right)||(e.cachedPaddingH=n),n}function g(e){return s.scrollerGap-e.display.nativeBarWidth}function p(e){return e.display.scroller.clientWidth-g(e)-e.display.barWidth}function m(e,t,i){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(let i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i]};for(let t=0;t<e.rest.length;t++)if(n.lineNo(e.rest[t])>i)return{map:e.measure.maps[t],cache:e.measure.caches[t],before:!0}}function b(e,t,i,n){return w(e,C(e,t),i,n)}function y(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[V(e,t)];let i=e.display.externalMeasured;return i&&t>=i.lineN&&t<i.lineN+i.size?i:void 0}function C(t,r){let l=n.lineNo(r),a=y(t,l);a&&!a.text?a=null:a&&a.changes&&(c.updateLineForChanges(t,a,l,_(t)),t.curOp.forceUpdate=!0),a||(a=function(t,r){r=i.visualLine(r);let l=n.lineNo(r),a=t.display.externalMeasured=new e.LineView(t.doc,r,l);a.lineN=l;let d=a.built=e.buildLineContent(t,a);return a.text=d.pre,o.removeChildrenAndAdd(t.display.lineMeasure,d.pre),a}(t,r));let d=m(a,r,l);return{line:r,view:a,rect:null,map:d.map,cache:d.cache,before:d.before,hasHeights:!1}}function w(e,t,i,n,r){t.before&&(i=-1);let a,c=i+(n||"");return t.cache.hasOwnProperty(c)?a=t.cache[c]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(!function(e,t,i){let n=e.options.lineWrapping,r=n&&p(e);if(!t.measure.heights||n&&t.measure.width!=r){let e=t.measure.heights=[];if(n){t.measure.width=r;let n=t.text.firstChild.getClientRects();for(let t=0;t<n.length-1;t++){let r=n[t],l=n[t+1];Math.abs(r.bottom-l.bottom)>2&&e.push((r.bottom+l.top)/2-i.top)}}e.push(i.bottom-i.top)}}(e,t.view,t.rect),t.hasHeights=!0),(a=function(e,t,i,n){let r,a=L(t.map,i,n),c=a.node,f=a.start,u=a.end,h=a.collapse;if(3==c.nodeType){for(let e=0;e<4;e++){for(;f&&s.isExtendingChar(t.line.text.charAt(a.coverStart+f));)--f;for(;a.coverStart+u<a.coverEnd&&s.isExtendingChar(t.line.text.charAt(a.coverStart+u));)++u;if((r=l.ie&&l.ie_version<9&&0==f&&u==a.coverEnd-a.coverStart?c.parentNode.getBoundingClientRect():H(o.range(c,f,u).getClientRects(),n)).left||r.right||0==f)break;u=f,f-=1,h="right"}l.ie&&l.ie_version<11&&(r=function(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!d.hasBadZoomedRects(e))return t;let i=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*i,right:t.right*i,top:t.top*n,bottom:t.bottom*n}}(e.display.measure,r))}else{let t;f>0&&(h=n="right"),r=e.options.lineWrapping&&(t=c.getClientRects()).length>1?t["right"==n?t.length-1:0]:c.getBoundingClientRect()}if(l.ie&&l.ie_version<9&&!f&&(!r||!r.left&&!r.right)){let t=c.parentNode.getClientRects()[0];r=t?{left:t.left,right:t.left+D(e.display),top:t.top,bottom:t.bottom}:v}let g=r.top-t.rect.top,p=r.bottom-t.rect.top,m=(g+p)/2,b=t.view.measure.heights,y=0;for(;y<b.length-1&&!(m<b[y]);y++);let C=y?b[y-1]:0,w=b[y],x={left:("right"==h?r.right:r.left)-t.rect.left,right:("left"==h?r.left:r.right)-t.rect.left,top:C,bottom:w};r.left||r.right||(x.bogus=!0);e.options.singleCursorHeightPerLine||(x.rtop=g,x.rbottom=p);return x}(e,t,i,n)).bogus||(t.cache[c]=a)),{left:a.left,right:a.right,top:r?a.rtop:a.top,bottom:r?a.rbottom:a.bottom}}let x,v={left:0,right:0,top:0,bottom:0};function L(e,t,i){let n,r,l,o,a,d;for(let s=0;s<e.length;s+=3)if(a=e[s],d=e[s+1],t<a?(r=0,l=1,o="left"):t<d?l=(r=t-a)+1:(s==e.length-3||t==d&&e[s+3]>t)&&(r=(l=d-a)-1,t>=d&&(o="right")),null!=r){if(n=e[s+2],a==d&&i==(n.insertLeft?"left":"right")&&(o=i),"left"==i&&0==r)for(;s&&e[s-2]==e[s-3]&&e[s-1].insertLeft;)n=e[2+(s-=3)],o="left";if("right"==i&&r==d-a)for(;s<e.length-3&&e[s+3]==e[s+4]&&!e[s+5].insertLeft;)n=e[(s+=3)+2],o="right";break}return{node:n,start:r,end:l,collapse:o,coverStart:a,coverEnd:d}}function H(e,t){let i=v;if("left"==t)for(let t=0;t<e.length&&(i=e[t]).left==i.right;t++);else for(let t=e.length-1;t>=0&&(i=e[t]).left==i.right;t--);return i}function P(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(let t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function W(e){e.display.externalMeasure=null,o.removeChildren(e.display.lineMeasure);for(let t=0;t<e.display.view.length;t++)P(e.display.view[t])}function R(){return l.chrome&&l.android?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function S(){return l.chrome&&l.android?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function A(e){let t=0;if(e.widgets)for(let i=0;i<e.widgets.length;++i)e.widgets[i].above&&(t+=f.widgetHeight(e.widgets[i]));return t}function M(e,t,n,r,l){if(!l){let e=A(t);n.top+=e,n.bottom+=e}if("line"==r)return n;r||(r="local");let o=i.heightAtLine(t);if("local"==r?o+=u(e.display):o-=e.display.viewOffset,"page"==r||"window"==r){let t=e.display.lineSpace.getBoundingClientRect();o+=t.top+("window"==r?0:S());let i=t.left+("window"==r?0:R());n.left+=i,n.right+=i}return n.top+=o,n.bottom+=o,n}function B(e,t,i,l,o,a){function d(t,n){let r=w(e,o,t,n?"right":"left",a);return n?r.left=r.right:r.right=r.left,M(e,l,r,i)}l=l||n.getLine(e.doc,t.line),o||(o=C(e,l));let s=r.getOrder(l,e.doc.direction),c=t.ch,f=t.sticky;if(c>=l.text.length?(c=l.text.length,f="before"):c<=0&&(c=0,f="after"),!s)return d("before"==f?c-1:c,"before"==f);function u(e,t,i){let n=1==s[t].level;return d(i?e-1:e,n!=i)}let h=r.getBidiPartAt(s,c,f),g=r.bidiOther,p=u(c,h,"before"==f);return null!=g&&(p.other=u(c,g,"before"!=f)),p}function N(e,i,n,r,l){let o=t.Pos(e,i,n);return o.xRel=l,r&&(o.outside=!0),o}function I(e,t,r){let l=e.doc;if((r+=e.display.viewOffset)<0)return N(l.first,0,null,!0,-1);let o=n.lineAtHeight(l,r),a=l.first+l.size-1;if(o>a)return N(l.first+l.size-1,n.getLine(l,a).text.length,null,!0,1);t<0&&(t=0);let d=n.getLine(l,o);for(;;){let a=O(e,d,o,t,r),s=i.collapsedSpanAround(d,a.ch+(a.xRel>0?1:0));if(!s)return a;let c=s.find(1);if(c.line==o)return c;d=n.getLine(l,o=c.line)}}function T(e,t,i,n){n-=A(t);let r=t.text.length,l=s.findFirst(t=>w(e,i,t-1).bottom<=n,r,0);return{begin:l,end:r=s.findFirst(t=>w(e,i,t).top>n,l,r)}}function F(e,t,i,n){return!(e.bottom<=i)&&(e.top>i||(n?e.left:e.right)>t)}function O(e,n,l,o,a){a-=i.heightAtLine(n);let d=C(e,n),c=A(n),u=0,h=n.text.length,g=!0,p=r.getOrder(n,e.doc.direction);if(p){let i=(e.options.lineWrapping?function(e,t,i,n,r,l,o){let{begin:a,end:d}=T(e,t,n,o);/\s/.test(t.text.charAt(d-1))&&d--;let s=null,c=null;for(let t=0;t<r.length;t++){let i=r[t];if(i.from>=d||i.to<=a)continue;let o=1!=i.level,f=w(e,n,o?Math.min(d,i.to)-1:Math.max(a,i.from)).right,u=f<l?l-f+1e9:f-l;(!s||c>u)&&(s=i,c=u)}s||(s=r[r.length-1]);s.from<a&&(s={from:a,to:s.to,level:s.level});s.to>d&&(s={from:s.from,to:d,level:s.level});return s}:function(e,i,n,r,l,o,a){let d=s.findFirst(d=>{let s=l[d],c=1!=s.level;return F(B(e,t.Pos(n,c?s.to:s.from,c?"before":"after"),"line",i,r),o,a,!0)},0,l.length-1),c=l[d];if(d>0){let s=1!=c.level,f=B(e,t.Pos(n,s?c.from:c.to,s?"after":"before"),"line",i,r);F(f,o,a,!0)&&f.top>a&&(c=l[d-1])}return c})(e,n,l,d,p,o,a);u=(g=1!=i.level)?i.from:i.to-1,h=g?i.to:i.from-1}let m,b,y=null,x=null,v=s.findFirst(t=>{let i=w(e,d,t);return i.top+=c,i.bottom+=c,!!F(i,o,a,!1)&&(i.top<=a&&i.left<=o&&(y=t,x=i),!0)},u,h),L=!1;if(x){let e=o-x.left<x.right-o,t=e==g;v=y+(t?0:1),b=t?"after":"before",m=e?x.left:x.right}else{g||v!=h&&v!=u||v++,b=0==v?"after":v==n.text.length?"before":w(e,d,v-(g?1:0)).bottom+f.widgetHeight<=a==g?"after":"before";let i=B(e,t.Pos(l,v,b),"line",n,d);m=i.left,L=a<i.top||a>=i.bottom}return N(l,v=s.skipExtendingChars(n.text,v,1),b,L,o-m)}function E(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==x){x=o.elt("pre");for(let e=0;e<49;++e)x.appendChild(document.createTextNode("x")),x.appendChild(o.elt("br"));x.appendChild(document.createTextNode("x"))}o.removeChildrenAndAdd(e.measure,x);let t=x.offsetHeight/50;return t>3&&(e.cachedTextHeight=t),o.removeChildren(e.measure),t||1}function D(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;let t=o.elt("span","xxxxxxxxxx"),i=o.elt("pre",[t]);o.removeChildrenAndAdd(e.measure,i);let n=t.getBoundingClientRect(),r=(n.right-n.left)/10;return r>2&&(e.cachedCharWidth=r),r||10}function _(e){let t=e.display,i={},n={},r=t.gutters.clientLeft;for(let l=t.gutters.firstChild,o=0;l;l=l.nextSibling,++o)i[e.options.gutters[o]]=l.offsetLeft+l.clientLeft+r,n[e.options.gutters[o]]=l.clientWidth;return{fixedPos:z(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:i,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function z(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function X(e){let t=E(e.display),n=e.options.lineWrapping,r=n&&Math.max(5,e.display.scroller.clientWidth/D(e.display)-3);return l=>{if(i.lineIsHidden(e.doc,l))return 0;let o=0;if(l.widgets)for(let e=0;e<l.widgets.length;e++)l.widgets[e].height&&(o+=l.widgets[e].height);return n?o+(Math.ceil(l.text.length/r)||1)*t:o+t}}function V(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;let i=e.display.view;for(let e=0;e<i.length;e++)if((t-=i[e].size)<0)return e}return{paddingTop:u,paddingVert:function(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight},paddingH:h,scrollGap:g,displayWidth:p,displayHeight:function(e){return e.display.scroller.clientHeight-g(e)-e.display.barHeight},mapFromLineView:m,measureChar:b,findViewForLine:y,prepareMeasureForLine:C,measureCharPrepared:w,nodeAndOffsetInLineMap:L,clearLineMeasurementCacheFor:P,clearLineMeasurementCache:W,clearCaches:function(e){W(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null},intoCoordSystem:M,fromCoordSystem:function(e,t,i){if("div"==i)return t;let n=t.left,r=t.top;if("page"==i)n-=R(),r-=S();else if("local"==i||!i){let t=e.display.sizer.getBoundingClientRect();n+=t.left,r+=t.top}let l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:r-l.top}},charCoords:function(e,t,i,r,l){return r||(r=n.getLine(e.doc,t.line)),M(e,r,b(e,r,t.ch,l),i)},cursorCoords:B,estimateCoords:function(e,r){let l=0;r=t.clipPos(e.doc,r),e.options.lineWrapping||(l=D(e.display)*r.ch);let o=n.getLine(e.doc,r.line),a=i.heightAtLine(o)+u(e.display);return{left:l,right:l,top:a,bottom:a+o.height}},coordsChar:I,wrappedLineExtentChar:function(e,t,i,n){return i||(i=C(e,t)),T(e,t,i,M(e,t,w(e,i,n),"line").top)},textHeight:E,charWidth:D,getDimensions:_,compensateForHScroll:z,estimateHeight:X,estimateLineHeights:function(e){let t=e.doc,i=X(e);t.iter(e=>{let t=i(e);t!=e.height&&n.updateLineHeight(e,t)})},posFromMouse:function(e,i,r,l){let o=e.display;if(!r&&"true"==a.e_target(i).getAttribute("cm-not-content"))return null;let d,c,f=o.lineSpace.getBoundingClientRect();try{d=i.clientX-f.left,c=i.clientY-f.top}catch(i){return null}let u,g=I(e,d,c);if(l&&1==g.xRel&&(u=n.getLine(e.doc,g.line).text).length==g.ch){let i=s.countColumn(u,u.length,e.options.tabSize)-u.length;g=t.Pos(g.line,Math.max(0,Math.round((d-h(e.display).left)/D(e.display))-i))}return g},findViewIndex:V}});
//# sourceMappingURL=../sourcemaps/measurement/position_measurement.js.map
