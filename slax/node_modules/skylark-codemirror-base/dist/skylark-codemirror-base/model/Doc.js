/**
 * skylark-codemirror-base - A version of codemirror 5.45 core library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror-base/
 * @license MIT
 */
define(["../display/operations","../line/line_data","../line/pos","../line/spans","../line/utils_line","../util/dom","../util/feature_detection","../util/misc","../display/scrolling","./changes","./change_measurement","./chunk","./document_data","./history","./line_widget","./mark_text","./selection","./selection_updates"],function(t,e,i,n,s,r,o,l,h,c,u,a,d,f,p,g,m,y){"use strict";let k=0,S=function(t,n,s,r,o){if(!(this instanceof S))return new S(t,n,s,r,o);null==s&&(s=0),a.BranchChunk.call(this,[new a.LeafChunk([new e.Line("",null)])]),this.first=s,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=s;let h=i.Pos(s,0);this.sel=m.simpleSelection(h),this.history=new f.History(null),this.id=++k,this.modeOption=n,this.lineSep=r,this.direction="rtl"==o?"rtl":"ltr",this.extend=!1,"string"==typeof t&&(t=this.splitLines(t)),d.updateDoc(this,{from:h,to:h,text:t}),y.setSelection(this,m.simpleSelection(h),l.sel_dontScroll)};return S.prototype=l.createObj(a.BranchChunk.prototype,{constructor:S,iter:function(t,e,i){i?this.iterN(t-this.first,e-t,i):this.iterN(this.first,this.first+this.size,t)},insert:function(t,e){let i=0;for(let t=0;t<e.length;++t)i+=e[t].height;this.insertInner(t-this.first,e,i)},remove:function(t,e){this.removeInner(t-this.first,e)},getValue:function(t){let e=s.getLines(this,this.first,this.first+this.size);return!1===t?e:e.join(t||this.lineSeparator())},setValue:t.docMethodOp(function(t){let e=i.Pos(this.first,0),n=this.first+this.size-1;c.makeChange(this,{from:e,to:i.Pos(n,s.getLine(this,n).text.length),text:this.splitLines(t),origin:"setValue",full:!0},!0),this.cm&&h.scrollToCoords(this.cm,0,0),y.setSelection(this,m.simpleSelection(e),l.sel_dontScroll)}),replaceRange:function(t,e,n,s){e=i.clipPos(this,e),n=n?i.clipPos(this,n):e,c.replaceRange(this,t,e,n,s)},getRange:function(t,e,n){let r=s.getBetween(this,i.clipPos(this,t),i.clipPos(this,e));return!1===n?r:r.join(n||this.lineSeparator())},getLine:function(t){let e=this.getLineHandle(t);return e&&e.text},getLineHandle:function(t){if(s.isLine(this,t))return s.getLine(this,t)},getLineNumber:function(t){return s.lineNo(t)},getLineHandleVisualStart:function(t){return"number"==typeof t&&(t=s.getLine(this,t)),n.visualLine(t)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(t){return i.clipPos(this,t)},getCursor:function(t){let e,i=this.sel.primary();return e=null==t||"head"==t?i.head:"anchor"==t?i.anchor:"end"==t||"to"==t||!1===t?i.to():i.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:t.docMethodOp(function(t,e,n){y.setSimpleSelection(this,i.clipPos(this,"number"==typeof t?i.Pos(t,e||0):t),null,n)}),setSelection:t.docMethodOp(function(t,e,n){y.setSimpleSelection(this,i.clipPos(this,t),i.clipPos(this,e||t),n)}),extendSelection:t.docMethodOp(function(t,e,n){y.extendSelection(this,i.clipPos(this,t),e&&i.clipPos(this,e),n)}),extendSelections:t.docMethodOp(function(t,e){y.extendSelections(this,i.clipPosArray(this,t),e)}),extendSelectionsBy:t.docMethodOp(function(t,e){let n=l.map(this.sel.ranges,t);y.extendSelections(this,i.clipPosArray(this,n),e)}),setSelections:t.docMethodOp(function(t,e,n){if(!t.length)return;let s=[];for(let e=0;e<t.length;e++)s[e]=new m.Range(i.clipPos(this,t[e].anchor),i.clipPos(this,t[e].head));null==e&&(e=Math.min(t.length-1,this.sel.primIndex)),y.setSelection(this,m.normalizeSelection(this.cm,s,e),n)}),addSelection:t.docMethodOp(function(t,e,n){let s=this.sel.ranges.slice(0);s.push(new m.Range(i.clipPos(this,t),i.clipPos(this,e||t))),y.setSelection(this,m.normalizeSelection(this.cm,s,s.length-1),n)}),getSelection:function(t){let e,i=this.sel.ranges;for(let t=0;t<i.length;t++){let n=s.getBetween(this,i[t].from(),i[t].to());e=e?e.concat(n):n}return!1===t?e:e.join(t||this.lineSeparator())},getSelections:function(t){let e=[],i=this.sel.ranges;for(let n=0;n<i.length;n++){let r=s.getBetween(this,i[n].from(),i[n].to());!1!==t&&(r=r.join(t||this.lineSeparator())),e[n]=r}return e},replaceSelection:function(t,e,i){let n=[];for(let e=0;e<this.sel.ranges.length;e++)n[e]=t;this.replaceSelections(n,e,i||"+input")},replaceSelections:t.docMethodOp(function(t,e,i){let n=[],s=this.sel;for(let e=0;e<s.ranges.length;e++){let r=s.ranges[e];n[e]={from:r.from(),to:r.to(),text:this.splitLines(t[e]),origin:i}}let r=e&&"end"!=e&&u.computeReplacedSel(this,n,e);for(let t=n.length-1;t>=0;t--)c.makeChange(this,n[t]);r?y.setSelectionReplaceHistory(this,r):this.cm&&h.ensureCursorVisible(this.cm)}),undo:t.docMethodOp(function(){c.makeChangeFromHistory(this,"undo")}),redo:t.docMethodOp(function(){c.makeChangeFromHistory(this,"redo")}),undoSelection:t.docMethodOp(function(){c.makeChangeFromHistory(this,"undo",!0)}),redoSelection:t.docMethodOp(function(){c.makeChangeFromHistory(this,"redo",!0)}),setExtending:function(t){this.extend=t},getExtending:function(){return this.extend},historySize:function(){let t=this.history,e=0,i=0;for(let i=0;i<t.done.length;i++)t.done[i].ranges||++e;for(let e=0;e<t.undone.length;e++)t.undone[e].ranges||++i;return{undo:e,redo:i}},clearHistory:function(){this.history=new f.History(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(t){return t&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(t){return this.history.generation==(t||this.cleanGeneration)},getHistory:function(){return{done:f.copyHistoryArray(this.history.done),undone:f.copyHistoryArray(this.history.undone)}},setHistory:function(t){let e=this.history=new f.History(this.history.maxGeneration);e.done=f.copyHistoryArray(t.done.slice(0),null,!0),e.undone=f.copyHistoryArray(t.undone.slice(0),null,!0)},setGutterMarker:t.docMethodOp(function(t,e,i){return c.changeLine(this,t,"gutter",t=>{let n=t.gutterMarkers||(t.gutterMarkers={});return n[e]=i,!i&&l.isEmpty(n)&&(t.gutterMarkers=null),!0})}),clearGutter:t.docMethodOp(function(t){this.iter(e=>{e.gutterMarkers&&e.gutterMarkers[t]&&c.changeLine(this,e,"gutter",()=>(e.gutterMarkers[t]=null,l.isEmpty(e.gutterMarkers)&&(e.gutterMarkers=null),!0))})}),lineInfo:function(t){let e;if("number"==typeof t){if(!s.isLine(this,t))return null;if(e=t,!(t=s.getLine(this,t)))return null}else if(null==(e=s.lineNo(t)))return null;return{line:e,handle:t,text:t.text,gutterMarkers:t.gutterMarkers,textClass:t.textClass,bgClass:t.bgClass,wrapClass:t.wrapClass,widgets:t.widgets}},addLineClass:t.docMethodOp(function(t,e,i){return c.changeLine(this,t,"gutter"==e?"gutter":"class",t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass";if(t[n]){if(r.classTest(i).test(t[n]))return!1;t[n]+=" "+i}else t[n]=i;return!0})}),removeLineClass:t.docMethodOp(function(t,e,i){return c.changeLine(this,t,"gutter"==e?"gutter":"class",t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass",s=t[n];if(!s)return!1;if(null==i)t[n]=null;else{let e=s.match(r.classTest(i));if(!e)return!1;let o=e.index+e[0].length;t[n]=s.slice(0,e.index)+(e.index&&o!=s.length?" ":"")+s.slice(o)||null}return!0})}),addLineWidget:t.docMethodOp(function(t,e,i){return p.addLineWidget(this,t,e,i)}),removeLineWidget:function(t){t.clear()},markText:function(t,e,n){return g.markText(this,i.clipPos(this,t),i.clipPos(this,e),n,n&&n.type||"range")},setBookmark:function(t,e){let n={replacedWith:e&&(null==e.nodeType?e.widget:e),insertLeft:e&&e.insertLeft,clearWhenEmpty:!1,shared:e&&e.shared,handleMouseEvents:e&&e.handleMouseEvents};return t=i.clipPos(this,t),g.markText(this,t,t,n,"bookmark")},findMarksAt:function(t){t=i.clipPos(this,t);let e=[],n=s.getLine(this,t.line).markedSpans;if(n)for(let i=0;i<n.length;++i){let s=n[i];(null==s.from||s.from<=t.ch)&&(null==s.to||s.to>=t.ch)&&e.push(s.marker.parent||s.marker)}return e},findMarks:function(t,e,n){t=i.clipPos(this,t),e=i.clipPos(this,e);let s=[],r=t.line;return this.iter(t.line,e.line+1,i=>{let o=i.markedSpans;if(o)for(let i=0;i<o.length;i++){let l=o[i];null!=l.to&&r==t.line&&t.ch>=l.to||null==l.from&&r!=t.line||null!=l.from&&r==e.line&&l.from>=e.ch||n&&!n(l.marker)||s.push(l.marker.parent||l.marker)}++r}),s},getAllMarks:function(){let t=[];return this.iter(e=>{let i=e.markedSpans;if(i)for(let e=0;e<i.length;++e)null!=i[e].from&&t.push(i[e].marker)}),t},posFromIndex:function(t){let e,n=this.first,s=this.lineSeparator().length;return this.iter(i=>{let r=i.text.length+s;if(r>t)return e=t,!0;t-=r,++n}),i.clipPos(this,i.Pos(n,e))},indexFromPos:function(t){let e=(t=i.clipPos(this,t)).ch;if(t.line<this.first||t.ch<0)return 0;let n=this.lineSeparator().length;return this.iter(this.first,t.line,t=>{e+=t.text.length+n}),e},copy:function(t){let e=new S(s.getLines(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return e.scrollTop=this.scrollTop,e.scrollLeft=this.scrollLeft,e.sel=this.sel,e.extend=!1,t&&(e.history.undoDepth=this.history.undoDepth,e.setHistory(this.getHistory())),e},linkedDoc:function(t){t||(t={});let e=this.first,i=this.first+this.size;null!=t.from&&t.from>e&&(e=t.from),null!=t.to&&t.to<i&&(i=t.to);let n=new S(s.getLines(this,e,i),t.mode||this.modeOption,e,this.lineSep,this.direction);return t.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:t.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:t.sharedHist}],p.copySharedMarkers(n,p.findSharedMarkers(this)),n},unlinkDoc:function(t){if(t.doc&&(t=t.doc),this.linked)for(let e=0;e<this.linked.length;++e){if(this.linked[e].doc==t){this.linked.splice(e,1),t.unlinkDoc(this),p.detachSharedMarkers(p.findSharedMarkers(this));break}}if(t.history==this.history){let e=[t.id];d.linkedDocs(t,t=>e.push(t.id),!0),t.history=new f.History(null),t.history.done=f.copyHistoryArray(this.history.done,e),t.history.undone=f.copyHistoryArray(this.history.undone,e)}},iterLinkedDocs:function(t){d.linkedDocs(this,t)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(t){return this.lineSep?t.split(this.lineSep):o.splitLinesAuto(t)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:t.docMethodOp(function(t){"rtl"!=t&&(t="ltr"),t!=this.direction&&(this.direction=t,this.iter(t=>t.order=null),this.cm&&d.directionChanged(this.cm))})}),S.prototype.eachLine=S.prototype.iter,S});
//# sourceMappingURL=../sourcemaps/model/Doc.js.map
