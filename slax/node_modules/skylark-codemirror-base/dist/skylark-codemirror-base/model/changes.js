/**
 * skylark-codemirror-base - A version of codemirror 5.45 core library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror-base/
 * @license MIT
 */
define(["../line/highlight","../display/highlight_worker","../display/operations","../display/view_tracking","../line/pos","../line/saw_special_spans","../line/spans","../line/utils_line","../measurement/position_measurement","../util/event","../util/misc","../util/operation_group","./change_measurement","./document_data","./history","./selection","./selection_updates"],function(e,n,t,i,o,r,l,a,s,c,g,h,f,m,u,p,d){"use strict";function x(e,n,t){let i={canceled:!1,from:n.from,to:n.to,text:n.text,origin:n.origin,cancel:()=>i.canceled=!0};return t&&(i.update=((n,t,r,l)=>{n&&(i.from=o.clipPos(e,n)),t&&(i.to=o.clipPos(e,t)),r&&(i.text=r),void 0!==l&&(i.origin=l)})),c.signal(e,"beforeChange",e,i),e.cm&&c.signal(e.cm,"beforeChange",e.cm,i),i.canceled?(e.cm&&(e.cm.curOp.updateInput=2),null):{from:i.from,to:i.to,text:i.text,origin:i.origin}}function C(e,n,i){if(e.cm){if(!e.cm.curOp)return t.operation(e.cm,C)(e,n,i);if(e.cm.state.suppressEdits)return}if((c.hasHandler(e,"beforeChange")||e.cm&&c.hasHandler(e.cm,"beforeChange"))&&!(n=x(e,n,!0)))return;let o=r.sawReadOnlySpans&&!i&&l.removeReadOnlyRanges(e,n.from,n.to);if(o)for(let t=o.length-1;t>=0;--t)y(e,{from:o[t].from,to:o[t].to,text:t?[""]:n.text,origin:n.origin});else y(e,n)}function y(e,n){if(1==n.text.length&&""==n.text[0]&&0==o.cmp(n.from,n.to))return;let t=f.computeSelAfterChange(e,n);u.addChangeToHistory(e,n,t,e.cm?e.cm.curOp.id:NaN),O(e,n,t,l.stretchSpansOverChange(e,n));let i=[];m.linkedDocs(e,(e,t)=>{t||-1!=g.indexOf(i,e.history)||(b(e.history,n),i.push(e.history)),O(e,n,null,l.stretchSpansOverChange(e,n))})}function L(e,n){if(0!=n&&(e.first+=n,e.sel=new p.Selection(g.map(e.sel.ranges,e=>new p.Range(o.Pos(e.anchor.line+n,e.anchor.ch),o.Pos(e.head.line+n,e.head.ch))),e.sel.primIndex),e.cm)){i.regChange(e.cm,e.first,e.first-n,n);for(let n=e.cm.display,t=n.viewFrom;t<n.viewTo;t++)n.regLineChange(e.cm,t,"gutter")}}function O(r,u,p,x){if(r.cm&&!r.cm.curOp)return t.operation(r.cm,O)(r,u,p,x);if(u.to.line<r.first)return void L(r,u.text.length-1-(u.to.line-u.from.line));if(u.from.line>r.lastLine())return;if(u.from.line<r.first){let e=u.text.length-1-(r.first-u.from.line);L(r,e),u={from:o.Pos(r.first,0),to:o.Pos(u.to.line+e,u.to.ch),text:[g.lst(u.text)],origin:u.origin}}let C=r.lastLine();u.to.line>C&&(u={from:u.from,to:o.Pos(C,a.getLine(r,C).text.length),text:[u.text[0]],origin:u.origin}),u.removed=a.getBetween(r,u.from,u.to),p||(p=f.computeSelAfterChange(r,u)),r.cm?function(t,o,r){let g=t.doc,f=t.display,u=o.from,p=o.to,d=!1,x=u.line;t.options.lineWrapping||(x=a.lineNo(l.visualLine(a.getLine(g,u.line))),g.iter(x,p.line+1,e=>{if(e==f.maxLine)return d=!0,!0}));g.sel.contains(o.from,o.to)>-1&&c.signalCursorActivity(t);m.updateDoc(g,o,r,s.estimateHeight(t)),t.options.lineWrapping||(g.iter(x,u.line+o.text.length,e=>{let n=l.lineLength(e);n>f.maxLineLength&&(f.maxLine=e,f.maxLineLength=n,f.maxLineChanged=!0,d=!1)}),d&&(t.curOp.updateMaxLine=!0));e.retreatFrontier(g,u.line),n.startWorker(t,400);let C=o.text.length-(p.line-u.line)-1;o.full?i.regChange(t):u.line!=p.line||1!=o.text.length||m.isWholeLineUpdate(t.doc,o)?i.regChange(t,u.line,p.line+1,C):i.regLineChange(t,u.line,"text");let y=c.hasHandler(t,"changes"),L=c.hasHandler(t,"change");if(L||y){let e={from:u,to:p,text:o.text,removed:o.removed,origin:o.origin};L&&h.signalLater(t,"change",t,e),y&&(t.curOp.changeObjs||(t.curOp.changeObjs=[])).push(e)}t.display.selForContextMenu=null}(r.cm,u,x):m.updateDoc(r,u,x),d.setSelectionNoUndo(r,p,g.sel_dontScroll)}function v(e,n,t,i){t<e.line?e.line+=i:n<e.line&&(e.line=n,e.ch=0)}function S(e,n,t,i){for(let r=0;r<e.length;++r){let l=e[r],a=!0;if(l.ranges){l.copied||((l=e[r]=l.deepCopy()).copied=!0);for(let e=0;e<l.ranges.length;e++)v(l.ranges[e].anchor,n,t,i),v(l.ranges[e].head,n,t,i)}else{for(let e=0;e<l.changes.length;++e){let r=l.changes[e];if(t<r.from.line)r.from=o.Pos(r.from.line+i,r.from.ch),r.to=o.Pos(r.to.line+i,r.to.ch);else if(n<=r.to.line){a=!1;break}}a||(e.splice(0,r+1),r=0)}}}function b(e,n){let t=n.from.line,i=n.to.line,o=n.text.length-(i-t)-1;S(e.done,t,i,o),S(e.undone,t,i,o)}return{makeChange:C,makeChangeFromHistory:function(e,n,t){let i=e.cm&&e.cm.state.suppressEdits;if(i&&!t)return;let o,r=e.history,l=e.sel,a="undo"==n?r.done:r.undone,s="undo"==n?r.undone:r.done,h=0;for(;h<a.length&&(o=a[h],t?!o.ranges||o.equals(e.sel):o.ranges);h++);if(h==a.length)return;for(r.lastOrigin=r.lastSelOrigin=null;;){if(!(o=a.pop()).ranges){if(i)return void a.push(o);break}if(u.pushSelectionToHistory(o,s),t&&!o.equals(e.sel))return void d.setSelection(e,o,{clearRedo:!1});l=o}let p=[];u.pushSelectionToHistory(l,s),s.push({changes:p,generation:r.generation}),r.generation=o.generation||++r.maxGeneration;let C=c.hasHandler(e,"beforeChange")||e.cm&&c.hasHandler(e.cm,"beforeChange");for(let t=o.changes.length-1;t>=0;--t){let i=o.changes[t];if(i.origin=n,C&&!x(e,i,!1))return void(a.length=0);p.push(u.historyChangeFromChange(e,i));let r=t?f.computeSelAfterChange(e,i):g.lst(a);O(e,i,r,u.mergeOldSpans(e,i)),!t&&e.cm&&e.cm.scrollIntoView({from:i.from,to:f.changeEnd(i)});let l=[];m.linkedDocs(e,(e,n)=>{n||-1!=g.indexOf(l,e.history)||(b(e.history,i),l.push(e.history)),O(e,i,null,u.mergeOldSpans(e,i))})}},replaceRange:function(e,n,t,i,r){i||(i=t),o.cmp(i,t)<0&&([t,i]=[i,t]),"string"==typeof n&&(n=e.splitLines(n)),C(e,{from:t,to:i,text:n,origin:r})},changeLine:function(e,n,t,r){let l=n,s=n;return"number"==typeof n?s=a.getLine(e,o.clipLine(e,n)):l=a.lineNo(n),null==l?null:(r(s,l)&&e.cm&&i.regLineChange(e.cm,l,t),s)}}});
//# sourceMappingURL=../sourcemaps/model/changes.js.map
