{"version":3,"sources":["display/selection.js"],"names":["define","m_pos","spans","utils_line","position_measurement","bidi","dom","drawSelectionCursor","cm","head","output","pos","cursorCoords","options","singleCursorHeightPerLine","cursor","appendChild","elt","style","left","top","height","Math","max","bottom","cursorHeight","other","otherCursor","display","cmpCoords","a","b","drawSelectionRange","range","doc","fragment","document","createDocumentFragment","padding","paddingH","leftSide","rightSide","sizerWidth","displayWidth","sizer","offsetLeft","right","docLTR","direction","add","width","round","drawForLine","line","fromArg","toArg","start","end","lineObj","getLine","lineLen","text","length","coords","ch","bias","charCoords","Pos","wrapX","dir","side","extent","wrappedLineExtentChar","prop","begin","test","charAt","order","getOrder","iterateBidiSections","from","to","i","ltr","fromPos","toPos","openStart","openEnd","first","last","openRight","topLeft","topRight","botLeft","botRight","sFrom","sTo","fromLine","toLine","singleVLine","visualLine","leftEnd","rightStart","updateSelection","input","showSelection","prepareSelection","primary","result","curFragment","cursors","selFragment","selection","sel","ranges","primIndex","viewTo","viewFrom","collapsed","empty","showCursorWhenSelecting","restartBlink","state","focused","clearInterval","blinker","on","cursorDiv","visibility","cursorBlinkRate","setInterval"],"mappings":"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","file":"../../display/selection.js","sourcesContent":["define([\n    '../line/pos',\n    '../line/spans',\n    '../line/utils_line',\n    '../measurement/position_measurement',\n    '../util/bidi',\n    '../util/dom'\n], function (m_pos, spans, utils_line, position_measurement, bidi, dom) {\n    'use strict';\n    function updateSelection(cm) {\n        cm.display.input.showSelection(cm.display.input.prepareSelection());\n    }\n    function prepareSelection(cm, primary = true) {\n        let doc = cm.doc, result = {};\n        let curFragment = result.cursors = document.createDocumentFragment();\n        let selFragment = result.selection = document.createDocumentFragment();\n        for (let i = 0; i < doc.sel.ranges.length; i++) {\n            if (!primary && i == doc.sel.primIndex)\n                continue;\n            let range = doc.sel.ranges[i];\n            if (range.from().line >= cm.display.viewTo || range.to().line < cm.display.viewFrom)\n                continue;\n            let collapsed = range.empty();\n            if (collapsed || cm.options.showCursorWhenSelecting)\n                drawSelectionCursor(cm, range.head, curFragment);\n            if (!collapsed)\n                drawSelectionRange(cm, range, selFragment);\n        }\n        return result;\n    }\n    function drawSelectionCursor(cm, head, output) {\n        let pos = position_measurement.cursorCoords(cm, head, 'div', null, null, !cm.options.singleCursorHeightPerLine);\n        let cursor = output.appendChild(dom.elt('div', '\\xA0', 'CodeMirror-cursor'));\n        cursor.style.left = pos.left + 'px';\n        cursor.style.top = pos.top + 'px';\n        cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + 'px';\n        if (pos.other) {\n            let otherCursor = output.appendChild(dom.elt('div', '\\xA0', 'CodeMirror-cursor CodeMirror-secondarycursor'));\n            otherCursor.style.display = '';\n            otherCursor.style.left = pos.other.left + 'px';\n            otherCursor.style.top = pos.other.top + 'px';\n            otherCursor.style.height = (pos.other.bottom - pos.other.top) * 0.85 + 'px';\n        }\n    }\n    function cmpCoords(a, b) {\n        return a.top - b.top || a.left - b.left;\n    }\n    function drawSelectionRange(cm, range, output) {\n        let display = cm.display, doc = cm.doc;\n        let fragment = document.createDocumentFragment();\n        let padding = position_measurement.paddingH(cm.display), leftSide = padding.left;\n        let rightSide = Math.max(display.sizerWidth, position_measurement.displayWidth(cm) - display.sizer.offsetLeft) - padding.right;\n        let docLTR = doc.direction == 'ltr';\n        function add(left, top, width, bottom) {\n            if (top < 0)\n                top = 0;\n            top = Math.round(top);\n            bottom = Math.round(bottom);\n            fragment.appendChild(dom.elt('div', null, 'CodeMirror-selected', `position: absolute; left: ${ left }px;\n                             top: ${ top }px; width: ${ width == null ? rightSide - left : width }px;\n                             height: ${ bottom - top }px`));\n        }\n        function drawForLine(line, fromArg, toArg) {\n            let lineObj = utils_line.getLine(doc, line);\n            let lineLen = lineObj.text.length;\n            let start, end;\n            function coords(ch, bias) {\n                return position_measurement.charCoords(cm, m_pos.Pos(line, ch), 'div', lineObj, bias);\n            }\n            function wrapX(pos, dir, side) {\n                let extent = position_measurement.wrappedLineExtentChar(cm, lineObj, null, pos);\n                let prop = dir == 'ltr' == (side == 'after') ? 'left' : 'right';\n                let ch = side == 'after' ? extent.begin : extent.end - (/\\s/.test(lineObj.text.charAt(extent.end - 1)) ? 2 : 1);\n                return coords(ch, prop)[prop];\n            }\n            let order = bidi.getOrder(lineObj, doc.direction);\n            bidi.iterateBidiSections(order, fromArg || 0, toArg == null ? lineLen : toArg, (from, to, dir, i) => {\n                let ltr = dir == 'ltr';\n                let fromPos = coords(from, ltr ? 'left' : 'right');\n                let toPos = coords(to - 1, ltr ? 'right' : 'left');\n                let openStart = fromArg == null && from == 0, openEnd = toArg == null && to == lineLen;\n                let first = i == 0, last = !order || i == order.length - 1;\n                if (toPos.top - fromPos.top <= 3) {\n                    let openLeft = (docLTR ? openStart : openEnd) && first;\n                    let openRight = (docLTR ? openEnd : openStart) && last;\n                    let left = openLeft ? leftSide : (ltr ? fromPos : toPos).left;\n                    let right = openRight ? rightSide : (ltr ? toPos : fromPos).right;\n                    add(left, fromPos.top, right - left, fromPos.bottom);\n                } else {\n                    let topLeft, topRight, botLeft, botRight;\n                    if (ltr) {\n                        topLeft = docLTR && openStart && first ? leftSide : fromPos.left;\n                        topRight = docLTR ? rightSide : wrapX(from, dir, 'before');\n                        botLeft = docLTR ? leftSide : wrapX(to, dir, 'after');\n                        botRight = docLTR && openEnd && last ? rightSide : toPos.right;\n                    } else {\n                        topLeft = !docLTR ? leftSide : wrapX(from, dir, 'before');\n                        topRight = !docLTR && openStart && first ? rightSide : fromPos.right;\n                        botLeft = !docLTR && openEnd && last ? leftSide : toPos.left;\n                        botRight = !docLTR ? rightSide : wrapX(to, dir, 'after');\n                    }\n                    add(topLeft, fromPos.top, topRight - topLeft, fromPos.bottom);\n                    if (fromPos.bottom < toPos.top)\n                        add(leftSide, fromPos.bottom, null, toPos.top);\n                    add(botLeft, toPos.top, botRight - botLeft, toPos.bottom);\n                }\n                if (!start || cmpCoords(fromPos, start) < 0)\n                    start = fromPos;\n                if (cmpCoords(toPos, start) < 0)\n                    start = toPos;\n                if (!end || cmpCoords(fromPos, end) < 0)\n                    end = fromPos;\n                if (cmpCoords(toPos, end) < 0)\n                    end = toPos;\n            });\n            return {\n                start: start,\n                end: end\n            };\n        }\n        let sFrom = range.from(), sTo = range.to();\n        if (sFrom.line == sTo.line) {\n            drawForLine(sFrom.line, sFrom.ch, sTo.ch);\n        } else {\n            let fromLine = utils_line.getLine(doc, sFrom.line), toLine = utils_line.getLine(doc, sTo.line);\n            let singleVLine = spans.visualLine(fromLine) == spans.visualLine(toLine);\n            let leftEnd = drawForLine(sFrom.line, sFrom.ch, singleVLine ? fromLine.text.length + 1 : null).end;\n            let rightStart = drawForLine(sTo.line, singleVLine ? 0 : null, sTo.ch).start;\n            if (singleVLine) {\n                if (leftEnd.top < rightStart.top - 2) {\n                    add(leftEnd.right, leftEnd.top, null, leftEnd.bottom);\n                    add(leftSide, rightStart.top, rightStart.left, rightStart.bottom);\n                } else {\n                    add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom);\n                }\n            }\n            if (leftEnd.bottom < rightStart.top)\n                add(leftSide, leftEnd.bottom, null, rightStart.top);\n        }\n        output.appendChild(fragment);\n    }\n    function restartBlink(cm) {\n        if (!cm.state.focused)\n            return;\n        let display = cm.display;\n        clearInterval(display.blinker);\n        let on = true;\n        display.cursorDiv.style.visibility = '';\n        if (cm.options.cursorBlinkRate > 0)\n            display.blinker = setInterval(() => display.cursorDiv.style.visibility = (on = !on) ? '' : 'hidden', cm.options.cursorBlinkRate);\n        else if (cm.options.cursorBlinkRate < 0)\n            display.cursorDiv.style.visibility = 'hidden';\n    }\n    return {\n        updateSelection: updateSelection,\n        prepareSelection: prepareSelection,\n        drawSelectionCursor: drawSelectionCursor,\n        restartBlink: restartBlink\n    };\n});"]}