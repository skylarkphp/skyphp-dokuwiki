{"version":3,"sources":["display/update_lines.js"],"names":["define","spans","utils_line","position_measurement","browser","updateWidgetHeight","line","widgets","i","length","w","parent","node","parentNode","height","offsetHeight","updateHeightsInViewport","cm","display","prevBottom","lineDiv","offsetTop","view","cur","wrapping","options","lineWrapping","width","hidden","ie","ie_version","bot","box","getBoundingClientRect","bottom","top","text","firstChild","right","left","diff","updateLineHeight","rest","j","sizerWidth","chWidth","Math","ceil","charWidth","maxLineLength","maxLine","maxLineChanged","visibleLines","doc","viewport","max","scroller","scrollTop","floor","paddingTop","wrapper","clientHeight","from","lineAtHeight","to","ensure","ensureFrom","ensureTo","heightAtLine","getLine","min","lastLine"],"mappings":";;;;;;;AAAAA,QACI,gBACA,qBACA,sCACA,mBACD,SAAUC,EAAOC,EAAYC,EAAsBC,GAClD,aA4CA,SAASC,EAAmBC,GACxB,GAAIA,EAAKC,QACL,IAAK,IAAIC,EAAI,EAAGA,EAAIF,EAAKC,QAAQE,SAAUD,EAAG,CAC1C,IAAIE,EAAIJ,EAAKC,QAAQC,GAAIG,EAASD,EAAEE,KAAKC,WACrCF,IACAD,EAAEI,OAASH,EAAOI,eA2BlC,OACIC,wBAxEJ,SAAiCC,GAC7B,IAAIC,EAAUD,EAAGC,QACbC,EAAaD,EAAQE,QAAQC,UACjC,IAAK,IAAIb,EAAI,EAAGA,EAAIU,EAAQI,KAAKb,OAAQD,IAAK,CAC1C,IACIM,EADAS,EAAML,EAAQI,KAAKd,GAAIgB,EAAWP,EAAGQ,QAAQC,aACrCC,EAAQ,EACpB,GAAIJ,EAAIK,OACJ,SACJ,GAAIxB,EAAQyB,IAAMzB,EAAQ0B,WAAa,EAAG,CACtC,IAAIC,EAAMR,EAAIX,KAAKS,UAAYE,EAAIX,KAAKG,aACxCD,EAASiB,EAAMZ,EACfA,EAAaY,MACV,CACH,IAAIC,EAAMT,EAAIX,KAAKqB,wBACnBnB,EAASkB,EAAIE,OAASF,EAAIG,KACrBX,GAAYD,EAAIa,KAAKC,aACtBV,EAAQJ,EAAIa,KAAKC,WAAWJ,wBAAwBK,MAAQN,EAAIO,KAAO,GAE/E,IAAIC,EAAOjB,EAAIjB,KAAKQ,OAASA,EAC7B,IAAI0B,EAAO,MAASA,GAAQ,QACxBtC,EAAWuC,iBAAiBlB,EAAIjB,KAAMQ,GACtCT,EAAmBkB,EAAIjB,MACnBiB,EAAImB,MACJ,IAAK,IAAIC,EAAI,EAAGA,EAAIpB,EAAImB,KAAKjC,OAAQkC,IACjCtC,EAAmBkB,EAAImB,KAAKC,IAExC,GAAIhB,EAAQV,EAAGC,QAAQ0B,WAAY,CAC/B,IAAIC,EAAUC,KAAKC,KAAKpB,EAAQxB,EAAqB6C,UAAU/B,EAAGC,UAC9D2B,EAAU5B,EAAGC,QAAQ+B,gBACrBhC,EAAGC,QAAQ+B,cAAgBJ,EAC3B5B,EAAGC,QAAQgC,QAAU3B,EAAIjB,KACzBW,EAAGC,QAAQiC,gBAAiB,MA0CxCC,aAtBJ,SAAsBlC,EAASmC,EAAKC,GAChC,IAAInB,EAAMmB,GAA4B,MAAhBA,EAASnB,IAAcW,KAAKS,IAAI,EAAGD,EAASnB,KAAOjB,EAAQsC,SAASC,UAC1FtB,EAAMW,KAAKY,MAAMvB,EAAMhC,EAAqBwD,WAAWzC,IACvD,IAAIgB,EAASoB,GAA+B,MAAnBA,EAASpB,OAAiBoB,EAASpB,OAASC,EAAMjB,EAAQ0C,QAAQC,aACvFC,EAAO5D,EAAW6D,aAAaV,EAAKlB,GAAM6B,EAAK9D,EAAW6D,aAAaV,EAAKnB,GAChF,GAAIoB,GAAYA,EAASW,OAAQ,CAC7B,IAAIC,EAAaZ,EAASW,OAAOH,KAAKxD,KAAM6D,EAAWb,EAASW,OAAOD,GAAG1D,KACtE4D,EAAaJ,GACbA,EAAOI,EACPF,EAAK9D,EAAW6D,aAAaV,EAAKpD,EAAMmE,aAAalE,EAAWmE,QAAQhB,EAAKa,IAAehD,EAAQ0C,QAAQC,eACrGf,KAAKwB,IAAIH,EAAUd,EAAIkB,aAAeP,IAC7CF,EAAO5D,EAAW6D,aAAaV,EAAKpD,EAAMmE,aAAalE,EAAWmE,QAAQhB,EAAKc,IAAajD,EAAQ0C,QAAQC,cAC5GG,EAAKG,GAGb,OACIL,KAAMA,EACNE,GAAIlB,KAAKS,IAAIS,EAAIF,EAAO","file":"../../display/update_lines.js","sourcesContent":["define([\n    '../line/spans',\n    '../line/utils_line',\n    '../measurement/position_measurement',\n    '../util/browser'\n], function (spans, utils_line, position_measurement, browser) {\n    'use strict';\n\n\n    // Read the actual heights of the rendered lines, and update their\n    // stored heights to match.\n    function updateHeightsInViewport(cm) {\n        let display = cm.display;\n        let prevBottom = display.lineDiv.offsetTop;\n        for (let i = 0; i < display.view.length; i++) {\n            let cur = display.view[i], wrapping = cm.options.lineWrapping;\n            let height, width = 0;\n            if (cur.hidden)\n                continue;\n            if (browser.ie && browser.ie_version < 8) {\n                let bot = cur.node.offsetTop + cur.node.offsetHeight;\n                height = bot - prevBottom;\n                prevBottom = bot;\n            } else {\n                let box = cur.node.getBoundingClientRect();\n                height = box.bottom - box.top;\n                if (!wrapping && cur.text.firstChild)\n                    width = cur.text.firstChild.getBoundingClientRect().right - box.left - 1;\n            }\n            let diff = cur.line.height - height;\n            if (diff > 0.005 || diff < -0.005) {\n                utils_line.updateLineHeight(cur.line, height);\n                updateWidgetHeight(cur.line);\n                if (cur.rest)\n                    for (let j = 0; j < cur.rest.length; j++)\n                        updateWidgetHeight(cur.rest[j]);\n            }\n            if (width > cm.display.sizerWidth) {\n                let chWidth = Math.ceil(width / position_measurement.charWidth(cm.display));\n                if (chWidth > cm.display.maxLineLength) {\n                    cm.display.maxLineLength = chWidth;\n                    cm.display.maxLine = cur.line;\n                    cm.display.maxLineChanged = true;\n                }\n            }\n        }\n    }\n\n    // Read and store the height of line widgets associated with the\n    // given line.\n    function updateWidgetHeight(line) {\n        if (line.widgets)\n            for (let i = 0; i < line.widgets.length; ++i) {\n                let w = line.widgets[i], parent = w.node.parentNode;\n                if (parent)\n                    w.height = parent.offsetHeight;\n            }\n    }\n\n    // Compute the lines that are visible in a given viewport (defaults\n    // the the current scroll position). viewport may contain top,\n    // height, and ensure (see op.scrollToPos) properties.\n    function visibleLines(display, doc, viewport) {\n        let top = viewport && viewport.top != null ? Math.max(0, viewport.top) : display.scroller.scrollTop;\n        top = Math.floor(top - position_measurement.paddingTop(display));\n        let bottom = viewport && viewport.bottom != null ? viewport.bottom : top + display.wrapper.clientHeight;\n        let from = utils_line.lineAtHeight(doc, top), to = utils_line.lineAtHeight(doc, bottom);\n        if (viewport && viewport.ensure) {\n            let ensureFrom = viewport.ensure.from.line, ensureTo = viewport.ensure.to.line;\n            if (ensureFrom < from) {\n                from = ensureFrom;\n                to = utils_line.lineAtHeight(doc, spans.heightAtLine(utils_line.getLine(doc, ensureFrom)) + display.wrapper.clientHeight);\n            } else if (Math.min(ensureTo, doc.lastLine()) >= to) {\n                from = utils_line.lineAtHeight(doc, spans.heightAtLine(utils_line.getLine(doc, ensureTo)) - display.wrapper.clientHeight);\n                to = ensureTo;\n            }\n        }\n        return {\n            from: from,\n            to: Math.max(to, from + 1)\n        };\n    }\n    return {\n        updateHeightsInViewport: updateHeightsInViewport,\n        visibleLines: visibleLines\n    };\n});"]}