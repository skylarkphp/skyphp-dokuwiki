{"version":3,"sources":["edit/drop_events.js"],"names":["define","a","b","c","d","e","f","g","h","i","j","k","l","m","lastDrop","clearDragCursor","cm","display","dragCursor","lineSpace","removeChild","onDrop","this","signalDOMEvent","eventInWidget","e_preventDefault","ie","Date","pos","posFromMouse","files","dataTransfer","isReadOnly","length","window","FileReader","File","n","text","Array","read","loadFile","file","options","allowDropFileTypes","indexOf","type","reader","onload","operation","content","result","test","change","from","clipPos","doc","to","splitLines","join","lineSeparator","origin","makeChange","setSelectionReplaceHistory","simpleSelection","changeEnd","readAsText","state","draggingText","sel","contains","setTimeout","input","focus","getData","selected","copy","listSelections","setSelectionNoUndo","replaceRange","anchor","head","replaceSelection","onDragStart","e_stop","setData","getSelection","effectAllowed","setDragImage","safari","img","elt","src","presto","width","height","wrapper","appendChild","_top","offsetTop","parentNode","onDragOver","frag","document","createDocumentFragment","drawSelectionCursor","insertBefore","cursorDiv","removeChildrenAndAdd"],"mappings":"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","file":"../../edit/drop_events.js","sourcesContent":["define([\n    '../display/selection',\n    '../display/operations',\n    '../line/pos',\n    '../measurement/position_measurement',\n    '../measurement/widgets',\n    '../model/changes',\n    '../model/change_measurement',\n    '../model/selection',\n    '../model/selection_updates',\n    '../util/browser',\n    '../util/dom',\n    '../util/event',\n    '../util/misc'\n], function (a, b, c, d, e, f, g, h, i, j, k, l, m) {\n    'use strict';\n    let lastDrop = 0;\n    function onDrop(e) {\n        let cm = this;\n        clearDragCursor(cm);\n        if (l.signalDOMEvent(cm, e) || e.eventInWidget(cm.display, e))\n            return;\n        l.e_preventDefault(e);\n        if (j.ie)\n            lastDrop = +new Date();\n        let pos = d.posFromMouse(cm, e, true), files = e.dataTransfer.files;\n        if (!pos || cm.isReadOnly())\n            return;\n        if (files && files.length && window.FileReader && window.File) {\n            let n = files.length, text = Array(n), read = 0;\n            let loadFile = (file, i) => {\n                if (cm.options.allowDropFileTypes && m.indexOf(cm.options.allowDropFileTypes, file.type) == -1)\n                    return;\n                let reader = new FileReader();\n                reader.onload = b.operation(cm, () => {\n                    let content = reader.result;\n                    if (/[\\x00-\\x08\\x0e-\\x1f]{2}/.test(content))\n                        content = '';\n                    text[i] = content;\n                    if (++read == n) {\n                        pos = c.clipPos(cm.doc, pos);\n                        let change = {\n                            from: pos,\n                            to: pos,\n                            text: cm.doc.splitLines(text.join(cm.doc.lineSeparator())),\n                            origin: 'paste'\n                        };\n                        f.makeChange(cm.doc, change);\n                        i.setSelectionReplaceHistory(cm.doc, h.simpleSelection(pos, g.changeEnd(change)));\n                    }\n                });\n                reader.readAsText(file);\n            };\n            for (let i = 0; i < n; ++i)\n                loadFile(files[i], i);\n        } else {\n            if (cm.state.draggingText && cm.doc.sel.contains(pos) > -1) {\n                cm.state.draggingText(e);\n                setTimeout(() => cm.display.input.focus(), 20);\n                return;\n            }\n            try {\n                let text = e.dataTransfer.getData('Text');\n                if (text) {\n                    let selected;\n                    if (cm.state.draggingText && !cm.state.draggingText.copy)\n                        selected = cm.listSelections();\n                    i.setSelectionNoUndo(cm.doc, h.simpleSelection(pos, pos));\n                    if (selected)\n                        for (let i = 0; i < selected.length; ++i)\n                            f.replaceRange(cm.doc, '', selected[i].anchor, selected[i].head, 'drag');\n                    cm.replaceSelection(text, 'around', 'paste');\n                    cm.display.input.focus();\n                }\n            } catch (e) {\n            }\n        }\n    }\n    function onDragStart(cm, e) {\n        if (j.ie && (!cm.state.draggingText || +new Date() - lastDrop < 100)) {\n            l.e_stop(e);\n            return;\n        }\n        if (l.signalDOMEvent(cm, e) || e.eventInWidget(cm.display, e))\n            return;\n        e.dataTransfer.setData('Text', cm.getSelection());\n        e.dataTransfer.effectAllowed = 'copyMove';\n        if (e.dataTransfer.setDragImage && !j.safari) {\n            let img = k.elt('img', null, null, 'position: fixed; left: 0; top: 0;');\n            img.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';\n            if (j.presto) {\n                img.width = img.height = 1;\n                cm.display.wrapper.appendChild(img);\n                img._top = img.offsetTop;\n            }\n            e.dataTransfer.setDragImage(img, 0, 0);\n            if (j.presto)\n                img.parentNode.removeChild(img);\n        }\n    }\n    function onDragOver(cm, e) {\n        let pos = d.posFromMouse(cm, e);\n        if (!pos)\n            return;\n        let frag = document.createDocumentFragment();\n        a.drawSelectionCursor(cm, pos, frag);\n        if (!cm.display.dragCursor) {\n            cm.display.dragCursor = k.elt('div', null, 'CodeMirror-cursors CodeMirror-dragcursors');\n            cm.display.lineSpace.insertBefore(cm.display.dragCursor, cm.display.cursorDiv);\n        }\n        k.removeChildrenAndAdd(cm.display.dragCursor, frag);\n    }\n    function clearDragCursor(cm) {\n        if (cm.display.dragCursor) {\n            cm.display.lineSpace.removeChild(cm.display.dragCursor);\n            cm.display.dragCursor = null;\n        }\n    }\n    return {\n        onDrop: onDrop,\n        onDragStart: onDragStart,\n        onDragOver: onDragOver,\n        clearDragCursor: clearDragCursor\n    };\n});"]}