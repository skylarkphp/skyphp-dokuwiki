{"version":3,"sources":["edit/key_events.js"],"names":["define","operation_group","selection","keymap","widgets","browser","dom","events","feature_detection","misc","m_commands","doHandleBinding","cm","bound","dropShift","commands","display","input","ensurePolled","prevShift","shift","done","isReadOnly","state","suppressEdits","Pass","stopSeq","Delayed","dispatchKey","name","e","handle","seq","keySeq","isModifierKey","test","set","reset","dispatchKeyInner","result","i","keyMaps","length","lookupKey","options","extraKeys","keyMap","lookupKeyForEditor","signalLater","e_preventDefault","restartBlink","handleKeyBinding","keyName","shiftKey","b","motion","lastStoppedKey","onKeyDown","this","curOp","focus","activeElt","signalDOMEvent","ie","ie_version","keyCode","returnValue","code","handled","presto","hasCopyEvent","mac","metaKey","ctrlKey","replaceSelection","lineDiv","className","up","altKey","rmClass","off","document","addClass","on","showCrossHair","onKeyUp","doc","sel","onKeyPress","eventInWidget","charCode","which","ch","String","fromCharCode","handleCharBinding"],"mappings":"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","file":"../../edit/key_events.js","sourcesContent":["define([\n    '../util/operation_group',\n    '../display/selection',\n    '../input/keymap',\n    '../measurement/widgets',\n    '../util/browser',\n    '../util/dom',\n    '../util/event',\n    '../util/feature_detection',\n    '../util/misc',\n    './commands'\n], function (operation_group, selection, keymap, widgets, browser, dom, events, feature_detection, misc, m_commands) {\n    'use strict';\n    function doHandleBinding(cm, bound, dropShift) {\n        if (typeof bound == 'string') {\n            bound = m_commands.commands[bound];\n            if (!bound)\n                return false;\n        }\n        cm.display.input.ensurePolled();\n        let prevShift = cm.display.shift, done = false;\n        try {\n            if (cm.isReadOnly())\n                cm.state.suppressEdits = true;\n            if (dropShift)\n                cm.display.shift = false;\n            done = bound(cm) != misc.Pass;\n        } finally {\n            cm.display.shift = prevShift;\n            cm.state.suppressEdits = false;\n        }\n        return done;\n    }\n    function lookupKeyForEditor(cm, name, handle) {\n        for (let i = 0; i < cm.state.keyMaps.length; i++) {\n            let result = keymap.lookupKey(name, cm.state.keyMaps[i], handle, cm);\n            if (result)\n                return result;\n        }\n        return cm.options.extraKeys && keymap.lookupKey(name, cm.options.extraKeys, handle, cm) || keymap.lookupKey(name, cm.options.keyMap, handle, cm);\n    }\n    let stopSeq = new misc.Delayed();\n    function dispatchKey(cm, name, e, handle) {\n        let seq = cm.state.keySeq;\n        if (seq) {\n            if (keymap.isModifierKey(name))\n                return 'handled';\n            if (/\\'$/.test(name))\n                cm.state.keySeq = null;\n            else\n                stopSeq.set(50, () => {\n                    if (cm.state.keySeq == seq) {\n                        cm.state.keySeq = null;\n                        cm.display.input.reset();\n                    }\n                });\n            if (dispatchKeyInner(cm, seq + ' ' + name, e, handle))\n                return true;\n        }\n        return dispatchKeyInner(cm, name, e, handle);\n    }\n    function dispatchKeyInner(cm, name, e, handle) {\n        let result = lookupKeyForEditor(cm, name, handle);\n        if (result == 'multi')\n            cm.state.keySeq = name;\n        if (result == 'handled')\n            operation_group.signalLater(cm, 'keyHandled', cm, name, e);\n        if (result == 'handled' || result == 'multi') {\n            events.e_preventDefault(e);\n            selection.restartBlink(cm);\n        }\n        return !!result;\n    }\n    function handleKeyBinding(cm, e) {\n        let name = keymap.keyName(e, true);\n        if (!name)\n            return false;\n        if (e.shiftKey && !cm.state.keySeq) {\n            return dispatchKey(cm, 'Shift-' + name, e, b => doHandleBinding(cm, b, true)) || dispatchKey(cm, name, e, b => {\n                if (typeof b == 'string' ? /^go[A-Z]/.test(b) : b.motion)\n                    return doHandleBinding(cm, b);\n            });\n        } else {\n            return dispatchKey(cm, name, e, b => doHandleBinding(cm, b));\n        }\n    }\n    function handleCharBinding(cm, e, ch) {\n        return dispatchKey(cm, \"'\" + ch + \"'\", e, b => doHandleBinding(cm, b, true));\n    }\n    let lastStoppedKey = null;\n    function onKeyDown(e) {\n        let cm = this;\n        cm.curOp.focus = dom.activeElt();\n        if (events.signalDOMEvent(cm, e))\n            return;\n        if (browser.ie && browser.ie_version < 11 && e.keyCode == 27)\n            e.returnValue = false;\n        let code = e.keyCode;\n        cm.display.shift = code == 16 || e.shiftKey;\n        let handled = handleKeyBinding(cm, e);\n        if (browser.presto) {\n            lastStoppedKey = handled ? code : null;\n            if (!handled && code == 88 && !feature_detection.hasCopyEvent && (browser.mac ? e.metaKey : e.ctrlKey))\n                cm.replaceSelection('', null, 'cut');\n        }\n        if (code == 18 && !/\\bCodeMirror-crosshair\\b/.test(cm.display.lineDiv.className))\n            showCrossHair(cm);\n    }\n    function showCrossHair(cm) {\n        let lineDiv = cm.display.lineDiv;\n        dom.addClass(lineDiv, 'CodeMirror-crosshair');\n        function up(e) {\n            if (e.keyCode == 18 || !e.altKey) {\n                dom.rmClass(lineDiv, 'CodeMirror-crosshair');\n                events.off(document, 'keyup', up);\n                events.off(document, 'mouseover', up);\n            }\n        }\n        events.on(document, 'keyup', up);\n        events.on(document, 'mouseover', up);\n    }\n    function onKeyUp(e) {\n        if (e.keyCode == 16)\n            this.doc.sel.shift = false;\n        events.signalDOMEvent(this, e);\n    }\n    function onKeyPress(e) {\n        let cm = this;\n        if (widgets.eventInWidget(cm.display, e) || events.signalDOMEvent(cm, e) || e.ctrlKey && !e.altKey || browser.mac && e.metaKey)\n            return;\n        let keyCode = e.keyCode, charCode = e.charCode;\n        if (browser.presto && keyCode == lastStoppedKey) {\n            lastStoppedKey = null;\n            events.e_preventDefault(e);\n            return;\n        }\n        if (browser.presto && (!e.which || e.which < 10) && handleKeyBinding(cm, e))\n            return;\n        let ch = String.fromCharCode(charCode == null ? keyCode : charCode);\n        if (ch == '\\b')\n            return;\n        if (handleCharBinding(cm, e, ch))\n            return;\n        cm.display.input.onKeyPress(e);\n    }\n    return {\n        dispatchKey: dispatchKey,\n        onKeyDown: onKeyDown,\n        onKeyUp: onKeyUp,\n        onKeyPress: onKeyPress\n    };\n});"]}