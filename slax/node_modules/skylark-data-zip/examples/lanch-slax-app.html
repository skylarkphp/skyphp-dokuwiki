<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Create .zip files using JavaScript. Provides a simple API to place any content generated by JavaScript into a .zip file for your users." />
    <title>Reading a local file with the File API</title>

    <!--
    Any version of jQuery will do (it's just to write some examples), this one
    happens to be available in our tests.
    -->
    <script type="text/javascript" src="http://registry.skylarkjs.org/packages/skylark-utils/v0.9.3-beta/uncompressed/skylark-utils-all.js"></script>
    <script type="text/javascript" src="http://registry.skylarkjs.org/packages/skylark-jquery/v0.9.3/uncompressed/skylark-jquery.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="./css/pygments.css">
    <link rel="stylesheet" href="./css/main.css">

    <script type="text/javascript" src="../dist/uncompressed/skylark-data-zip.js"></script>

<!--
    <script type="text/javascript" src="//stuk.github.io/jszip-utils/dist/jszip-utils.js"></script>
    <script type="text/javascript" src="/jszip/vendor/FileSaver.js"></script>
-->
    <!--
    Mandatory in IE 6, 7, 8 and 9.
    -->
    <!--[if IE]>
    <script type="text/javascript" src="//stuk.github.io/jszip-utils/dist/jszip-utils-ie.js"></script>
    <![endif]-->


  </head>
  <body>
    <div class="container">
      <div class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <a class="navbar-brand" href="javascript:void(0)"><strong>skylark-data-zip</strong></a>
          </div>
          <ul class="nav navbar-nav">
            <li >
            </li>
            <li class="active">
            </li>
            <li >
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="https://github.com/skylarkjs/skylark-data-zip">skylark-data-zip on Github</a>
            </li>
          </ul>
        </div>
      </div>
      
      <div class="row">
        <nav class="col-md-3">
          <h4>Examples</h4>
          <ul class="nav">
                <li><a href="./read-local-file-api.html">Read local file</a></li>
                <li><a href="./get-binary-files-ajax.html">Read remote file</a></li>
                <li><a href="./download-zip-file.html">Give the user its zip file</a></li>
                <li><a href="./downloader.html">Mini app : downloader</a></li>
          </ul>
        </nav>
        
        <div class="col-md-9">
          <h1>Reading a local file with the File API</h1>
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
              <a href="#load-result" aria-controls="load-result" role="tab" data-toggle="tab">result</a>
            </li>
          </ul>
          <div class="tab-content">
              <div role="tabpanel" class="tab-pane active" id="load-result">
                  <div class="show-example">
                      <h3>Choose the local(s) zip file(s)</h3>
                      <p class="note">Note : your browser will process the zip file, don't choose a file too big !</p>
                      <input type="file" id="file" name="file" multiple /><br />

                      <div id="result_block" class="hidden">
                        <h3>Content :</h3>
                        <div id="result"></div>
                        <iframe id="app" style="width:100%;height:500px"></iframe>
                      </div>
                  </div>
              </div>
          <div id="error_block" class="alert alert-danger hidden">
            You will need a recent browser to use this demo :(
          </div>
          <script type="text/javascript">
          (function () {
            if (!window.FileReader || !window.ArrayBuffer) {
              $("#error_block").removeClass("hidden").addClass("show");
              return;
            }

          var $result = $("#result");

          var lfs;
          skylarkjs.storages.localfs.request(1024*1024*10,true).then(function(fs){
              lfs = fs;
          });

          $("#file").on("change", function(evt) {
              // remove content
              $result.html("");
              // be sure to show the results
              $("#result_block").removeClass("hidden").addClass("show");


              // Closure to capture the file information.
              function handleFile(f) {
                  var $title = $("<h4>", {
                      innerHtml : f.name
                  });
                  var $fileContent = $("<ul>");
                  $result.append($title);
                  $result.append($fileContent);

                  var dateBefore = new Date();
                  skylarkjs.zip(f) .then(function(zip) {
                      var dateAfter = new Date();
                      $title.append($("<span>", {
                          "class": "small",
                      }).text(" (loaded in " + (dateAfter - dateBefore) + "ms)"));

                      var defers = [];
                      zip.forEach(function (relativePath, zipEntry) {  // 2) print entries
                          $fileContent.append($("<li>").text(zipEntry.name));
                          var d = new skylarkjs.langx.Deferred();
                          zipEntry.async("arraybuffer").then(function(data){
                            if (!zipEntry.dir) {
                              lfs.writefile(zipEntry.name,new Blob([data], {type: "application/octet-binary"}),function(r){
                                d.resolve();
                              }, function(e){
                                d.reject(e);
                              });
                            } else {
                              d.resolve();
                            }
                          });
                          defers.push(d.promise);
                      });
                      skylarkjs.langx.Deferred.all(defers).then(function(){
                        $("#app").prop("src",lfs._cwd.toURL()+"index.html");
                      },function(e){
                        console.log(e);
                      });
                  }, function (e) {
                      $result.append($("<div>", {
                          "class" : "alert alert-danger",
                      }).text("Error reading " + f.name + ": " + e.message));
                  });
                  
              }

              var files = evt.target.files;
              handleFile(files[0]);
          });



          })();
          </script>
        </div>
      </div>
    </div>

  </body>
</html>
