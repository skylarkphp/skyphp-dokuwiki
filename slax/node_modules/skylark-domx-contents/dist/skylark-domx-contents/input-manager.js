/**
 * skylark-domx-contents - A dom plugin for  editing  the content of html element.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query","./contents"],function(t,e,i){var n=[].indexOf,o=t.Evented.inherit({init:function(i,n){var o,r,l;this.editable=i,this.opts=t.extend({},this.opts,n),this.throttledValueChanged=this.editable.util.throttle((l=this,function(t){return setTimeout(function(){return l.editable.trigger("valuechanged",t)},10)}),300),this.throttledSelectionChanged=this.editable.util.throttle(function(t){return function(){return t.editable.trigger("selectionchanged")}}(this),50),e(document).on("selectionchange.simditor"+this.editable.id,function(t){return function(e){var i;if(t.focused&&!t.editable.clipboard.pasting)return(i=function(){return t._selectionTimer&&(clearTimeout(t._selectionTimer),t._selectionTimer=null),t.editable.selection._selection.rangeCount>0?t.throttledSelectionChanged():t._selectionTimer=setTimeout(function(){if(t._selectionTimer=null,t.focused)return i()},10)})()}}(this)),this.editable.on("valuechanged",function(t){return function(){var i;if(t.lastCaretPosition=null,i=t.editable.body.children().filter(function(e,i){return t.editable.util.isBlockNode(i)}),t.focused&&0===i.length&&(t.editable.selection.save(),t.editable.formatter.format(),t.editable.selection.restore()),t.editable.body.find("hr, pre, ."+t.opts.classPrefix+"table").each(function(i,n){var o,r;if(((o=e(n)).parent().is("blockquote")||o.parent()[0]===t.editable.body[0])&&(r=!1,0===o.next().length&&(e("<p/>").append(t.editable.util.phBr).insertAfter(o),r=!0),0===o.prev().length&&(e("<p/>").append(t.editable.util.phBr).insertBefore(o),r=!0),r))return t.throttledValueChanged()}),t.editable.body.find("pre:empty").append(t.editable.util.phBr),!t.editable.util.support.onselectionchange&&t.focused)return t.throttledSelectionChanged()}}(this)),this.editable.body.on("keydown",t.proxy(this._onKeyDown,this)).on("keypress",t.proxy(this._onKeyPress,this)).on("keyup",t.proxy(this._onKeyUp,this)).on("mouseup",t.proxy(this._onMouseUp,this)).on("focus",t.proxy(this._onFocus,this)).on("blur",t.proxy(this._onBlur,this)).on("drop",t.proxy(this._onDrop,this)).on("input",t.proxy(this._onInput,this)),this.editable.util.browser.firefox&&(this.editable.hotkeys.add("cmd+left",function(t){return function(e){return e.preventDefault(),t.editable.selection._selection.modify("move","backward","lineboundary"),!1}}(this)),this.editable.hotkeys.add("cmd+right",function(t){return function(e){return e.preventDefault(),t.editable.selection._selection.modify("move","forward","lineboundary"),!1}}(this)),o=this.editable.util.os.mac?"cmd+a":"ctrl+a",this.editable.hotkeys.add(o,function(t){return function(e){var i,n,o,r;if((i=t.editable.body.children()).length>0)return n=i.first().get(0),o=i.last().get(0),(r=document.createRange()).setStart(n,0),r.setEnd(o,t.editable.util.getNodeLength(o)),t.editable.selection.range(r),!1}}(this))),r=this.editable.util.os.mac?"cmd+enter":"ctrl+enter",this.editable.hotkeys.add(r,function(t){return function(e){return t.editable.$el.closest("form").find("button:submit").click(),!1}}(this))}});return o.pluginName="InputManager",o.prototype._modifierKeys=[16,17,18,91,93,224],o.prototype._arrowKeys=[37,38,39,40],o.prototype._onFocus=function(t){var e;if(!this.editable.clipboard.pasting)return this.editable.$el.addClass("focus").removeClass("error"),this.focused=!0,setTimeout((e=this,function(){var t,i;if((i=e.editable.selection._selection.getRangeAt(0)).startContainer===e.editable.body[0]&&(e.lastCaretPosition?e.editable.undoManager.caretPosition(e.lastCaretPosition):(t=e.editable.body.children().first(),i=document.createRange(),e.editable.selection.setRangeAtStartOf(t,i),console.log("aaaaaa"))),e.lastCaretPosition=null,e.editable.trigger("focus"),!e.editable.util.support.onselectionchange)return e.throttledSelectionChanged()}),0)},o.prototype._onBlur=function(t){var e;if(!this.editable.clipboard.pasting)return this.editable.$el.removeClass("focus"),this.editable.sync(),this.focused=!1,this.lastCaretPosition=null!=(e=this.editable.undoManager.currentState())?e.caret:void 0,this.editable.trigger("blur")},o.prototype._onMouseUp=function(t){if(!this.editable.util.support.onselectionchange)return this.throttledSelectionChanged()},o.prototype._onKeyDown=function(t){var e,i;if(!1===this.editable.trigger(t))return!1;if(!this.editable.hotkeys.respondTo(t)){if(this.editable.keystroke.respondTo(t))return this.throttledValueChanged(),!1;if(!(e=t.which,n.call(this._modifierKeys,e)>=0||(i=t.which,n.call(this._arrowKeys,i)>=0)||this.editable.util.metaKey(t)&&86===t.which))return this.editable.util.support.oninput||this.throttledValueChanged(["typing"]),null}},o.prototype._onKeyPress=function(t){if(!1===this.editable.trigger(t))return!1},o.prototype._onKeyUp=function(t){var i,o;if(!1===this.editable.trigger(t))return!1;!this.editable.util.support.onselectionchange&&(o=t.which,n.call(this._arrowKeys,o)>=0)?this.throttledValueChanged():8!==t.which&&46!==t.which||!this.editable.util.isEmptyNode(this.editable.body)||(this.editable.body.empty(),i=e("<p/>").append(this.editable.util.phBr).appendTo(this.editable.body),this.editable.selection.setRangeAtStartOf(i))},o.prototype._onDrop=function(t){return!1!==this.editable.trigger(t)&&this.throttledValueChanged()},o.prototype._onInput=function(t){return this.throttledValueChanged(["oninput"])},i.InputManager=o});
//# sourceMappingURL=sourcemaps/input-manager.js.map
