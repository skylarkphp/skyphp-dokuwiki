{"version":3,"sources":["formatter.js"],"names":["define","langx","$","contents","indexOf","Formatter","Evented","inherit","opts","allowedTags","allowedAttributes","allowedStyles","init","editable","this","extend","_allowedTags","merge","_allowedAttributes","img","a","font","code","_allowedStyles","span","b","i","strong","strike","u","p","h1","h2","h3","h4","body","on","e","decorate","$el","trigger","undecorate","clone","autolink","$link","$node","findLinkNode","k","lastIndex","len","linkNodes","match","re","replaceEls","subStr","text","uri","$parentNode","each","node","is","closest","length","test","push","exec","substring","index","document","createTextNode","replaceWith","format","blockNode","l","len1","n","ref","ref1","append","cleanNode","remove","util","isBlockNode","insertBefore","isEmptyNode","phBr","recursive","$blockEls","$childImg","$p","$td","attr","isDecoration","textNode","nodeType","isDecoratedNode","join","find","blockNodes","blockEl","unwrap","hasClass","tagName","toLowerCase","makeArray","attributes","name","call","removeAttr","_cleanNodeStyles","first","style","color","fontSize","tr","replace","pair","styleStr","styles","split","trim","parseInt","Object","keys","css","clearHtml","html","lineBreak","container","result","_this","children","nodeValue","beautify","$contents","uselessP","el","classPrefix","pluginName"],"mappings":"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","file":"../formatter.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"./contents\"\r\n],function(langx,$,contents){ \r\n\r\n\r\n  var indexOf = [].indexOf ;\r\n\r\n  var Formatter = langx.Evented.inherit({\r\n    opts : {\r\n      allowedTags: [],\r\n      allowedAttributes: {},\r\n      allowedStyles: {}\r\n    },\r\n\r\n    init : function(editable,opts) {\r\n      this.editable = editable; //this._module;\r\n      this.opts = langx.extend({}, this.opts, opts);\r\n\r\n      this._allowedTags = langx.merge(['br', 'span', 'a', 'img', 'b', 'strong', 'i', 'strike', 'u', 'font', 'p', 'ul', 'ol', 'li', 'blockquote', 'pre', 'code', 'h1', 'h2', 'h3', 'h4', 'hr'], this.opts.allowedTags);\r\n      this._allowedAttributes = langx.extend({\r\n        img: ['src', 'alt', 'width', 'height', 'data-non-image'],\r\n        a: ['href', 'target','download'],\r\n        font: ['color'],\r\n        code: ['class']\r\n      }, this.opts.allowedAttributes);\r\n      this._allowedStyles = langx.extend({\r\n        span: ['color', 'font-size','background-color','background'],\r\n        b: ['color', 'font-size','background-color','background'],\r\n        i: ['color', 'font-size','background-color','background'],\r\n        strong: ['color', 'font-size','background-color','background'],\r\n        strike: ['color', 'font-size','background-color','background'],\r\n        u: ['color', 'font-size','background-color','background'],\r\n        p: ['margin-left', 'text-align','background-color','background'],\r\n        h1: ['margin-left', 'text-align'],\r\n        h2: ['margin-left', 'text-align'],\r\n        h3: ['margin-left', 'text-align'],\r\n        h4: ['margin-left', 'text-align']\r\n      }, this.opts.allowedStyles);\r\n      this.editable.body.on('click', 'a', function(e) {\r\n        return false;\r\n      });\r\n    },\r\n\r\n    decorate : function($el) {\r\n      if ($el == null) {\r\n        $el = this.editable.body;\r\n      }\r\n      this.editable.trigger('decorate', [$el]);\r\n      return $el;\r\n    },\r\n\r\n    undecorate : function($el) {\r\n      if ($el == null) {\r\n        $el = this.editable.body.clone();\r\n      }\r\n      this.editable.trigger('undecorate', [$el]);\r\n      return $el;\r\n    },\r\n\r\n    autolink : function($el) {\r\n      var $link, $node, findLinkNode, k, lastIndex, len, linkNodes, match, re, replaceEls, subStr, text, uri;\r\n      if ($el == null) {\r\n        $el = this.editable.body;\r\n      }\r\n      linkNodes = [];\r\n      findLinkNode = function($parentNode) {\r\n        return $parentNode.contents().each(function(i, node) {\r\n          var $node, text;\r\n          $node = $(node);\r\n          if ($node.is('a') || $node.closest('a, pre', $el).length) {\r\n            return;\r\n          }\r\n          if (!$node.is('iframe') && $node.contents().length) {\r\n            return findLinkNode($node);\r\n          } else if ((text = $node.text()) && /https?:\\/\\/|www\\./ig.test(text)) {\r\n            return linkNodes.push($node);\r\n          }\r\n        });\r\n      };\r\n      findLinkNode($el);\r\n      re = /(https?:\\/\\/|www\\.)[\\w\\-\\.\\?&=\\/#%:,@\\!\\+]+/ig;\r\n      for (k = 0, len = linkNodes.length; k < len; k++) {\r\n        $node = linkNodes[k];\r\n        text = $node.text();\r\n        replaceEls = [];\r\n        match = null;\r\n        lastIndex = 0;\r\n        while ((match = re.exec(text)) !== null) {\r\n          subStr = text.substring(lastIndex, match.index);\r\n          replaceEls.push(document.createTextNode(subStr));\r\n          lastIndex = re.lastIndex;\r\n          uri = /^(http(s)?:\\/\\/|\\/)/.test(match[0]) ? match[0] : 'http://' + match[0];\r\n          $link = $(\"<a href=\\\"\" + uri + \"\\\" rel=\\\"nofollow\\\"></a>\").text(match[0]);\r\n          replaceEls.push($link[0]);\r\n        }\r\n        replaceEls.push(document.createTextNode(text.substring(lastIndex)));\r\n        $node.replaceWith($(replaceEls));\r\n      }\r\n      return $el;\r\n    },\r\n\r\n    format : function($el) {\r\n      var $node, blockNode, k, l, len, len1, n, node, ref, ref1;\r\n      if ($el == null) {\r\n        $el = this.editable.body;\r\n      }\r\n      if ($el.is(':empty')) {\r\n        //$el.append('<p>' + this.editable.util.phBr + '</p>'); // modified by lwf\r\n        $el.append('<p>' + '</p>'); // modified by lwf\r\n        return $el;\r\n      }\r\n      ref = $el.contents();\r\n      for (k = 0, len = ref.length; k < len; k++) {\r\n        n = ref[k];\r\n        this.cleanNode(n, true);\r\n      }\r\n      ref1 = $el.contents();\r\n      for (l = 0, len1 = ref1.length; l < len1; l++) {\r\n        node = ref1[l];\r\n        $node = $(node);\r\n        if ($node.is('br')) {\r\n          if (typeof blockNode !== \"undefined\" && blockNode !== null) {\r\n            blockNode = null;\r\n          }\r\n          $node.remove();\r\n        } else if (this.editable.util.isBlockNode(node)) {\r\n          if ($node.is('li')) {\r\n            if (blockNode && blockNode.is('ul, ol')) {\r\n              blockNode.append(node);\r\n            } else {\r\n              blockNode = $('<ul/>').insertBefore(node);\r\n              blockNode.append(node);\r\n            }\r\n          } else {\r\n            blockNode = null;\r\n          }\r\n        } else {\r\n          if (!blockNode || blockNode.is('ul, ol')) {\r\n            blockNode = $('<p/>').insertBefore(node);\r\n          }\r\n          blockNode.append(node);\r\n          if (this.editable.util.isEmptyNode(blockNode)) {\r\n            blockNode.append(this.editable.util.phBr);\r\n          }\r\n        }\r\n      }\r\n      return $el;\r\n    },\r\n\r\n    cleanNode : function(node, recursive) {\r\n      var $blockEls, $childImg, $node, $p, $td, allowedAttributes, attr, contents, isDecoration, k, l, len, len1, n, ref, ref1, text, textNode;\r\n      $node = $(node);\r\n      if (!($node.length > 0)) {\r\n        return;\r\n      }\r\n      if ($node[0].nodeType === 3) {\r\n        text = $node.text().replace(/(\\r\\n|\\n|\\r)/gm, '');\r\n        if (text) {\r\n          textNode = document.createTextNode(text);\r\n          $node.replaceWith(textNode);\r\n        } else {\r\n          $node.remove();\r\n        }\r\n        return;\r\n      }\r\n      contents = $node.is('iframe') ? null : $node.contents();\r\n      isDecoration = this.editable.util.isDecoratedNode($node);\r\n      if ($node.is(this._allowedTags.join(',')) || isDecoration) {\r\n        if ($node.is('a') && ($childImg = $node.find('img')).length > 0) {\r\n          $node.replaceWith($childImg);\r\n          $node = $childImg;\r\n          contents = null;\r\n        }\r\n        if ($node.is('td') && ($blockEls = $node.find(this.editable.util.blockNodes.join(','))).length > 0) {\r\n          $blockEls.each((function(_this) {\r\n            return function(i, blockEl) {\r\n              return $(blockEl).contents().unwrap();\r\n            };\r\n          })(this));\r\n          contents = $node.contents();\r\n        }\r\n        if ($node.is('img') && $node.hasClass('uploading')) {\r\n          $node.remove();\r\n        }\r\n        if (!isDecoration) {\r\n          allowedAttributes = this._allowedAttributes[$node[0].tagName.toLowerCase()];\r\n          ref = langx.makeArray($node[0].attributes);\r\n          for (k = 0, len = ref.length; k < len; k++) {\r\n            attr = ref[k];\r\n            if (attr.name === 'style') {\r\n              continue;\r\n            }\r\n            if (!((allowedAttributes != null) && (ref1 = attr.name, indexOf.call(allowedAttributes, ref1) >= 0))) {\r\n              $node.removeAttr(attr.name);\r\n            }\r\n          }\r\n          this._cleanNodeStyles($node);\r\n          if ($node.is('span')) {\r\n            if ($node[0].attributes.length === 0) {\r\n              $node.contents().first().unwrap();\r\n            }\r\n            if ($node[0].style.length === 2 && $node[0].style.color === 'rgb(51, 51, 51)' && $node[0].style.fontSize === '16px') {\r\n              $node.contents().unwrap();\r\n            }\r\n          }\r\n        }\r\n      } else if ($node[0].nodeType === 1 && !$node.is(':empty')) {\r\n        if ($node.is('div, article, dl, header, footer, tr')) {\r\n          $node.append('<br/>');\r\n          contents.first().unwrap();\r\n        } else if ($node.is('table')) {\r\n          $p = $('<p/>');\r\n          $node.find('tr').each(function(i, tr) {\r\n            return $p.append($(tr).text() + '<br/>');\r\n          });\r\n          $node.replaceWith($p);\r\n          contents = null;\r\n        } else if ($node.is('thead, tfoot')) {\r\n          $node.remove();\r\n          contents = null;\r\n        } else if ($node.is('th')) {\r\n          $td = $('<td/>').append($node.contents());\r\n          $node.replaceWith($td);\r\n        } else {\r\n          contents.first().unwrap();\r\n        }\r\n      } else {\r\n        $node.remove();\r\n        contents = null;\r\n      }\r\n      if (recursive && (contents != null) && !$node.is('pre')) {\r\n        for (l = 0, len1 = contents.length; l < len1; l++) {\r\n          n = contents[l];\r\n          this.cleanNode(n, true);\r\n        }\r\n      }\r\n      return null;\r\n    },\r\n\r\n    _cleanNodeStyles : function($node) {\r\n      var allowedStyles, k, len, pair, ref, ref1, style, styleStr, styles;\r\n      styleStr = $node.attr('style');\r\n      if (!styleStr) {\r\n        return;\r\n      }\r\n      $node.removeAttr('style');\r\n      allowedStyles = this._allowedStyles[$node[0].tagName.toLowerCase()];\r\n      if (!(allowedStyles && allowedStyles.length > 0)) {\r\n        return $node;\r\n      }\r\n      styles = {};\r\n      ref = styleStr.split(';');\r\n      for (k = 0, len = ref.length; k < len; k++) {\r\n        style = ref[k];\r\n        style = langx.trim(style);\r\n        pair = style.split(':');\r\n        if (pair.length !== 2) {\r\n          continue;\r\n        }\r\n        if (pair[0] === 'font-size' && pair[1].indexOf('px') > 0) {\r\n          if (parseInt(pair[1], 10) < 12) {\r\n            continue;\r\n          }\r\n        }\r\n        if (ref1 = pair[0], indexOf.call(allowedStyles, ref1) >= 0) {\r\n          styles[langx.trim(pair[0])] = langx.trim(pair[1]);\r\n        }\r\n      }\r\n      if (Object.keys(styles).length > 0) {\r\n        $node.css(styles);\r\n      }\r\n      return $node;\r\n    },\r\n\r\n    clearHtml : function(html, lineBreak) {\r\n      var container, contents, result;\r\n      if (lineBreak == null) {\r\n        lineBreak = true;\r\n      }\r\n      container = $('<div/>').append(html);\r\n      contents = container.contents();\r\n      result = '';\r\n      contents.each((function(_this) {\r\n        return function(i, node) {\r\n          var $node, children;\r\n          if (node.nodeType === 3) {\r\n            return result += node.nodeValue;\r\n          } else if (node.nodeType === 1) {\r\n            $node = $(node);\r\n            children = $node.is('iframe') ? null : $node.contents();\r\n            if (children && children.length > 0) {\r\n              result += _this.clearHtml(children);\r\n            }\r\n            if (lineBreak && i < contents.length - 1 && $node.is('br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header')) {\r\n              return result += '\\n';\r\n            }\r\n          }\r\n        };\r\n      })(this));\r\n      return result;\r\n    },\r\n\r\n    beautify : function($contents) {\r\n      var uselessP,\r\n          _this = this;\r\n      uselessP = function($el) {\r\n        return !!($el.is('p') && !$el.text() && $el.children(':not(br)').length < 1);\r\n      };\r\n      return $contents.each(function(i, el) {\r\n        var $el, invalid;\r\n        $el = $(el);\r\n        invalid = $el.is(':not(img, br, col, td, hr, [class^=\"' + _this.opts.classPrefix + '\"]):empty');\r\n        if (invalid || uselessP($el)) {\r\n          $el.remove();\r\n        }\r\n        return $el.find(':not(img, br, col, td, hr, [class^=\"' + _this.opts.classPrefix + '\"]):empty').remove();\r\n      });\r\n    }\r\n\r\n  });\r\n\r\n  Formatter.pluginName = 'Formatter';\r\n\r\n  return contents.Formatter = Formatter;\r\n\r\n});"]}