{"version":3,"sources":["indentation.js"],"names":["define","langx","noder","$","contents","Indentation","Evented","inherit","pluginName","prototype","opts","tabIndent","indentWidth","init","editable","_this","this","extend","keystroke","add","e","codeButton","toolbar","findButton","active","indent","shiftKey","isBackward","$blockNodes","nodes","result","selection","startNodes","endNodes","blockNodes","each","i","node","include","j","k","len","n","length","contains","splice","push","blockEl","r","outdentBlock","indentBlock","$blockEl","$childList","$nextTd","$nextTr","$parentLi","$pre","$td","$tr","marginLeft","tagName","is","containerNode","closest","indentText","range","prev","save","parent","children","append","appendTo","restore","parseInt","css","Math","round","classPrefix","next","find","setRangeAtEndOf","text","textNode","toString","replace","document","createTextNode","deleteContents","insertNode","selectNode","setRangeAfter","$parent","$prevTd","$prevTr","outdentText","createRange","setStartBefore","setEndBefore","before","extractContents","insertBefore","after","remove","nextAll","insertAfter","max"],"mappings":"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","file":"../indentation.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-noder\",\r\n  \"skylark-domx-query\",\r\n  \"./contents\"\r\n],function(langx,noder,$,contents){ \r\n\r\n\r\n  var Indentation = langx.Evented.inherit({\r\n\r\n  });\r\n\r\n\r\n  Indentation.pluginName = 'Indentation';\r\n\r\n  Indentation.prototype.opts = {\r\n    tabIndent: true,\r\n    indentWidth: 40\r\n   \r\n  };\r\n\r\n  Indentation.prototype.init = function(editable,opts) {\r\n    this.editable = editable; // this._module;\r\n    this.opts = langx.extend({}, this.opts, opts);\r\n\r\n    this.editable.keystroke.add('tab', '*', (function(_this) {\r\n      return function(e) {\r\n        var codeButton;\r\n        codeButton = _this.editable.toolbar.findButton('code');\r\n        if (!(_this.opts.tabIndent || (codeButton && codeButton.active))) {\r\n          return;\r\n        }\r\n        return _this.indent(e.shiftKey);\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  Indentation.prototype.indent = function(isBackward) {\r\n    var $blockNodes, $endNodes, $startNodes, nodes, result;\r\n    $startNodes = this.editable.selection.startNodes();\r\n    $endNodes = this.editable.selection.endNodes();\r\n    $blockNodes = this.editable.selection.blockNodes();\r\n    nodes = [];\r\n    $blockNodes = $blockNodes.each(function(i, node) {\r\n      var include, j, k, len, n;\r\n      include = true;\r\n      for (j = k = 0, len = nodes.length; k < len; j = ++k) {\r\n        n = nodes[j];\r\n        if (noder.contains(node, n)) {\r\n          include = false;\r\n          break;\r\n        } else if (noder.contains(n, node)) {\r\n          nodes.splice(j, 1, node);\r\n          include = false;\r\n          break;\r\n        }\r\n      }\r\n      if (include) {\r\n        return nodes.push(node);\r\n      }\r\n    });\r\n    $blockNodes = $(nodes);\r\n    result = false;\r\n    $blockNodes.each((function(_this) {\r\n      return function(i, blockEl) {\r\n        var r;\r\n        r = isBackward ? _this.outdentBlock(blockEl) : _this.indentBlock(blockEl);\r\n        if (r) {\r\n          return result = r;\r\n        }\r\n      };\r\n    })(this));\r\n    return result;\r\n  };\r\n\r\n  Indentation.prototype.indentBlock = function(blockEl) {\r\n    var $blockEl, $childList, $nextTd, $nextTr, $parentLi, $pre, $td, $tr, marginLeft, tagName;\r\n    $blockEl = $(blockEl);\r\n    if (!$blockEl.length) {\r\n      return;\r\n    }\r\n    if ($blockEl.is('pre')) {\r\n      $pre = this.editable.selection.containerNode();\r\n      if (!($pre.is($blockEl) || $pre.closest('pre').is($blockEl))) {\r\n        return;\r\n      }\r\n      this.indentText(this.editable.selection.range());\r\n    } else if ($blockEl.is('li')) {\r\n      $parentLi = $blockEl.prev('li');\r\n      if ($parentLi.length < 1) {\r\n        return;\r\n      }\r\n      this.editable.selection.save();\r\n      tagName = $blockEl.parent()[0].tagName;\r\n      $childList = $parentLi.children('ul, ol');\r\n      if ($childList.length > 0) {\r\n        $childList.append($blockEl);\r\n      } else {\r\n        $('<' + tagName + '/>').append($blockEl).appendTo($parentLi);\r\n      }\r\n      this.editable.selection.restore();\r\n    } else if ($blockEl.is('p, h1, h2, h3, h4')) {\r\n      marginLeft = parseInt($blockEl.css('margin-left')) || 0;\r\n      marginLeft = (Math.round(marginLeft / this.opts.indentWidth) + 1) * this.opts.indentWidth;\r\n      $blockEl.css('margin-left', marginLeft);\r\n    } else if ($blockEl.is('table') || $blockEl.is('.' + this.opts.classPrefix +'table')) {\r\n      $td = this.editable.selection.containerNode().closest('td, th');\r\n      $nextTd = $td.next('td, th');\r\n      if (!($nextTd.length > 0)) {\r\n        $tr = $td.parent('tr');\r\n        $nextTr = $tr.next('tr');\r\n        if ($nextTr.length < 1 && $tr.parent().is('thead')) {\r\n          $nextTr = $tr.parent('thead').next('tbody').find('tr:first');\r\n        }\r\n        $nextTd = $nextTr.find('td:first, th:first');\r\n      }\r\n      if (!($td.length > 0 && $nextTd.length > 0)) {\r\n        return;\r\n      }\r\n      this.editable.selection.setRangeAtEndOf($nextTd);\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  Indentation.prototype.indentText = function(range) {\r\n    var text, textNode;\r\n    text = range.toString().replace(/^(?=.+)/mg, '\\u00A0\\u00A0');\r\n    textNode = document.createTextNode(text || '\\u00A0\\u00A0');\r\n    range.deleteContents();\r\n    range.insertNode(textNode);\r\n    if (text) {\r\n      range.selectNode(textNode);\r\n      return this.editable.selection.range(range);\r\n    } else {\r\n      return this.editable.selection.setRangeAfter(textNode);\r\n    }\r\n  };\r\n\r\n  Indentation.prototype.outdentBlock = function(blockEl) {\r\n    var $blockEl, $parent, $parentLi, $pre, $prevTd, $prevTr, $td, $tr, marginLeft, range;\r\n    $blockEl = $(blockEl);\r\n    if (!($blockEl && $blockEl.length > 0)) {\r\n      return;\r\n    }\r\n    if ($blockEl.is('pre')) {\r\n      $pre = this.editable.selection.containerNode();\r\n      if (!($pre.is($blockEl) || $pre.closest('pre').is($blockEl))) {\r\n        return;\r\n      }\r\n      this.outdentText(range);\r\n    } else if ($blockEl.is('li')) {\r\n      $parent = $blockEl.parent();\r\n      $parentLi = $parent.parent('li');\r\n      this.editable.selection.save();\r\n      if ($parentLi.length < 1) {\r\n        range = document.createRange();\r\n        range.setStartBefore($parent[0]);\r\n        range.setEndBefore($blockEl[0]);\r\n        $parent.before(range.extractContents());\r\n        $('<p/>').insertBefore($parent).after($blockEl.children('ul, ol')).append($blockEl.contents());\r\n        $blockEl.remove();\r\n      } else {\r\n        if ($blockEl.next('li').length > 0) {\r\n          $('<' + $parent[0].tagName + '/>').append($blockEl.nextAll('li')).appendTo($blockEl);\r\n        }\r\n        $blockEl.insertAfter($parentLi);\r\n        if ($parent.children('li').length < 1) {\r\n          $parent.remove();\r\n        }\r\n      }\r\n      this.editable.selection.restore();\r\n    } else if ($blockEl.is('p, h1, h2, h3, h4')) {\r\n      marginLeft = parseInt($blockEl.css('margin-left')) || 0;\r\n      marginLeft = Math.max(Math.round(marginLeft / this.opts.indentWidth) - 1, 0) * this.opts.indentWidth;\r\n      $blockEl.css('margin-left', marginLeft === 0 ? '' : marginLeft);\r\n    } else if ($blockEl.is('table') || $blockEl.is('.' + this.opts.classPrefix + 'table')) {\r\n      $td = this.editable.selection.containerNode().closest('td, th');\r\n      $prevTd = $td.prev('td, th');\r\n      if (!($prevTd.length > 0)) {\r\n        $tr = $td.parent('tr');\r\n        $prevTr = $tr.prev('tr');\r\n        if ($prevTr.length < 1 && $tr.parent().is('tbody')) {\r\n          $prevTr = $tr.parent('tbody').prev('thead').find('tr:first');\r\n        }\r\n        $prevTd = $prevTr.find('td:last, th:last');\r\n      }\r\n      if (!($td.length > 0 && $prevTd.length > 0)) {\r\n        return;\r\n      }\r\n      this.editable.selection.setRangeAtEndOf($prevTd);\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  Indentation.prototype.outdentText = function(range) {};\r\n\r\n  return contents.Indentation = Indentation;\r\n\r\n});\r\n"]}