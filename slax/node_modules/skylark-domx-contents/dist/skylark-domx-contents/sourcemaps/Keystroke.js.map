{"version":3,"sources":["keystroke.js"],"names":["define","langx","$","contents","Keystroke","Evented","inherit","init","editable","opts","this","extend","_keystrokeHandlers","_initKeystrokeHandlers","pluginName","prototype","add","key","node","handler","toLowerCase","hotkeys","constructor","aliases","respondTo","e","base","ref","result","_this","keyNameMap","which","selection","startNodes","each","i","ref1","nodeType","Node","ELEMENT_NODE","tagName","titleEnterHandler","util","browser","safari","$blockEl","$br","shiftKey","blockNodes","last","is","rangeAtEndOf","insertNode","setRangeBefore","webkit","msie","$node","$p","append","phBr","insertAfter","setRangeAtStartOf","$prevBlockEl","$rootBlock","rootNodes","first","prev","rangeAtStartOf","save","remove","restore","classPrefix","preventDefault","setRangeAtEndOf","isEmptyNode","formatter","cleanNode","$cloneNode","listEl","newBlockEl","newListEl","clone","find","parent","next","length","nextAll","after","children","breakNode","range","deleteContents","document","createTextNode","setEnd","collapse","$closestBlock","createRange","$childList","$newLi","$prevChildList","$prevNode","$textNode","isFF","text","n","test","nodeName","nodeValue","firefox","appendTo","$newNode","codeStr","html","replace","$firstChild","unwrap"],"mappings":"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","file":"../keystroke.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"./contents\"\r\n],function(langx,$,contents){ \r\n\r\n  var Keystroke = langx.Evented.inherit({\r\n    init : function(editable,opts) {\r\n      this.editable = editable; //this._module;\r\n      this.opts = langx.extend({}, this.opts, opts);\r\n\r\n      this._keystrokeHandlers = {};\r\n      this._initKeystrokeHandlers();\r\n    }\r\n  });\r\n\r\n\r\n  Keystroke.pluginName = 'Keystroke';\r\n\r\n\r\n  Keystroke.prototype.add = function(key, node, handler) {\r\n    key = key.toLowerCase();\r\n    key = this.editable.hotkeys.constructor.aliases[key] || key;\r\n    if (!this._keystrokeHandlers[key]) {\r\n      this._keystrokeHandlers[key] = {};\r\n    }\r\n    return this._keystrokeHandlers[key][node] = handler;\r\n  };\r\n\r\n  Keystroke.prototype.respondTo = function(e) {\r\n    var base, key, ref, result;\r\n    key = (ref = this.editable.hotkeys.constructor.keyNameMap[e.which]) != null ? ref.toLowerCase() : void 0;\r\n    if (!key) {\r\n      return;\r\n    }\r\n    if (key in this._keystrokeHandlers) {\r\n      result = typeof (base = this._keystrokeHandlers[key])['*'] === \"function\" ? base['*'](e) : void 0;\r\n      if (!result) {\r\n        this.editable.selection.startNodes().each((function(_this) {\r\n          return function(i, node) {\r\n            var handler, ref1;\r\n            if (node.nodeType !== Node.ELEMENT_NODE) {\r\n              return;\r\n            }\r\n            handler = (ref1 = _this._keystrokeHandlers[key]) != null ? ref1[node.tagName.toLowerCase()] : void 0;\r\n            result = typeof handler === \"function\" ? handler(e, $(node)) : void 0;\r\n            if (result === true || result === false) {\r\n              return false;\r\n            }\r\n          };\r\n        })(this));\r\n      }\r\n      if (result) {\r\n        return true;\r\n      }\r\n    }\r\n  };\r\n\r\n  Keystroke.prototype._initKeystrokeHandlers = function() {\r\n    var titleEnterHandler;\r\n    if (this.editable.util.browser.safari) {\r\n      this.add('enter', '*', (function(_this) {\r\n        return function(e) {\r\n          var $blockEl, $br;\r\n          if (!e.shiftKey) {\r\n            return;\r\n          }\r\n          $blockEl = _this.editable.selection.blockNodes().last();\r\n          if ($blockEl.is('pre')) {\r\n            return;\r\n          }\r\n          $br = $('<br/>');\r\n          if (_this.editable.selection.rangeAtEndOf($blockEl)) {\r\n            _this.editable.selection.insertNode($br);\r\n            _this.editable.selection.insertNode($('<br/>'));\r\n            _this.editable.selection.setRangeBefore($br);\r\n          } else {\r\n            _this.editable.selection.insertNode($br);\r\n          }\r\n          return true;\r\n        };\r\n      })(this));\r\n    }\r\n    if (this.editable.util.browser.webkit || this.editable.util.browser.msie) {\r\n      titleEnterHandler = (function(_this) {\r\n        return function(e, $node) {\r\n          var $p;\r\n          if (!_this.editable.selection.rangeAtEndOf($node)) {\r\n            return;\r\n          }\r\n          $p = $('<p/>').append(_this.editable.util.phBr).insertAfter($node);\r\n          _this.editable.selection.setRangeAtStartOf($p);\r\n          return true;\r\n        };\r\n      })(this);\r\n      this.add('enter', 'h1', titleEnterHandler);\r\n      this.add('enter', 'h2', titleEnterHandler);\r\n      this.add('enter', 'h3', titleEnterHandler);\r\n      this.add('enter', 'h4', titleEnterHandler);\r\n      this.add('enter', 'h5', titleEnterHandler);\r\n      this.add('enter', 'h6', titleEnterHandler);\r\n    }\r\n    this.add('backspace', '*', (function(_this) {\r\n      return function(e) {\r\n        var $blockEl, $prevBlockEl, $rootBlock, isWebkit;\r\n        $rootBlock = _this.editable.selection.rootNodes().first();\r\n        $prevBlockEl = $rootBlock.prev();\r\n        if ($prevBlockEl.is('hr') && _this.editable.selection.rangeAtStartOf($rootBlock)) {\r\n          _this.editable.selection.save();\r\n          $prevBlockEl.remove();\r\n          _this.editable.selection.restore();\r\n          return true;\r\n        }\r\n        $blockEl = _this.editable.selection.blockNodes().last();\r\n        if ($blockEl.is('.' + _this.opts.classPrefix + 'resize-handle') && $rootBlock.is('.' + _this.opts.classPrefix + 'table')) {\r\n          e.preventDefault();\r\n          $rootBlock.remove();\r\n          _this.editable.selection.setRangeAtEndOf($prevBlockEl);\r\n        }\r\n        if ($prevBlockEl.is('.' + _this.opts.classPrefix + 'table') && !$blockEl.is('table') && _this.editable.util.isEmptyNode($blockEl)) {\r\n          e.preventDefault();\r\n          $blockEl.remove();\r\n          _this.editable.selection.setRangeAtEndOf($prevBlockEl);\r\n        }\r\n        isWebkit = _this.editable.util.browser.webkit;\r\n        if (isWebkit && _this.editable.selection.rangeAtStartOf($blockEl)) {\r\n          _this.editable.selection.save();\r\n          _this.editable.formatter.cleanNode($blockEl, true);\r\n          _this.editable.selection.restore();\r\n          return null;\r\n        }\r\n      };\r\n    })(this));\r\n    this.add('enter', 'div', (function(_this) {\r\n      return function(e, $node) {\r\n        var $blockEl, $p;\r\n        if ($node.is('.' + _this.opts.classPrefix + 'table')) {\r\n          $blockEl = _this.editable.selection.blockNodes().last();\r\n          if ($blockEl.is('.' + _this.opts.classPrefix + 'resize-handle')) {\r\n            e.preventDefault();\r\n            $p = $('<p/>').append(_this.editable.util.phBr).insertAfter($node);\r\n            return _this.editable.selection.setRangeAtStartOf($p);\r\n          }\r\n        }\r\n      };\r\n    })(this));\r\n    this.add('enter', 'li', (function(_this) {\r\n      return function(e, $node) {\r\n        var $cloneNode, listEl, newBlockEl, newListEl;\r\n        $cloneNode = $node.clone();\r\n        $cloneNode.find('ul, ol').remove();\r\n        if (!(_this.editable.util.isEmptyNode($cloneNode) && $node.is(_this.editable.selection.blockNodes().last()))) {\r\n          return;\r\n        }\r\n        listEl = $node.parent();  \r\n        if ($node.next('li').length > 0) {\r\n          if (!_this.editable.util.isEmptyNode($node)) {\r\n            return;\r\n          }\r\n          if (listEl.parent('li').length > 0) {\r\n            newBlockEl = $('<li/>').append(_this.editable.util.phBr).insertAfter(listEl.parent('li'));\r\n            newListEl = $('<' + listEl[0].tagName + '/>').append($node.nextAll('li'));\r\n            newBlockEl.append(newListEl);\r\n          } else {\r\n            newBlockEl = $('<p/>').append(_this.editable.util.phBr).insertAfter(listEl);\r\n            newListEl = $('<' + listEl[0].tagName + '/>').append($node.nextAll('li'));\r\n            newBlockEl.after(newListEl);\r\n          }\r\n        } else {\r\n          if (listEl.parent('li').length > 0) {\r\n            newBlockEl = $('<li/>').insertAfter(listEl.parent('li'));\r\n            if ($node.contents().length > 0) {\r\n              newBlockEl.append($node.contents());\r\n            } else {\r\n              newBlockEl.append(_this.editable.util.phBr);\r\n            }\r\n          } else {\r\n            newBlockEl = $('<p/>').append(_this.editable.util.phBr).insertAfter(listEl);\r\n            if ($node.children('ul, ol').length > 0) {\r\n              newBlockEl.after($node.children('ul, ol'));\r\n            }\r\n          }\r\n        }\r\n        if ($node.prev('li').length) {\r\n          $node.remove();\r\n        } else {\r\n          if ($node.prev('ul').length || $node.prev('ol').length) {\r\n            $node.remove();\r\n          } else {\r\n            listEl.remove();\r\n          }\r\n        }\r\n        _this.editable.selection.setRangeAtStartOf(newBlockEl);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('enter', 'pre', (function(_this) {\r\n      return function(e, $node) {\r\n        var $p, breakNode, range;\r\n        e.preventDefault();\r\n        if (e.shiftKey) {\r\n          $p = $('<p/>').append(_this.editable.util.phBr).insertAfter($node);\r\n          _this.editable.selection.setRangeAtStartOf($p);\r\n          return true;\r\n        }\r\n        range = _this.editable.selection.range();\r\n        breakNode = null;\r\n        range.deleteContents();\r\n        if (!_this.editable.util.browser.msie && _this.editable.selection.rangeAtEndOf($node)) {\r\n          breakNode = document.createTextNode('\\n\\n');\r\n        } else {\r\n          breakNode = document.createTextNode('\\n');\r\n        }\r\n        range.insertNode(breakNode);\r\n        range.setEnd(breakNode, 1);\r\n        range.collapse(false);\r\n        _this.editable.selection.range(range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('enter', 'blockquote', (function(_this) {\r\n      return function(e, $node) {\r\n        var $closestBlock, range;\r\n        $closestBlock = _this.editable.selection.blockNodes().last();\r\n        if (!($closestBlock.is('p') && !$closestBlock.next().length && _this.editable.util.isEmptyNode($closestBlock))) {\r\n          return;\r\n        }\r\n        $node.after($closestBlock);\r\n        range = document.createRange();\r\n        _this.editable.selection.setRangeAtStartOf($closestBlock, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('backspace', 'li', (function(_this) {\r\n      return function(e, $node) {\r\n        var $br, $childList, $newLi, $prevChildList, $prevNode, $textNode, isFF, range, text;\r\n        $childList = $node.children('ul, ol');\r\n        $prevNode = $node.prev('li');\r\n        if (!($childList.length > 0 && $prevNode.length > 0)) {\r\n          return false;\r\n        }\r\n        text = '';\r\n        $textNode = null;\r\n        $node.contents().each(function(i, n) {\r\n          if (n.nodeType === 1 && /UL|OL/.test(n.nodeName)) {\r\n            return false;\r\n          }\r\n          if (n.nodeType === 1 && /BR/.test(n.nodeName)) {\r\n            return;\r\n          }\r\n          if (n.nodeType === 3 && n.nodeValue) {\r\n            text += n.nodeValue;\r\n          } else if (n.nodeType === 1) {\r\n            text += $(n).text();\r\n          }\r\n          return $textNode = $(n);\r\n        });\r\n        isFF = _this.editable.util.browser.firefox && !$textNode.next('br').length;\r\n        if ($textNode && text.length === 1 && isFF) {\r\n          $br = $(_this.editable.util.phBr).insertAfter($textNode);\r\n          $textNode.remove();\r\n          _this.editable.selection.setRangeBefore($br);\r\n          return true;\r\n        } else if (text.length > 0) {\r\n          return false;\r\n        }\r\n        range = document.createRange();\r\n        $prevChildList = $prevNode.children('ul, ol');\r\n        if ($prevChildList.length > 0) {\r\n          $newLi = $('<li/>').append(_this.editable.util.phBr).appendTo($prevChildList);\r\n          $prevChildList.append($childList.children('li'));\r\n          $node.remove();\r\n          _this.editable.selection.setRangeAtEndOf($newLi, range);\r\n        } else {\r\n          _this.editable.selection.setRangeAtEndOf($prevNode, range);\r\n          $prevNode.append($childList);\r\n          $node.remove();\r\n          _this.editable.selection.range(range);\r\n        }\r\n        return true;\r\n      };\r\n    })(this));\r\n    this.add('backspace', 'pre', (function(_this) {\r\n      return function(e, $node) {\r\n        var $newNode, codeStr, range;\r\n        if (!_this.editable.selection.rangeAtStartOf($node)) {\r\n          return;\r\n        }\r\n        codeStr = $node.html().replace('\\n', '<br/>') || _this.editable.util.phBr;\r\n        $newNode = $('<p/>').append(codeStr).insertAfter($node);\r\n        $node.remove();\r\n        range = document.createRange();\r\n        _this.editable.selection.setRangeAtStartOf($newNode, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n    return this.add('backspace', 'blockquote', (function(_this) {\r\n      return function(e, $node) {\r\n        var $firstChild, range;\r\n        if (!_this.editable.selection.rangeAtStartOf($node)) {\r\n          return;\r\n        }\r\n        $firstChild = $node.children().first().unwrap();\r\n        range = document.createRange();\r\n        _this.editable.selection.setRangeAtStartOf($firstChild, range);\r\n        return true;\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  return contents.Keystroke = Keystroke;\r\n\r\n});\r\n"]}