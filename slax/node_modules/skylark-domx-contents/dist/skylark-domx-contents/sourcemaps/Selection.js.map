{"version":3,"sources":["Selection.js"],"names":["define","langx","noder","$","contents","Selection","Evented","inherit","_range","_startNodes","_endNodes","_containerNode","_nodes","_blockNodes","_rootNodes","init","editable","opts","self","this","extend","_selection","document","getSelection","on","e","console","log","reset","getRangeAt","clear","removeAllRanges","_error","range","ffOrIE","addRange","hoster","browser","mozilla","msie","inputManager","focused","body","focus","rangeCount","startNodes","startContainer","parentsUntil","get","unshift","endNodes","collapsed","endContainer","containerNode","commonAncestorContainer","nodes","first","is","each","i","node","$endNode","$node","$nodes","endIndex","index","sharedIndex","startIndex","push","parent","eq","last","merge","slice","uniq","blockNodes","filter","util","isBlockNode","rootNodes","$parent","rangeAtEndOf","afterLastNode","beforeLastNode","endNode","endNodeLength","lastNodeIsBr","result","getNodeLength","endOffset","contains","addBack","n","$lastChild","beforeLastbr","isLastNode","nodeType","nodeValue","prev","rangeAtStartOf","startNode","startOffset","insertNode","setRangeAfter","setEndAfter","collapse","setRangeBefore","setEndBefore","setRangeAtStartOf","setEnd","setRangeAtEndOf","$lastNode","lastChild","lastChildLength","lastText","nodeLength","length","text","charAt","isEmptyNode","append","phBr","deleteRangeContents","atEndOfBody","atStartOfBody","endRange","startRange","cloneRange","empty","setStart","deleteContents","breakBlockEl","el","$el","setStartBefore","before","extractContents","save","endCaret","startCaret","_selectionSaved","addClass","classPrefix","restore","find","createRange","remove","pluginName"],"mappings":"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","file":"../Selection.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-noder\",\r\n  \"skylark-domx-query\",\r\n  \"./contents\"\r\n],function(langx,noder,$,contents){ \r\n\r\n  var Selection = langx.Evented.inherit({\r\n    _range : null,\r\n\r\n    _startNodes : null,\r\n\r\n    _endNodes : null,\r\n\r\n    _containerNode : null,\r\n\r\n    _nodes : null,\r\n\r\n    _blockNodes : null,\r\n\r\n    _rootNodes : null,\r\n\r\n    init : function(editable,opts) {\r\n      var self = this;\r\n      this.editable = editable; //this._module;\r\n      this.opts = langx.extend({}, this.opts, opts);\r\n      this._selection = document.getSelection();\r\n\r\n      this.editable.on('selectionchanged', function(e) {\r\n        console.log(\"selectionchanged\");\r\n        self.reset();\r\n        return self._range = self._selection.getRangeAt(0);\r\n      });\r\n\r\n      this.editable.on('blur', function(e) {\r\n        return self.reset();\r\n      });\r\n\r\n      this.editable.on('focus', function(e) {\r\n        self.reset();\r\n        return self._range = self._selection.getRangeAt(0);\r\n      });\r\n    },\r\n\r\n    reset : function() {\r\n      this._range = null;\r\n      this._startNodes = null;\r\n      this._endNodes = null;\r\n      this._containerNode = null;\r\n      this._nodes = null;\r\n      this._blockNodes = null;\r\n\r\n      return this._rootNodes = null;\r\n    },\r\n\r\n    clear : function() {\r\n      var e;\r\n      try {\r\n        this._selection.removeAllRanges();\r\n        console.log(\"clear\");\r\n      } catch (_error) {\r\n        e = _error;\r\n      }\r\n      return this.reset();\r\n    },\r\n\r\n    range : function(range) {\r\n      var ffOrIE;\r\n      if (range) {\r\n        this.clear();\r\n        this._selection.addRange(range);\r\n        this._range = range;\r\n //       ffOrIE = this.editable.util.browser.firefox || this.editable.util.browser.msie;\r\n        ffOrIE = langx.hoster.browser.mozilla || langx.hoster.browser.msie;\r\n        if (!this.editable.inputManager.focused && ffOrIE) {\r\n          this.editable.body.focus();\r\n        }\r\n      } else if (!this._range && this.editable.inputManager.focused && this._selection.rangeCount) {\r\n        this._range = this._selection.getRangeAt(0);\r\n      }\r\n      return this._range;\r\n    },\r\n\r\n    startNodes : function() {\r\n      if (this._range) {\r\n        if (!this._startNodes) {\r\n          this._startNodes = (function(self) {\r\n            return function() {\r\n              var startNodes;\r\n              startNodes = $(self._range.startContainer).parentsUntil(self.editable.body).get();\r\n              startNodes.unshift(self._range.startContainer);\r\n              return $(startNodes);\r\n            };\r\n          })(this)();\r\n        } \r\n\r\n      }\r\n      return this._startNodes;\r\n    },\r\n\r\n    endNodes : function() {\r\n      var endNodes;\r\n      if (this._range) {\r\n        this._endNodes || (this._endNodes = this._range.collapsed ? this.startNodes() : (endNodes = $(this._range.endContainer).parentsUntil(this.editable.body).get(), endNodes.unshift(this._range.endContainer), $(endNodes)));\r\n      }\r\n      return this._endNodes;\r\n    },\r\n\r\n    containerNode : function() {\r\n      if (this._range) {\r\n        this._containerNode || (this._containerNode = $(this._range.commonAncestorContainer));\r\n      }\r\n      return this._containerNode;\r\n    },\r\n\r\n    nodes : function() {\r\n      if (this._range) {\r\n        this._nodes || (this._nodes = (function(self) {\r\n          return function() {\r\n            var nodes;\r\n            nodes = [];\r\n            if (self.startNodes().first().is(self.endNodes().first())) {\r\n              nodes = self.startNodes().get();\r\n            } else {\r\n              self.startNodes().each(function(i, node) {\r\n                var $endNode, $node, $nodes, endIndex, index, sharedIndex, startIndex;\r\n                $node = $(node);\r\n                if (self.endNodes().index($node) > -1) {\r\n                  return nodes.push(node);\r\n                } else if ($node.parent().is(self.editable.body) || (sharedIndex = self.endNodes().index($node.parent())) > -1) {\r\n                  if (sharedIndex && sharedIndex > -1) {\r\n                    $endNode = self.endNodes().eq(sharedIndex - 1);\r\n                  } else {\r\n                    $endNode = self.endNodes().last();\r\n                  }\r\n                  $nodes = $node.parent().contents();\r\n                  startIndex = $nodes.index($node);\r\n                  endIndex = $nodes.index($endNode);\r\n                  return langx.merge(nodes, $nodes.slice(startIndex, endIndex).get());\r\n                } else {\r\n                  $nodes = $node.parent().contents();\r\n                  index = $nodes.index($node);\r\n                  return langx.merge(nodes, $nodes.slice(index).get());\r\n                }\r\n              });\r\n              self.endNodes().each(function(i, node) {\r\n                var $node, $nodes, index;\r\n                $node = $(node);\r\n                if ($node.parent().is(self.editable.body) || self.startNodes().index($node.parent()) > -1) {\r\n                  nodes.push(node);\r\n                  return false;\r\n                } else {\r\n                  $nodes = $node.parent().contents();\r\n                  index = $nodes.index($node);\r\n                  return langx.merge(nodes, $nodes.slice(0, index + 1));\r\n                }\r\n              });\r\n            }\r\n            return $(langx.uniq(nodes));\r\n          };\r\n        })(this)());\r\n      }\r\n      return this._nodes;\r\n    },\r\n\r\n    blockNodes : function() {\r\n      if (!this._range) {\r\n        return;\r\n      }\r\n\r\n      this._blockNodes || (this._blockNodes = (function(self) {\r\n        return function() {\r\n          return self.nodes().filter(function(i, node) {\r\n            return self.editable.util.isBlockNode(node);\r\n          });\r\n        };\r\n      })(this)());\r\n\r\n      return this._blockNodes;\r\n    },\r\n\r\n    rootNodes : function() {\r\n      if (!this._range) {\r\n        return;\r\n      }\r\n      this._rootNodes || (this._rootNodes = (function(self) {\r\n        return function() {\r\n          return self.nodes().filter(function(i, node) {\r\n            var $parent;\r\n            $parent = $(node).parent();\r\n            return $parent.is(self.editable.body) || $parent.is('blockquote');\r\n          });\r\n        };\r\n      })(this)());\r\n\r\n      return this._rootNodes;\r\n    },\r\n\r\n    rangeAtEndOf : function(node, range) {\r\n      var afterLastNode, beforeLastNode, endNode, endNodeLength, lastNodeIsBr, result;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (!(range && range.collapsed)) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      endNode = range.endContainer;\r\n      endNodeLength = this.editable.util.getNodeLength(endNode);\r\n      beforeLastNode = range.endOffset === endNodeLength - 1;\r\n      lastNodeIsBr = $(endNode).contents().last().is('br');\r\n      afterLastNode = range.endOffset === endNodeLength;\r\n      if (!((beforeLastNode && lastNodeIsBr) || afterLastNode)) {\r\n        return false;\r\n      }\r\n      if (node === endNode) {\r\n        return true;\r\n      } else if (!noder.contains(node, endNode)) {\r\n        return false;\r\n      }\r\n      result = true;\r\n      $(endNode).parentsUntil(node).addBack().each(function(i, n) {\r\n        var $lastChild, beforeLastbr, isLastNode, nodes;\r\n        nodes = $(n).parent().contents().filter(function() {\r\n          return !(this !== n && this.nodeType === 3 && !this.nodeValue);\r\n        });\r\n        $lastChild = nodes.last();\r\n        isLastNode = $lastChild.get(0) === n;\r\n        beforeLastbr = $lastChild.is('br') && $lastChild.prev().get(0) === n;\r\n        if (!(isLastNode || beforeLastbr)) {\r\n          result = false;\r\n          return false;\r\n        }\r\n      });\r\n      return result;\r\n    },\r\n\r\n    rangeAtStartOf : function(node, range) {\r\n      var result, startNode;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (!(range && range.collapsed)) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      startNode = range.startContainer;\r\n      if (range.startOffset !== 0) {\r\n        return false;\r\n      }\r\n      if (node === startNode) {\r\n        return true;\r\n      } else if (!noder.contains(node, startNode)) {\r\n        return false;\r\n      }\r\n      result = true;\r\n      $(startNode).parentsUntil(node).addBack().each(function(i, n) {\r\n        var nodes;\r\n        nodes = $(n).parent().contents().filter(function() {\r\n          return !(this !== n && this.nodeType === 3 && !this.nodeValue);\r\n        });\r\n        if (nodes.first().get(0) !== n) {\r\n          return result = false;\r\n        }\r\n      });\r\n      return result;\r\n    },\r\n\r\n    insertNode : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (!range) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      range.insertNode(node);\r\n      return this.setRangeAfter(node, range);\r\n    },\r\n\r\n    setRangeAfter : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (range == null) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      range.setEndAfter(node);\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    setRangeBefore : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (range == null) {\r\n        return;\r\n      }\r\n      node = $(node)[0];\r\n      range.setEndBefore(node);\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    setRangeAtStartOf : function(node, range) {\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      node = $(node).get(0);\r\n      range.setEnd(node, 0);\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    setRangeAtEndOf : function(node, range) {\r\n      var $lastNode, $node, contents, lastChild, lastChildLength, lastText, nodeLength;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      $node = $(node);\r\n      node = $node[0];\r\n      if (!node) {\r\n        return;\r\n      }\r\n      if ($node.is('pre')) {\r\n        contents = $node.contents();\r\n        if (contents.length > 0) {\r\n          lastChild = contents.last();\r\n          lastText = lastChild.text();\r\n          lastChildLength = this.editable.util.getNodeLength(lastChild[0]);\r\n          if (lastText.charAt(lastText.length - 1) === '\\n') {\r\n            range.setEnd(lastChild[0], lastChildLength - 1);\r\n          } else {\r\n            range.setEnd(lastChild[0], lastChildLength);\r\n          }\r\n        } else {\r\n          range.setEnd(node, 0);\r\n        }\r\n      } else {\r\n        nodeLength = this.editable.util.getNodeLength(node);\r\n        if (node.nodeType !== 3 && nodeLength > 0) {\r\n          $lastNode = $(node).contents().last();\r\n          if ($lastNode.is('br')) {\r\n            nodeLength -= 1;\r\n          } else if ($lastNode[0].nodeType !== 3 && this.editable.util.isEmptyNode($lastNode)) {\r\n            $lastNode.append(this.editable.util.phBr);\r\n            node = $lastNode[0];\r\n            nodeLength = 0;\r\n          }\r\n        }\r\n        range.setEnd(node, nodeLength);\r\n      }\r\n      range.collapse(false);\r\n      return this.range(range);\r\n    },\r\n\r\n    deleteRangeContents : function(range) {\r\n      var atEndOfBody, atStartOfBody, endRange, startRange;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      startRange = range.cloneRange();\r\n      endRange = range.cloneRange();\r\n      startRange.collapse(true);\r\n      endRange.collapse(false);\r\n      atStartOfBody = this.rangeAtStartOf(this.editable.body, startRange);\r\n      atEndOfBody = this.rangeAtEndOf(this.editable.body, endRange);\r\n      if (!range.collapsed && atStartOfBody && atEndOfBody) {\r\n        this.editable.body.empty();\r\n        range.setStart(this.editable.body[0], 0);\r\n        range.collapse(true);\r\n        this.range(range);\r\n      } else {\r\n        range.deleteContents();\r\n      }\r\n      return range;\r\n    },\r\n\r\n    breakBlockEl : function(el, range) {\r\n      var $el;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      $el = $(el);\r\n      if (!range.collapsed) {\r\n        return $el;\r\n      }\r\n      range.setStartBefore($el.get(0));\r\n      if (range.collapsed) {\r\n        return $el;\r\n      }\r\n      return $el.before(range.extractContents());\r\n    },\r\n\r\n    save : function(range) {\r\n      var endCaret, endRange, startCaret;\r\n      if (range == null) {\r\n        range = this.range();\r\n      }\r\n      if (this._selectionSaved) {\r\n        return;\r\n      }\r\n      endRange = range.cloneRange();\r\n      endRange.collapse(false);\r\n      startCaret = $('<span/>').addClass(this.opts.classPrefix +'caret-start');\r\n      endCaret = $('<span/>').addClass(this.opts.classPrefix +'caret-end');\r\n      endRange.insertNode(endCaret[0]);\r\n      range.insertNode(startCaret[0]);\r\n      this.clear();\r\n      return this._selectionSaved = true;\r\n    },\r\n\r\n    restore : function() {\r\n      var endCaret, endContainer, endOffset, range, startCaret, startContainer, startOffset;\r\n      if (!this._selectionSaved) {\r\n        return false;\r\n      }\r\n      startCaret = this.editable.body.find('.' + this.opts.classPrefix +'caret-start');\r\n      endCaret = this.editable.body.find('.' + this.opts.classPrefix +'caret-end');\r\n      if (startCaret.length && endCaret.length) {\r\n        startContainer = startCaret.parent();\r\n        startOffset = startContainer.contents().index(startCaret);\r\n        endContainer = endCaret.parent();\r\n        endOffset = endContainer.contents().index(endCaret);\r\n        if (startContainer[0] === endContainer[0]) {\r\n          endOffset -= 1;\r\n        }\r\n        range = document.createRange();\r\n        range.setStart(startContainer.get(0), startOffset);\r\n        range.setEnd(endContainer.get(0), endOffset);\r\n        startCaret.remove();\r\n        endCaret.remove();\r\n        this.range(range);\r\n      } else {\r\n        startCaret.remove();\r\n        endCaret.remove();\r\n      }\r\n      this._selectionSaved = false;\r\n      return range;\r\n    },\r\n  });\r\n\r\n  Selection.pluginName = 'Selection';\r\n\r\n\r\n  return contents.Selection = Selection;\r\n\r\n});"]}