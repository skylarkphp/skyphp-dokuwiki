{"version":3,"sources":["editable.js"],"names":["define","langx","noder","$","contents","Hotkeys","Util","InputManager","Selection","UndoManager","Keystroke","Formatter","Indentation","Clipboard","Editable","Evented","inherit","init","el","opts","this","$el","textarea","body","pluginOpts","classPrefix","util","hotkeys","inputManager","selection","undoManager","keystroke","formatter","indentation","clipboard","os","mac","addClass","linux","mobile","browser","mozilla","reflow","document","execCommand","_error","e","setValue","val","get","innerHTML","format","decorate","lastCaretPosition","getValue","sync","children","cloneBody","emptyP","firstP","lastP","clone","undecorate","autolink","last","first","is","isEmptyNode","prev","remove","next","find","trim","html","focus","$blockEl","range","caretPosition","append","phBr","appendTo","createRange","setRangeAtEndOf","blur","isActive","state","queryCommandState","status","cmd","htmlTag","nodes","filter","length","css","alignment","align","Error","text-align","trigger","throttledSelectionChanged","blockquote","disableTag","$rootNodes","clearCache","nodeCache","_this","rootNodes","i","node","parent","save","insertBefore","each","$node","unwrap","isDecoratedNode","push","restore","blockCode","resultNodes","$pre","text","clearHtml","$p","replace","replaceAll","fontColor","hex","isDefault","coloredText","collapsed","textNode","createTextNode","insertNode","selectNodeContents","support","oninput","fontScale","param","sizeMap","containerNode","x-large","large","small","x-small","reset","nodeType","Node","TEXT_NODE","closest","n","$span","size","style","fontSize","test","replaceWith","hr","$hr","$newBlock","$rootBlock","insertAfter","setRangeAtStartOf","inlineCode","active","$code","$contents","extractContents","indent","link","defaultLinkText","$link","linkText","txtNode","startNodes","selectNode","href","target","blockNodes","list","type","$list","anotherType","contains","li","outdent","title","forEach","prototype"],"mappings":"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","file":"../editable.js","sourcesContent":["define([\r\n\t\"skylark-langx/langx\",\r\n\t\"skylark-domx-noder\",\r\n\t\"skylark-domx-query\",\r\n\t\"./contents\",\r\n\t\"./hotkeys\",\r\n\t\"./util\",\r\n\t\"./input-manager\", \r\n\t\"./selection\", \r\n\t\"./undo-manager\", \r\n\t\"./keystroke\",\r\n\t\"./formatter\", \r\n\t\"./indentation\", \r\n\t\"./clipboard\"\r\n],function(langx, noder, $, contents,Hotkeys,Util,InputManager,Selection,UndoManager,Keystroke,Formatter,Indentation,Clipboard){\r\n  var Editable = langx.Evented.inherit({\r\n    init : function(el,opts) {\r\n    \tthis.$el = $(el);\r\n    \tthis.textarea = $(opts.textarea);\r\n    \tthis.body = $(opts.body);\r\n\r\n    \tvar pluginOpts = {\r\n    \t\tclassPrefix : opts.classPrefix\r\n    \t};\r\n\r\n        this.util = new Util(this,pluginOpts);\r\n\r\n\t\tthis.hotkeys = new Hotkeys({\r\n\t\t  el: this.body\r\n\t\t});\r\n\r\n      this.inputManager = new InputManager(this,pluginOpts);\r\n      this.selection = new Selection(this,pluginOpts);\r\n      this.undoManager = new UndoManager(this,pluginOpts);\r\n      this.keystroke = new Keystroke(this,pluginOpts);\r\n      this.formatter = new Formatter(this,pluginOpts);\r\n      this.indentation = new Indentation(this,pluginOpts);\r\n      this.clipboard = new Clipboard(this,pluginOpts);\r\n\r\n\t\tif (this.util.os.mac) {\r\n\t\t  this.$el.addClass(opts.classPrefix + 'mac');\r\n\t\t} else if (this.util.os.linux) {\r\n\t\t  this.$el.addClass(opts.classPrefix + 'linux');\r\n\t\t}\r\n\t\tif (this.util.os.mobile) {\r\n\t\t  this.$el.addClass(opts.classPrefix + 'mobile');\r\n\t\t}\r\n\r\n      if (this.util.browser.mozilla) {\r\n        this.util.reflow();\r\n        try {\r\n          document.execCommand('enableObjectResizing', false, false);\r\n          return document.execCommand('enableInlineTableEditing', false, false);\r\n        } catch (_error) {\r\n          e = _error;\r\n        }\r\n      }\r\n\r\n    },\r\n\r\n\tsetValue : function(val) {\r\n\t\tthis.textarea.val(val);\r\n\t\tthis.body.get(0).innerHTML = val;\r\n\t\tthis.formatter.format();\r\n\t\tthis.formatter.decorate();\r\n\t\tthis.util.reflow(this.body);\r\n\t\tthis.inputManager.lastCaretPosition = null;\r\n\t},\r\n\r\n\tgetValue : function() {\r\n\t\treturn this.sync();\r\n\t},\r\n\r\n\tsync : function() {\r\n\t\tvar children, cloneBody, emptyP, firstP, lastP, val;\r\n\t\tcloneBody = this.body.clone();\r\n\t\tthis.formatter.undecorate(cloneBody);\r\n\t\tthis.formatter.format(cloneBody);\r\n\t\tthis.formatter.autolink(cloneBody);\r\n\t\tchildren = cloneBody.children();\r\n\t\tlastP = children.last('p');\r\n\t\tfirstP = children.first('p');\r\n\t\twhile (lastP.is('p') && this.util.isEmptyNode(lastP)) {\r\n\t\t  emptyP = lastP;\r\n\t\t  lastP = lastP.prev('p');\r\n\t\t  emptyP.remove();\r\n\t\t}\r\n\t\twhile (firstP.is('p') && this.util.isEmptyNode(firstP)) {\r\n\t\t  emptyP = firstP;\r\n\t\t  firstP = lastP.next('p');\r\n\t\t  emptyP.remove();\r\n\t\t}\r\n\t\tcloneBody.find('img.uploading').remove();\r\n\t\tval = langx.trim(cloneBody.html());\r\n\t\tthis.textarea.val(val);\r\n\t\treturn val;\r\n\t},\r\n\r\n\tfocus : function() {\r\n\t\tvar $blockEl, range;\r\n\t\tif (!(this.body.is(':visible') && this.body.is('[contenteditable]'))) {\r\n\t\t  this.$el.find('textarea:visible').focus();\r\n\t\t  return;\r\n\t\t}\r\n\t\tif (this.inputManager.lastCaretPosition) {\r\n\t\t  this.undoManager.caretPosition(this.inputManager.lastCaretPosition);\r\n\t\t  return this.inputManager.lastCaretPosition = null;\r\n\t\t} else {\r\n\t\t  $blockEl = this.body.children().last();\r\n\t\t  if (!$blockEl.is('p')) {\r\n\t\t    $blockEl = $('<p/>').append(this.util.phBr).appendTo(this.body);\r\n\t\t  }\r\n\t\t  range = document.createRange();\r\n\t\t  return this.selection.setRangeAtEndOf($blockEl, range);\r\n\t\t}\r\n\t},\r\n\r\n\tblur : function() {\r\n\t\tif (this.body.is(':visible') && this.body.is('[contenteditable]')) {\r\n\t\t  return this.body.blur();\r\n\t\t} else {\r\n\t\t  return this.body.find('textarea:visible').blur();\r\n\t\t}\r\n\t},\r\n\r\n\tisActive : function(state) {\r\n\t\treturn document.queryCommandState(state) === true; //'bold'\r\n\t},\r\n\r\n\tstatus : function(cmd,htmlTag) {\r\n\t\tif (cmd === \"alignment\") {\r\n\t\t    var nodes = this.selection.nodes().filter(htmlTag);\r\n\t\t    if (nodes.length < 1) {\r\n\t\t    \treturn null;\r\n\t\t    } else {\r\n\t\t      return nodes.first().css('text-align');\r\n\t\t    }\r\n\r\n\t\t}\r\n\t},\r\n\r\n\talignment : function(align,htmlTag) {\r\n\t    if (align !== 'left' && align !== 'center' && align !== 'right') {\r\n\t      throw new Error(\"simditor alignment button: invalid align \" + align);\r\n\t    }\r\n    \tvar nodes = this.selection.nodes().filter(htmlTag);\r\n\t    nodes.css({\r\n\t      'text-align': align === 'left' ? '' : align\r\n\t    });\r\n\t    this.trigger('valuechanged');\r\n\t    return this.inputManager.throttledSelectionChanged();\r\n\r\n\t},\r\n\r\n\tblockquote : function(disableTag) {\r\n\t    var $rootNodes, clearCache, nodeCache;\r\n\t    $rootNodes = this.selection.rootNodes();\r\n\t    $rootNodes = $rootNodes.filter(function(i, node) {\r\n\t      return !$(node).parent().is('blockquote');\r\n\t    });\r\n\t    this.selection.save();\r\n\t    nodeCache = [];\r\n\t    clearCache = function() {\r\n\t        if (nodeCache.length > 0) {\r\n\t          $(\"<blockquote/>\").insertBefore(nodeCache[0]).append(nodeCache);\r\n\t          return nodeCache.length = 0;\r\n\t        }\r\n\t    };\r\n\t    $rootNodes.each((function(_this) {\r\n\t      return function(i, node) {\r\n\t        var $node;\r\n\t        $node = $(node);\r\n\t        if (!$node.parent().is(_this.body)) {\r\n\t          return;\r\n\t        }\r\n\t        if ($node.is('blockquote')) {\r\n\t          clearCache();\r\n\t          return $node.children().unwrap();\r\n\t        } else if ($node.is(disableTag) || _this.util.isDecoratedNode($node)) {\r\n\t          return clearCache();\r\n\t        } else {\r\n\t          return nodeCache.push(node);\r\n\t        }\r\n\t      };\r\n\t    })(this));\r\n\t    clearCache();\r\n\t    this.selection.restore();\r\n\t    return this.trigger('valuechanged');\r\n\r\n\t},\r\n\r\n\tblockCode : function(htmlTag,disableTag) {\r\n\t    var $rootNodes, clearCache, nodeCache, resultNodes;\r\n\t    $rootNodes = this.selection.rootNodes();\r\n\t    nodeCache = [];\r\n\t    resultNodes = [];\r\n\t    clearCache = (function(_this) {\r\n\t      return function() {\r\n\t        var $pre;\r\n\t        if (!(nodeCache.length > 0)) {\r\n\t          return;\r\n\t        }\r\n\t        $pre = $(\"<\" + htmlTag + \"/>\").insertBefore(nodeCache[0]).text(_this.formatter.clearHtml(nodeCache));\r\n\t        resultNodes.push($pre[0]);\r\n\t        return nodeCache.length = 0;\r\n\t      };\r\n\t    })(this);\r\n\t    $rootNodes.each((function(_this) {\r\n\t      return function(i, node) {\r\n\t        var $node, $p;\r\n\t        $node = $(node);\r\n\t        if ($node.is(htmlTag)) {\r\n\t          clearCache();\r\n\t          $p = $('<p/>').append($node.html().replace('\\n', '<br/>')).replaceAll($node);\r\n\t          return resultNodes.push($p[0]);\r\n\t        } else if ($node.is(disableTag) || _this.util.isDecoratedNode($node) || $node.is('blockquote')) {\r\n\t          return clearCache();\r\n\t        } else {\r\n\t          return nodeCache.push(node);\r\n\t        }\r\n\t      };\r\n\t    })(this));\r\n\t    clearCache();\r\n\t    this.selection.setRangeAtEndOf($(resultNodes).last());\r\n\t    return this.trigger('valuechanged');\r\n\r\n\t},\r\n\r\n\tfontColor : function(hex,isDefault,coloredText) {\r\n        var range = this.selection.range();\r\n        if (!isDefault && range.collapsed) {\r\n          textNode = document.createTextNode(coloredText);\r\n          range.insertNode(textNode);\r\n          range.selectNodeContents(textNode);\r\n        }\r\n        this.selection.range(range);\r\n        document.execCommand('styleWithCSS', false, true);\r\n        document.execCommand('foreColor', false, hex);\r\n        document.execCommand('styleWithCSS', false, false);\r\n        if (!this.util.support.oninput) {\r\n          return this.trigger('valuechanged');\r\n        }\r\n\r\n\t},\r\n\r\n\tfontScale : function(param,sizeMap) {\r\n  \t\tif (!sizeMap){\r\n  \t\t\tsizeMap = {\r\n\t\t\t    'x-large': '1.5em',\r\n\t\t\t    'large': '1.25em',\r\n\t\t\t    'small': '.75em',\r\n\t\t\t    'x-small': '.5em'\r\n\t\t   };\r\n\t\t}\r\n\r\n\t    var $scales, containerNode, range;\r\n\t    range = this.selection.range();\r\n\t    if (range.collapsed) {\r\n\t      return;\r\n\t    }\r\n\t    this.selection.range(range);\r\n\t    document.execCommand('styleWithCSS', false, true);\r\n\t    document.execCommand('fontSize', false, param);\r\n\t    document.execCommand('styleWithCSS', false, false);\r\n\t    this.selection.reset();\r\n\t    this.selection.range();\r\n\t    containerNode = this.selection.containerNode();\r\n\t    if (containerNode[0].nodeType === Node.TEXT_NODE) {\r\n\t      $scales = containerNode.closest('span[style*=\"font-size\"]');\r\n\t    } else {\r\n\t      $scales = containerNode.find('span[style*=\"font-size\"]');\r\n\t    }\r\n\t    $scales.each((function(_this) {\r\n\t      return function(i, n) {\r\n\t        var $span, size;\r\n\t        $span = $(n);\r\n\t        size = n.style.fontSize;\r\n\t        if (/large|x-large|small|x-small/.test(size)) {\r\n\t          return $span.css('fontSize', sizeMap[size]);\r\n\t        } else if (size === 'medium') {\r\n\t          if ($span[0].style.length > 1) {\r\n\t            return $span.css('fontSize', '');\r\n\t          } else {\r\n\t            return $span.replaceWith($span.contents());\r\n\t          }\r\n\t        }\r\n\t      };\r\n\t    })(this));\r\n\t    return this.trigger('valuechanged');\r\n\t},\r\n\r\n\thr : function() {\r\n\t    var $hr, $newBlock, $nextBlock, $rootBlock;\r\n\t    $rootBlock = this.selection.rootNodes().first();\r\n\t    $nextBlock = $rootBlock.next();\r\n\t    if ($nextBlock.length > 0) {\r\n\t      this.selection.save();\r\n\t    } else {\r\n\t      $newBlock = $('<p/>').append(this.util.phBr);\r\n\t    }\r\n\t    $hr = $('<hr/>').insertAfter($rootBlock);\r\n\t    if ($newBlock) {\r\n\t      $newBlock.insertAfter($hr);\r\n\t      this.selection.setRangeAtStartOf($newBlock);\r\n\t    } else {\r\n\t      this.selection.restore();\r\n\t    }\r\n\t    return this.trigger('valuechanged');\r\n\t},\r\n\r\n\tinlineCode : function(active) {\r\n\t    var $code, $contents, range;\r\n\t    range = this.selection.range();\r\n\t    if (this.active) {\r\n\t      range.selectNodeContents(this.node[0]);\r\n\t      this.selection.save(range);\r\n\t      this.node.contents().unwrap();\r\n\t      this.selection.restore();\r\n\t    } else {\r\n\t      $contents = $(range.extractContents());\r\n\t      $code = $(\"<\" + this.htmlTag + \"/>\").append($contents.contents());\r\n\t      range.insertNode($code[0]);\r\n\t      range.selectNodeContents($code[0]);\r\n\t      this.selection.range(range);\r\n\t    }\r\n\t    return this.trigger('valuechanged');\r\n\r\n\t},\r\n\r\n\tindent : function() {\r\n\t    return this.indentation.indent();\r\n\t},\r\n\r\n\tlink : function(active,defaultLinkText) {\r\n\t    var $contents, $link, $newBlock, linkText, range, txtNode;\r\n\t    range = this.selection.range();\r\n\t    if (active) {\r\n\t\t  var node = this.selection.startNodes();\r\n\t      txtNode = document.createTextNode(node.text());\r\n\t      node.replaceWith(txtNode);\r\n\t      range.selectNode(txtNode);\r\n\t    } else {\r\n\t      $contents = $(range.extractContents());\r\n\t      linkText = this.formatter.clearHtml($contents.contents(), false);\r\n\t      $link = $('<a/>', {\r\n\t        href: '',\r\n\t        target: '_blank',\r\n\t        text: linkText || defaultLinkText\r\n\t      });\r\n\t      if (this.selection.blockNodes().length > 0) {\r\n\t        range.insertNode($link[0]);\r\n\t      } else {\r\n\t        $newBlock = $('<p/>').append($link);\r\n\t        range.insertNode($newBlock[0]);\r\n\t      }\r\n\t      range.selectNodeContents($link[0]);\r\n\t    }\r\n\t    this.selection.range(range);\r\n\t    return this.trigger('valuechanged');\r\n\r\n\t},\r\n\r\n\tlist : function(type,param,disableTag) {\r\n      var $list, $rootNodes, anotherType;\r\n      $rootNodes = this.selection.blockNodes();\r\n      anotherType = type === 'ul' ? 'ol' : 'ul';\r\n      this.selection.save();\r\n      $list = null;\r\n      $rootNodes.each((function(_this) {\r\n        return function(i, node) {\r\n          var $node;\r\n          $node = $(node);\r\n          if ($node.is('blockquote, li') || $node.is(disableTag) || _this.util.isDecoratedNode($node) || !noder.contains(document, node)) {\r\n            return;\r\n          }\r\n          if ($node.is(type)) {\r\n            $node.children('li').each(function(i, li) {\r\n              var $childList, $li;\r\n              $li = $(li);\r\n              $childList = $li.children('ul, ol').insertAfter($node);\r\n              return $('<p/>').append($(li).html() || _this.util.phBr).insertBefore($node);\r\n            });\r\n            return $node.remove();\r\n          } else if ($node.is(anotherType)) {\r\n            return $('<' + type + '/>').append($node.contents()).replaceAll($node);\r\n          } else if ($list && $node.prev().is($list)) {\r\n            $('<li/>').append($node.html() || _this.util.phBr).appendTo($list);\r\n            return $node.remove();\r\n          } else {\r\n            $list = $(\"<\" + type + \"><li></li></\" + type + \">\");\r\n            $list.find('li').append($node.html() || _this.util.phBr);\r\n            return $list.replaceAll($node);\r\n          }\r\n        };\r\n      })(this));\r\n      this.selection.restore();\r\n      return this.trigger('valuechanged');\r\n\r\n\t},\r\n\r\n\toutdent : function() {\r\n\t    return this.indentation.indent(true);\r\n\t},\r\n\r\n\t// toggle\r\n\ttitle : function(param,disableTag) {\r\n\t\tdocument.execCommand('formatBlock', false, param);\r\n\r\n\t\t/*\r\n\t    var $rootNodes;\r\n\t    $rootNodes = this.selection.rootNodes();\r\n\t    this.selection.save();\r\n\t    $rootNodes.each((function(_this) {\r\n\t      return function(i, node) {\r\n\t        var $node;\r\n\t        $node = $(node);\r\n\t        if ($node.is('blockquote') || $node.is(param) || $node.is(disableTag) || _this.util.isDecoratedNode($node)) {\r\n\t          return;\r\n\t        }\r\n\t        return $('<' + param + '/>').append($node.contents()).replaceAll($node);\r\n\t      };\r\n\t    })(this));\r\n\t    this.selection.restore();\r\n\t    */\r\n\t    return this.trigger('valuechanged');\r\n\r\n\t}\r\n\r\n\r\n\r\n  });\r\n\r\n\tvar commands =  [\r\n\t\t\"bold\", // toggle \r\n\t\t\"insertImage\",\r\n\t\t\"insertorderedlist\",\r\n\t\t\"insertunorderedlist\",\r\n\t\t\"italic\", // toggle\r\n\t\t\"justifyLeft\",\r\n\t\t\"justifyCenter\",\r\n\t\t\"justifyFull\",\r\n\t\t\"justifyRight\",\r\n\t\t\"strikethrough\",\r\n\t\t\"underline\",\r\n\t\t\"undo\"\r\n\t];\r\n\r\n\tcommands.forEach(function(cmd){\r\n\t\tEditable.prototype[cmd] = function() {\r\n\t      document.execCommand(cmd,false,null);\r\n\t      if (!this.util.support.oninput) {\r\n\t        this.trigger('valuechanged');\r\n\t      }\r\n\t      return $(document).trigger('selectionchange');\t\t\t\t\t\r\n\t\t};\r\n\t});\r\n\r\n\r\n\tfunction editable(el,opts) {\r\n\r\n\t\t/*\t\r\n\t\tif (value === undefined) {\r\n   \t\t\treturn node.contentEditable == \"true\"\r\n\t\t} else {\r\n\t\t\tif (!value) {\r\n\t\t\t\tvalue = null;\r\n\t\t\t} else {\r\n\t\t\t\tvalue = \"true\";\r\n\t\t\t}\r\n\t\t\tdatax.attr(node,\"contentEditable\",value);\r\n\t\t}\r\n\t\t*/\r\n\t\treturn new Editable(el,opts);\r\n\t\t\r\n\t};\r\n\r\n\r\n\treturn contents.Editable  = Editable;\r\n\t\r\n});"]}