{"version":3,"sources":["input-manager.js"],"names":["define","langx","$","contents","indexOf","InputManager","Evented","inherit","init","editable","opts","selectAllKey","submitKey","_this","this","extend","throttledValueChanged","util","throttle","params","setTimeout","trigger","throttledSelectionChanged","document","on","id","e","triggerEvent","focused","clipboard","pasting","_selectionTimer","clearTimeout","selection","_selection","rangeCount","$rootBlocks","lastCaretPosition","body","children","filter","i","node","isBlockNode","length","save","formatter","format","restore","find","classPrefix","each","el","$el","formatted","parent","is","next","append","phBr","insertAfter","prev","insertBefore","support","onselectionchange","proxy","_onKeyDown","_onKeyPress","_onKeyUp","_onMouseUp","_onFocus","_onBlur","_onDrop","_onInput","browser","firefox","hotkeys","add","preventDefault","modify","os","mac","$children","firstBlock","lastBlock","range","first","get","last","createRange","setStart","setEnd","getNodeLength","closest","click","pluginName","prototype","_modifierKeys","_arrowKeys","addClass","removeClass","$blockEl","getRangeAt","startContainer","undoManager","caretPosition","setRangeAtStartOf","console","log","ref","sync","currentState","caret","ref1","respondTo","keystroke","which","call","metaKey","oninput","p","isEmptyNode","empty","appendTo"],"mappings":"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","file":"../input-manager.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"./contents\"\r\n],function(langx,$,contents){ \r\n \r\n\r\n  var indexOf = [].indexOf ;\r\n\r\n  var InputManager = langx.Evented.inherit({\r\n    init : function(editable,opts) {\r\n      this.editable = editable;\r\n      this.opts = langx.extend({}, this.opts, opts);\r\n\r\n      var selectAllKey, submitKey;\r\n      this.throttledValueChanged = this.editable.util.throttle((function(_this) {\r\n        return function(params) {\r\n          return setTimeout(function() {\r\n            return _this.editable.trigger('valuechanged', params);\r\n          }, 10);\r\n        };\r\n      })(this), 300);\r\n      this.throttledSelectionChanged = this.editable.util.throttle((function(_this) {\r\n        return function() {\r\n          return _this.editable.trigger('selectionchanged');\r\n        };\r\n      })(this), 50);\r\n      $(document).on('selectionchange.simditor' + this.editable.id, (function(_this) {\r\n        return function(e) {\r\n          var triggerEvent;\r\n          if (!(_this.focused && !_this.editable.clipboard.pasting)) {\r\n            return;\r\n          }\r\n          triggerEvent = function() {\r\n            if (_this._selectionTimer) {\r\n              clearTimeout(_this._selectionTimer);\r\n              _this._selectionTimer = null;\r\n            }\r\n            if (_this.editable.selection._selection.rangeCount > 0) {\r\n              return _this.throttledSelectionChanged();\r\n            } else {\r\n              return _this._selectionTimer = setTimeout(function() {\r\n                _this._selectionTimer = null;\r\n                if (_this.focused) {\r\n                  return triggerEvent();\r\n                }\r\n              }, 10);\r\n            }\r\n          };\r\n          return triggerEvent();\r\n        };\r\n      })(this));\r\n      this.editable.on('valuechanged', (function(_this) {\r\n        return function() {\r\n          var $rootBlocks;\r\n          _this.lastCaretPosition = null;\r\n          $rootBlocks = _this.editable.body.children().filter(function(i, node) {\r\n            return _this.editable.util.isBlockNode(node);\r\n          });\r\n          if (_this.focused && $rootBlocks.length === 0) {\r\n            _this.editable.selection.save();\r\n            _this.editable.formatter.format();\r\n            _this.editable.selection.restore();\r\n          }\r\n          _this.editable.body.find('hr, pre, .' + _this.opts.classPrefix + 'table').each(function(i, el) {\r\n            var $el, formatted;\r\n            $el = $(el);\r\n            if ($el.parent().is('blockquote') || $el.parent()[0] === _this.editable.body[0]) {\r\n              formatted = false;\r\n              if ($el.next().length === 0) {\r\n                $('<p/>').append(_this.editable.util.phBr).insertAfter($el);\r\n                formatted = true;\r\n              }\r\n              if ($el.prev().length === 0) {\r\n                $('<p/>').append(_this.editable.util.phBr).insertBefore($el);\r\n                formatted = true;\r\n              }\r\n              if (formatted) {\r\n                return _this.throttledValueChanged();\r\n              }\r\n            }\r\n          });\r\n          _this.editable.body.find('pre:empty').append(_this.editable.util.phBr);\r\n          if (!_this.editable.util.support.onselectionchange && _this.focused) {\r\n            return _this.throttledSelectionChanged();\r\n          }\r\n        };\r\n      })(this));\r\n      this.editable.body.on('keydown', langx.proxy(this._onKeyDown, this)).on('keypress', langx.proxy(this._onKeyPress, this)).on('keyup', langx.proxy(this._onKeyUp, this)).on('mouseup', langx.proxy(this._onMouseUp, this)).on('focus', langx.proxy(this._onFocus, this)).on('blur', langx.proxy(this._onBlur, this)).on('drop', langx.proxy(this._onDrop, this)).on('input', langx.proxy(this._onInput, this));\r\n      if (this.editable.util.browser.firefox) {\r\n        this.editable.hotkeys.add('cmd+left', (function(_this) {\r\n          return function(e) {\r\n            e.preventDefault();\r\n            _this.editable.selection._selection.modify('move', 'backward', 'lineboundary');\r\n            return false;\r\n          };\r\n        })(this));\r\n        this.editable.hotkeys.add('cmd+right', (function(_this) {\r\n          return function(e) {\r\n            e.preventDefault();\r\n            _this.editable.selection._selection.modify('move', 'forward', 'lineboundary');\r\n            return false;\r\n          };\r\n        })(this));\r\n        selectAllKey = this.editable.util.os.mac ? 'cmd+a' : 'ctrl+a';\r\n        this.editable.hotkeys.add(selectAllKey, (function(_this) {\r\n          return function(e) {\r\n            var $children, firstBlock, lastBlock, range;\r\n            $children = _this.editable.body.children();\r\n            if (!($children.length > 0)) {\r\n              return;\r\n            }\r\n            firstBlock = $children.first().get(0);\r\n            lastBlock = $children.last().get(0);\r\n            range = document.createRange();\r\n            range.setStart(firstBlock, 0);\r\n            range.setEnd(lastBlock, _this.editable.util.getNodeLength(lastBlock));\r\n            _this.editable.selection.range(range);\r\n            return false;\r\n          };\r\n        })(this));\r\n      }\r\n      submitKey = this.editable.util.os.mac ? 'cmd+enter' : 'ctrl+enter';\r\n      this.editable.hotkeys.add(submitKey, (function(_this) {\r\n        return function(e) {\r\n          _this.editable.$el.closest('form').find('button:submit').click();\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n\r\n  });\r\n\r\n  InputManager.pluginName = 'InputManager';\r\n\r\n  InputManager.prototype._modifierKeys = [16, 17, 18, 91, 93, 224];\r\n\r\n  InputManager.prototype._arrowKeys = [37, 38, 39, 40];\r\n\r\n\r\n  InputManager.prototype._onFocus = function(e) {\r\n    if (this.editable.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editable.$el.addClass('focus').removeClass('error');\r\n    this.focused = true;\r\n    return setTimeout((function(_this) {\r\n      return function() {\r\n        var $blockEl, range;\r\n        range = _this.editable.selection._selection.getRangeAt(0);\r\n        if (range.startContainer === _this.editable.body[0]) {\r\n          if (_this.lastCaretPosition) {\r\n            _this.editable.undoManager.caretPosition(_this.lastCaretPosition);\r\n          } else {\r\n            $blockEl = _this.editable.body.children().first();\r\n            range = document.createRange();\r\n            _this.editable.selection.setRangeAtStartOf($blockEl, range);\r\n            console.log(\"aaaaaa\");\r\n          }\r\n        }\r\n        _this.lastCaretPosition = null;\r\n        _this.editable.trigger('focus');\r\n        if (!_this.editable.util.support.onselectionchange) {\r\n          return _this.throttledSelectionChanged();\r\n        }\r\n      };\r\n    })(this), 0);\r\n  };\r\n\r\n  InputManager.prototype._onBlur = function(e) {\r\n    var ref;\r\n    if (this.editable.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editable.$el.removeClass('focus');\r\n    this.editable.sync();\r\n    this.focused = false;\r\n    this.lastCaretPosition = (ref = this.editable.undoManager.currentState()) != null ? ref.caret : void 0;\r\n    return this.editable.trigger('blur');\r\n  };\r\n\r\n  InputManager.prototype._onMouseUp = function(e) {\r\n    if (!this.editable.util.support.onselectionchange) {\r\n      return this.throttledSelectionChanged();\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyDown = function(e) {\r\n    var ref, ref1;\r\n    if (this.editable.trigger(e) === false) {\r\n      return false;\r\n    }\r\n    if (this.editable.hotkeys.respondTo(e)) {\r\n      return;\r\n    }\r\n    if (this.editable.keystroke.respondTo(e)) {\r\n      this.throttledValueChanged();\r\n      return false;\r\n    }\r\n    if ((ref = e.which, indexOf.call(this._modifierKeys, ref) >= 0) || (ref1 = e.which, indexOf.call(this._arrowKeys, ref1) >= 0)) {\r\n      return;\r\n    }\r\n    if (this.editable.util.metaKey(e) && e.which === 86) {\r\n      return;\r\n    }\r\n    if (!this.editable.util.support.oninput) {\r\n      this.throttledValueChanged(['typing']);\r\n    }\r\n    return null;\r\n  };\r\n\r\n  InputManager.prototype._onKeyPress = function(e) {\r\n    if (this.editable.trigger(e) === false) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyUp = function(e) {\r\n    var p, ref;\r\n    if (this.editable.trigger(e) === false) {\r\n      return false;\r\n    }\r\n    if (!this.editable.util.support.onselectionchange && (ref = e.which, indexOf.call(this._arrowKeys, ref) >= 0)) {\r\n      this.throttledValueChanged();\r\n      return;\r\n    }\r\n    if ((e.which === 8 || e.which === 46) && this.editable.util.isEmptyNode(this.editable.body)) {\r\n      this.editable.body.empty();\r\n      p = $('<p/>').append(this.editable.util.phBr).appendTo(this.editable.body);\r\n      this.editable.selection.setRangeAtStartOf(p);\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onDrop = function(e) {\r\n    if (this.editable.trigger(e) === false) {\r\n      return false;\r\n    }\r\n    return this.throttledValueChanged();\r\n  };\r\n\r\n  InputManager.prototype._onInput = function(e) {\r\n    return this.throttledValueChanged(['oninput']);\r\n  };\r\n\r\n  return contents.InputManager = InputManager;\r\n\r\n});\r\n"]}