/**
 * skylark-domx-plugins-menus - The skylark menu plugin library.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx/skylark-domx-plugins-menus/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-devices-keyboard/keys","skylark-domx-noder","skylark-domx-styler","skylark-domx-query","skylark-domx-lists","skylark-domx-plugins-base","skylark-domx-plugins-popups/popups","./menus","./menu"],function(t,e,s,i,n,a,o,l,c,h){"use strict";var r=h.inherit({klassName:"PopupMenu",pluginName:"lark.menus.popup",delay:300,options:{icons:{submenu:"ui-icon-caret-1-e"},position:{my:"left top",at:"right top"},role:"menu",item:{classes:{base:"menu-item",active:"active",disabled:"disabled",wrapper:"menu-item-wrapper"},selector:"> *"},blur:null,focus:null,select:null},_construct:function(t,e){h.prototype._construct.call(this,t,e),this.element=this.$(),this.activeMenu=this.element,this.mouseHandled=!1,this.lastMousePosition={x:null,y:null},this.element.attr({role:this.options.role,tabIndex:0}),this.listenTo(this.element,{mousedown:function(t){t.preventDefault(),this._activateItem(t)},click:function(t){var e=n(t.target),i=n(s.active());!this.mouseHandled&&e.not(`.${this.options.item.classes.disable}`).length&&(this.select(t),t.isPropagationStopped()||(this.mouseHandled=!0),e.has(`.${this.options.submenu.classes.base}`).length?this.expand(t):!this.element.is(":focus")&&i.closest(`.${this.options.submenu.classes.base}`).length&&(this.element.trigger("focus",[!0]),this.active&&1===this.active.parents(`.${this.options.submenu.classes.base}`).length&&clearTimeout(this.timer)))},mouseenter:"_activateItem",mousemove:"_activateItem"},`.${this.options.item.classes.base}`),this.listenTo(this.element,{mouseleave:"collapseAll",focus:function(t,e){var s=this.active||this._menuItems().first();e||this.focus(t,s)},blur:function(t){this._delay(function(){!s.contains(this.element[0],s.active())&&this.collapseAll(t)})},keydown:"_keydown"}),this.listenTo(this.element,"mouseleave",`.${this.options.submenu.classes.base}`,"collapseAll"),this.listenTo(n(document),{click:function(t){this._closeOnDocumentClick(t)&&this.collapseAll(t,!0),this.mouseHandled=!1}})},_activateItem:function(t){if(!this.previousFilter&&(t.clientX!==this.lastMousePosition.x||t.clientY!==this.lastMousePosition.y)){this.lastMousePosition={x:t.clientX,y:t.clientY};var e=n(t.target).closest(`.${this.options.item.classes.base}`),s=n(t.currentTarget);e[0]===s[0]&&(s.is(`.${this.options.item.classes.active}`)||(s.siblings().children(`.${this.options.item.classes.active}`).removeClass(this.options.item.classes.active),this.focus(t,s)))}},_keydown:function(t){var s,i,n,a,o=!0;switch(t.keyCode){case e.PAGE_UP:this.previousPage(t);break;case e.PAGE_DOWN:this.nextPage(t);break;case e.HOME:this._move("first","first",t);break;case e.END:this._move("last","last",t);break;case e.UP:this.previous(t);break;case e.DOWN:this.next(t);break;case e.LEFT:this.collapse(t);break;case e.RIGHT:this.active&&!this.active.is(`.${this.options.item.classes.disabled}`)&&this.expand(t);break;case e.ENTER:case e.SPACE:this._activate(t);break;case e.ESC:this.collapse(t);break;default:o=!1,i=this.previousFilter||"",a=!1,n=t.keyCode>=96&&t.keyCode<=105?(t.keyCode-96).toString():String.fromCharCode(t.keyCode),clearTimeout(this.filterTimer),n===i?a=!0:n=i+n,s=this._filterMenuItems(n),(s=a&&-1!==s.index(this.active.next())?this.active.nextAll(`.${this.options.item.classes.base}`):s).length||(n=String.fromCharCode(t.keyCode),s=this._filterMenuItems(n)),s.length?(this.focus(t,s),this.previousFilter=n,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}o&&t.preventDefault()},_activate:function(t){this.active&&!this.active.is(`.${this.options.item.classes.disabled}`)&&(this.active.children("[aria-haspopup='true']").length?this.expand(t):this.select(t))},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},focus:function(t,e){var s,i;this.blur(t,t&&"focus"===t.type),this._scrollIntoView(e),this.active=e.first(),(i=this.active.children(`.${this.options.item.classes.wrapper}`)).addClass(this.options.item.classes.active),this.options.role&&this.element.attr("aria-activedescendant",i.attr("id")),this.active.parent().closest(`.${this.options.item.classes.base}`).children(`.${this.options.item.classes.wrapper}`).addClass(this.options.item.classes.active),t&&"keydown"===t.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),(s=e.children(`.${this.options.submenu.classes.base}`)).length&&t&&/^mouse/.test(t.type)&&this._startOpening(s),this.activeMenu=e.parent(),this.trigger("focus",{item:e})},_scrollIntoView:function(t){var e,s,n,a,o,l;this._hasScroll()&&(e=parseFloat(i.css(this.activeMenu[0],"borderTopWidth"))||0,s=parseFloat(i.css(this.activeMenu[0],"paddingTop"))||0,n=t.offset().top-this.activeMenu.offset().top-e-s,a=this.activeMenu.scrollTop(),o=this.activeMenu.height(),l=t.outerHeight(),n<0?this.activeMenu.scrollTop(a+n):n+l>o&&this.activeMenu.scrollTop(a+n-o+l))},blur:function(t,e){e||clearTimeout(this.timer),this.active&&(this.active.children(`.${this.options.item.classes.wrapper}`).removeClass(this.options.item.classes.active),this.trigger("blur",{item:this.active}),this.active=null)},_startOpening:function(t){clearTimeout(this.timer),this.timer=this._delay(function(){this._close(),this._open(t)},this.delay)},_open:function(e){var s=t.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(`.${this.options.submenu.classes.base}`).not(e.parents(`.${this.options.submenu.classes.base}`)).hide().attr("aria-hidden","true"),l.open(e.attr("aria-expanded","true"),{position:s})},collapseAll:function(t,e){clearTimeout(this.timer),this.timer=this._delay(function(){var s=e?this.element:n(t&&t.target).closest(this.element.find(`.${this.options.submenu.classes.base}`));s.length||(s=this.element),this._close(s),this.blur(t),s.find(`.${this.options.item.classes.active}`).removeClass(this.options.item.classes.active),this.activeMenu=s},e?0:this.delay)},_close:function(t){t||(t=this.active?this.active.parent():this.element),l.close(t.find(`.${this.options.submenu.classes.base}`).attr("aria-expanded","false"))},_closeOnDocumentClick:function(t){return!n(t.target).closest(`.${this.options.submenu.classes.base}`).length},_isDivider:function(t){return!/[^\-\u2014\u2013\s]/.test(t.text())},collapse:function(t){var e=this.active&&this.active.parent().closest(`.${this.options.item.classes.base}`,this.element);e&&e.length&&(this._close(),this.focus(t,e))},expand:function(t){var e=this.active&&this._menuItems(this.active.children(`.${this.options.submenu.classes.base}`)).first();e&&e.length&&(this._open(e.parent()),this._delay(function(){this.focus(t,e)}))},next:function(t){this._move("next","first",t)},previous:function(t){this._move("prev","last",t)},isFirstItem:function(){return this.active&&!this.active.prevAll(`.${this.options.item.classes.base}`).length},isLastItem:function(){return this.active&&!this.active.nextAll(`.${this.options.item.classes.base}`).length},_menuItems:function(t){return(t||this.element).find(this.options.items).filter(`.${this.options.item.classes.base}`)},_move:function(t,e,s){var i;this.active&&(i="first"===t||"last"===t?this.active["first"===t?"prevAll":"nextAll"](`.${this.options.item.classes.base}`).last():this.active[t+"All"](`.${this.options.item.classes.base}`).first()),i&&i.length&&this.active||(i=this._menuItems(this.activeMenu)[e]()),this.focus(s,i)},nextPage:function(t){var e,s,i;this.active?this.isLastItem()||(this._hasScroll()?(s=this.active.offset().top,i=this.element.height(),this.active.nextAll(`.${this.options.item.classes.base}`).each(function(){return(e=n(this)).offset().top-s-i<0}),this.focus(t,e)):this.focus(t,this._menuItems(this.activeMenu)[this.active?"last":"first"]())):this.next(t)},previousPage:function(t){var e,s,i;this.active?this.isFirstItem()||(this._hasScroll()?(s=this.active.offset().top,i=this.element.height(),this.active.prevAll(`.${this.options.item.classes.base}`).each(function(){return(e=n(this)).offset().top-s+i>0}),this.focus(t,e)):this.focus(t,this._menuItems(this.activeMenu).first())):this.next(t)},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(t){this.active=this.active||n(t.target).closest(`.${this.options.item.classes.base}`);var e={item:this.active};this.active.has(`.${this.options.submenu.classes.base}`).length||this.collapseAll(t,!0),this.trigger("select",e)},_filterMenuItems:function(e){var s=e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),i=new RegExp("^"+s,"i");return this.activeMenu.find(this.options.items).filter(`.${this.options.item.classes.base}`).filter(function(){return i.test(t.trim(n(this).children(`.${this.options.item.classes.wrapper}`).text()))})}});return o.register(r),c.PopupMenu=r});
//# sourceMappingURL=sourcemaps/popup-menu.js.map
