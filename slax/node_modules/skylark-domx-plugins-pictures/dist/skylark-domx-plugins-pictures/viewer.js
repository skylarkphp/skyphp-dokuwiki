/**
 * skylark-domx-plugins-pictures - The skylark picture plugin library for dom api extension.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx-plugins/skylark-domx-plugins-pictures/
 * @license MIT
 */
define(["skylark-langx","skylark-domx/eventer","skylark-domx/geom","skylark-domx/query","skylark-domx-images/preload","skylark-domx-plugins-base","skylark-domx-plugins-interact/movable","./pictures"],function(t,i,s,h,a,o,g,n){"use strict";var r=o.Plugin.inherit({klassName:"PictureViewer",pluginName:"lark.pictures.pictureviewer",options:{ratioThreshold:.1,minRatio:.05,maxRatio:16,movable:!0,classes:{grab:null,loader:null}},_construct:function(t,e){o.Plugin.prototype._construct.call(this,t,e),this.$stage=this.$(),this.$image=this.$stage.find("img"),this.$stage.off("wheel").on("wheel",t=>{this._handleWheel(t)}),this.options.movable&&(this._movable=new g(this.$image[0],{starting:t=>{const i=this.$image.width(),e=this.$image.height(),s=this.$stage.width(),h=this.$stage.height();let a,o,g,n;return!(s>=i&&h>=e)&&(s>=i?a=g=(s-i)/2:(a=s-i,g=0),h>=e?o=n=(h-e)/2:(o=h-e,n=0),{constraints:{minX:a,maxX:g,minY:o,maxY:n}})},started:function(t){i.stop(t)}}))},getImageScaleToStage:function(t,i){let e=1;return e=this.isRotated?Math.min(t/this.img.height,i/this.img.width,1):Math.min(t/this.img.width,i/this.img.height,1)},setGrabCursor:function(t,i,e){const s=e?t.h:t.w,h=e?t.w:t.h;(h>i.h||s>i.w)&&this.$stage.addClass("is-grab"),h<=i.h&&s<=i.w&&this.$stage.removeClass("is-grab")},setImageSize:function(i){const e={w:this.$stage.width(),h:this.$stage.height()},s=this.getImageScaleToStage(e.w,e.h);this.$image.css({width:Math.ceil(i.width*s)+"px",height:Math.ceil(i.height*s)+"px",left:(e.w-Math.ceil(i.width*s))/2+"px",top:(e.h-Math.ceil(i.height*s))/2+"px"}),t.mixin(this.imageData,{initWidth:i.width*s,initHeight:i.height*s,initLeft:(e.w-i.width*s)/2,initTop:(e.h-i.height*s)/2,width:i.width*s,height:i.height*s,left:(e.w-i.width*s)/2,top:(e.h-i.height*s)/2}),this.setGrabCursor({w:this.$image.width(),h:this.$image.height()},{w:this.$stage.width(),h:this.$stage.height()},this.isRotated),this.imageLoaded||(this.$stage.find(".${ this.options.classes.loader }").remove(),this.$stage.removeClass("stage-ready"),this.$image.removeClass("image-ready"),this.options.initAnimation&&!this.options.progressiveLoading&&this.$image.fadeIn(),this.imageLoaded=!0)},loadImage:function(t,i,e){this.$image.removeAttr("style").attr("src",""),this.isRotated=!1,this.rotateAngle=0,this.imageLoaded=!1,this.$stage.append(`<div class="${this.options.classes.loader}"></div>`),this.$stage.addClass("stage-ready"),this.$image.addClass("image-ready"),this.options.initAnimation&&!this.options.progressiveLoading&&this.$image.hide(),this.$image.attr("src",t),a(t).then(t=>{var e=t.imgs[0];this.img=e,this.imageData={originalWidth:e.width,originalHeight:e.height},i&&i(e)},()=>{this.$photoviewer.find(".${ this.options.classes.loader }").remove(),e&&e.call()})},_handleWheel:function(t){t.preventDefault();let i=1;t.deltaY?i=t.deltaY>0?1:-1:t.wheelDelta?i=-t.wheelDelta/120:t.detail&&(i=t.detail>0?1:-1);const e=-i*this.options.ratioThreshold,h={x:t.clientX-this.$stage.offset().left+s.scrollLeft(document.body),y:t.clientY-this.$stage.offset().top+s.scrollTop(document.body)};this.zoom(e,h,t)},zoom:function(t,i,e){t=t<0?1/(1-t):1+t,(t=this.$image.width()/this.imageData.originalWidth*t)>this.options.maxRatio||t<this.options.minRatio||this.zoomTo(t,i,e)},zoomTo:function(t,i,e){const s=this.$image,a=this.$stage,o=this.imageData.width,g=this.imageData.height,n=this.imageData.left,r=this.imageData.top,d={w:a.width(),h:a.height(),x:a.offset().left,y:a.offset().top},l=this.imageData.originalWidth*t,m=this.imageData.originalHeight*t;let c=i.x-(i.x-n)/o*l,w=i.y-(i.y-r)/g*m;const $=this.isRotated?(l-m)/2:0,p=this.isRotated?m:l,u=this.isRotated?l:m,f=d.w-l,x=d.h-m;w=u<=d.h?(d.h-m)/2:w>$?$:w>x-$?w:x-$,c=p<=d.w?(d.w-l)/2:c>-$?-$:c>f+$?c:f+$,Math.abs(this.imageData.initWidth-l)<.05*this.imageData.initWidth?this.setImageSize(this.img):(s.css({width:Math.round(l)+"px",height:Math.round(m)+"px",left:Math.round(c)+"px",top:Math.round(w)+"px"}),this.setGrabCursor({w:Math.round(p),h:Math.round(u)},{w:d.w,h:d.h})),h.extend(this.imageData,{width:l,height:m,left:c,top:w})},rotate:function(t){this.rotateAngle=this.rotateAngle+t,this.rotateAngle/90%2==0?this.isRotated=!1:this.isRotated=!0,this.rotateTo(this.rotateAngle)},rotateTo:function(t){this.$image.css({transform:"rotate("+t+"deg)"}),this.setImageSize({width:this.imageData.originalWidth,height:this.imageData.originalHeight}),this.$stage.removeClass("is-grab")},resize:function(){const t=this.$image.width(),i=this.$image.height(),e=(this.$stage.width()-t)/2,s=(this.$stage.height()-i)/2;this.$image.css({left:e,top:s})},shortcut:function(t,i,s){var h=!1;switch(t){case 187:this.zoom(3*this.options.ratioThreshold,{x:this.$stage.width()/2,y:this.$stage.height()/2},e),h=!0;break;case 189:this.zoom(3*-this.options.ratioThreshold,{x:this.$stage.width()/2,y:this.$stage.height()/2},e),h=!0;break;case 61:this.zoom(3*this.options.ratioThreshold,{x:this.$stage.width()/2,y:this.$stage.height()/2},e),h=!0;break;case 173:this.zoom(3*-this.options.ratioThreshold,{x:this.$stage.width()/2,y:this.$stage.height()/2},e),h=!0;break;case 48:i&&s&&this.zoomTo(1,{x:this.$stage.width()/2,y:this.$stage.height()/2},e),h=!0;break;case 188:i&&this.rotate(-90);break;case 190:i&&this.rotate(90),h=!0}return h}});return n.PictureViewer=r});
//# sourceMappingURL=sourcemaps/viewer.js.map
