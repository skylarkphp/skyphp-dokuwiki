/**
 * skylark-domx-plugins-uploads - The file upload plugin library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.1
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(e,t){var i=t.define,require=t.require,s="function"==typeof i&&i.amd,n=!s&&"undefined"!=typeof exports;if(!s&&!i){var o={};i=t.define=function(e,t,i){"function"==typeof i?(o[e]={factory:i,deps:t.map(function(t){return function(e,t){if("."!==e[0])return e;var i=t.split("/"),s=e.split("/");i.pop();for(var n=0;n<s.length;n++)"."!=s[n]&&(".."==s[n]?i.pop():i.push(s[n]));return i.join("/")}(t,e)}),resolved:!1,exports:null},require(e)):o[e]={factory:null,resolved:!0,exports:i}},require=t.require=function(e){if(!o.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var module=o[e];if(!module.resolved){var i=[];module.deps.forEach(function(e){i.push(require(e))}),module.exports=module.factory.apply(t,i)||null,module.resolved=!0}return module.exports}}if(!i)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,require){e("skylark-domx-plugins-uploads/uploads",["skylark-domx-plugins-base/plugins","skylark-domx-files/dropzone","skylark-domx-files/pastezone","skylark-domx-files/picker"],function(e){var t=function(){return t};return e.uploads=t}),e("skylark-langx-async/deferred",["skylark-langx-arrays","skylark-langx-funcs","skylark-langx-objects"],function(e,t,i){"use strict";var s=Array.prototype.slice,n=t.proxy,o=e.makeArray,r=i.result,a=i.mixin;a(Promise.prototype,{always:function(e){return this.then(e,e),this},done:function(){for(var e=0;e<arguments.length;e++)this.then(arguments[e]);return this},fail:function(e){return this.catch(e),this}});var l=function(){var e=this;this.promise=d(new Promise(function(t,i){e._resolve=t,e._reject=i}))};function d(e){if(e.isResolved)return e;var t=!0,i=!1,s=!1,n=e.then(function(e){return s=!0,t=!1,e},function(e){throw i=!0,t=!1,e});n.isResolved=function(){return s},n.isPending=function(){return t},n.isRejected=function(){return i},n.state=function(){return s?"resolved":i?"rejected":"pending"};var o=[],r=[];return n.then=function(e,t,i){return i&&this.progress(i),d(Promise.prototype.then.call(this,e&&function(t){return t&&void 0!==t.__ctx__?e.apply(t.__ctx__,t):e(t)},t&&function(e){return e&&void 0!==e.__ctx__?t.apply(e.__ctx__,e):t(e)}))},n.progress=function(e){return o.forEach(function(t){e(t)}),r.push(e),this},n.pipe=n.then,n.notify=function(e){try{return o.push(e),r.forEach(function(t){return t(e)})}catch(e){this.reject(e)}return this},n}return l.prototype.resolve=function(e){var t=s.call(arguments);return this.resolveWith(null,t)},l.prototype.resolveWith=function(e,t){return(t=t?o(t):[]).__ctx__=e,this._resolve(t),this._resolved=!0,this},l.prototype.notify=function(e){var t=r(this,"promise");return t.notify(e),this},l.prototype.reject=function(e){var t=s.call(arguments);return this.rejectWith(null,t)},l.prototype.rejectWith=function(e,t){return(t=t?o(t):[]).__ctx__=e,this._reject(t),this._rejected=!0,this},l.prototype.isResolved=function(){var e=r(this,"promise");return e.isResolved()},l.prototype.isRejected=function(){var e=r(this,"promise");return e.isRejected()},l.prototype.state=function(){var e=r(this,"promise");return e.state()},l.prototype.then=function(e,t,i){var s=r(this,"promise");return s.then(e,t,i)},l.prototype.progress=function(e){var t=r(this,"promise");return t.progress(e)},l.prototype.catch=function(e){var t=r(this,"promise");return t.catch(e)},l.prototype.always=function(){var e=r(this,"promise");return e.always.apply(e,arguments),this},l.prototype.done=function(){var e=r(this,"promise");return e.done.apply(e,arguments),this},l.prototype.fail=function(e){var t=r(this,"promise");return t.fail(e),this},l.all=function(e){var t=new l;return Promise.all(e).then(t.resolve.bind(t),t.reject.bind(t)),r(t,"promise")},l.first=function(e){return d(Promise.race(e))},l.when=function(e,t,i,s){var o=e&&"function"==typeof e.then,r=o&&e instanceof Promise;if(!o)return arguments.length>1?t?t(e):e:(new l).resolve(e);if(!r){var a=new l(e.cancel);e.then(n(a.resolve,a),n(a.reject,a),a.notify),e=a.promise}return t||i||s?e.then(t,i,s):e},l.reject=function(e){var t=new l;return t.reject(e),t.promise},l.immediate=l.resolve=function(e){var t=new l;return t.resolve.apply(t,arguments),t.promise},l.promise=function(e){var t=new l;return e(t.resolve.bind(t),t.reject.bind(t),t.progress.bind(t)),t.promise},l}),e("skylark-domx-plugins-uploads/single-uploader",["skylark-langx-emitter","skylark-langx-async/deferred","skylark-domx-velm","skylark-domx-plugins-base","./uploads"],function(e,t,i,s,n){return n.SingleUploader=class extends s.Plugin{get klassName(){return"SingleUploader"}get pluginName(){return"lark.uploads.single"}get options(){return{selectors:{picker:".file-picker",dropzone:".file-dropzone",pastezone:".file-pastezone",startUploads:".start-uploads",cancelUploads:".cancel-uploads"}}}constructor(e,t){super(e,t),this._velm=i(this._elm),this._initFileHandlers()}_initFileHandlers(){var e=this,t=this.options.selectors,i=t.dropzone,s=t.pastezone,n=t.picker;i&&this._velm.$(i).dropzone({dropped:function(t){e._addFile(t[0])}}),s&&this._velm.$(s).pastezone({pasted:function(t){e._addFile(t[0])}}),n&&this._velm.$(n).picker({multiple:!0,picked:function(t){e._addFile(t[0])}})}_addFile(e){this.emit("added",e)}destroy(){}}}),e("skylark-net-http/upload",["skylark-langx-types","skylark-langx-objects","skylark-langx-arrays","skylark-langx-async/Deferred","skylark-langx-emitter/Evented","./Xhr","./http"],function(e,t,i,s,n,o,r){var a=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice,l=n.inherit({klassName:"Upload",_construct:function(e){this._options=t.mixin({debug:!1,url:"/upload",headers:{},maxConnections:999,maxChunkSize:void 0,onProgress:function(e,t,i,s){},onComplete:function(e,t,i,s,n){},onCancel:function(e,t){},onFailure:function(e,t,i){}},e),this._queue=[],this._params=[],this._files=[],this._xhrs=[],this._loaded=[]},add:function(e){return this._files.push(e)-1},send:function(e,i){if(this._files[e]&&!(this._queue.indexOf(e)>-1)){var s=this._queue.push(e),n=t.clone(i);this._params[e]=n,s<=this._options.maxConnections&&this._send(e,this._params[e])}},sendAll:function(e){for(var t=0;t<this._files.length;t++)this.send(t,e)},cancel:function(e){this._cancel(e),this._dequeue(e)},cancelAll:function(){for(var e=0;e<this._queue.length;e++)this._cancel(this._queue[e]);this._queue=[]},getName:function(e){var t=this._files[e];return null!=t.fileName?t.fileName:t.name},getSize:function(e){var t=this._files[e];return null!=t.fileSize?t.fileSize:t.size},getLoaded:function(e){return this._loaded[e]||0},_send:function(e,i){var s,n=this._options,r=this.getName(e),l=this.getSize(e),d=n.maxChunkSize||0,u=0,c=this._files[e],p={headers:t.clone(n.headers)};this._loaded[e]=this._loaded[e]||0;var h=this._xhrs[e]=new o({url:n.url});if(d)p.data=a.call(c,this._loaded[e],this._loaded[e]+d,c.type),s=p.data.size,p.headers["content-range"]="bytes "+this._loaded[e]+"-"+(this._loaded[e]+s-1)+"/"+l,p.headers["Content-Type"]="application/octet-stream";else{s=l;var f=i.formParamName,m=i.formData;f?(m||(m=new FormData),m.append(f,c),p.data=m):(p.headers["Content-Type"]=c.type||"application/octet-stream",p.data=c)}var _=this;h.post(p).progress(function(t){t.lengthComputable&&(u+=t.loaded,_._loaded[e]=_._loaded[e]+t.loaded,_._options.onProgress(e,r,_._loaded[e],l))}).then(function(t,n,o){_._files[e]&&(u<s&&(_._loaded[e]=_._loaded[e]+s-u,_._options.onProgress(e,r,_._loaded[e],l)),_._loaded[e]<l?_._send(e,i):(_._options.onComplete(e,r,t,n,o),_._files[e]=null,_._xhrs[e]=null,_._dequeue(e)))}).catch(function(t){_._options.onFailure(e,r,t),_._files[e]=null,_._xhrs[e]=null,_._dequeue(e)})},_cancel:function(e){this._options.onCancel(e,this.getName(e)),this._files[e]=null,this._xhrs[e]&&(this._xhrs[e].abort(),this._xhrs[e]=null)},getQueue:function(){return this._queue},_dequeue:function(e){var t=i.inArray(e,this._queue);this._queue.splice(t,1);var s=this._options.maxConnections;if(this._queue.length>=s&&t<s){var n=this._queue[s-1];this._send(n,this._params[n])}}});return l.send=function(e,t){var i=new l(t),s=i.add(e);return i.send(s,t)},l.sendAll=function(e,t){for(var i=new l(t),s=0,n=e.length;s<n;s++)this.add(file[s]);return i.send(t)},r.Upload=l}),e("skylark-domx-plugins-uploads/multi-uploader",["skylark-langx/skylark","skylark-langx/langx","skylark-domx-query","skylark-domx-velm","skylark-net-http/upload","skylark-domx-plugins-base","./uploads"],function(e,t,i,s,n,o,r){var a=o.Plugin.inherit({klassName:"MultiUploader",pluginName:"lark.uploads.multi",options:{uploadUrl:"/upload",params:{formParamName:"file"},maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,autoUpload:!1,selectors:{fileList:".file-list",fileItem:".file-item",nodata:".file-list .no-data",picker:".file-picker",dropzone:".file-dropzone",pastezone:".file-pastezone",startUploads:".start-uploads",cancelUploads:".cancel-uploads"},template:'<div class="lark-multiuploader">    <h3 class="popover-title">Upload files</h3>    <div class="popover-content container-fluid" class="file-list file-dropzone file-pastezone">        <div class="no-data"><em>Add files.</em></div>    </div>    <footer>        <button class="btn btn-warning pull-right btn-sm" id="cancel-uploads-button"><i class="icon-cancel"></i>Cancel uploads</button>        <span class="btn btn-success fileinput-button btn-sm" id="fileinput-button">            <i class="icon-plus"></i>            <span>Add files...</span>            <input id="fileupload" type="file" name="files[]" multiple="multiple">        </span>        <button class="btn btn-primary btn-sm" id="start-uploads-button"><i class="icon-start"></i>Start uploads</button>    </footer></div>',dataType:"json",fileItem:{selectors:{name:".name",size:".size",cancel:".cancel",clear:".clear",progress:".progress",message:".message"},template:'<div class="file-item row">   <div class="col-md-6"><span class="name"></span></div>   <div class="col-md-3">    <span class="size"></span>    <div class="progress hidden">        <div class="progress-label"></div>        <div class="bar"></div>    </div>    <span class="message hidden"></span>   </div>   <div class="col-md-3">    <button class="btn btn-warning btn-xs cancel"><i class="icon-remove"></i>Cancel</button>    <button class="btn btn-xs clear hidden">Clear</button>   </div></div>'}},_construct:function(e,t){this.overrided(e,t),this._velm=s(this._elm),this._initEventHandler(),this._initFileHandlers(),this._initUpoadHandler(),this._updateFileList()},_initFileHandlers:function(){var e=this,t=this.options.selectors,i=t.dropzone,s=t.pastezone,n=t.picker;i&&this._velm.$(i).dropzone({dropped:function(t){e._addFiles(t)}}),s&&this._velm.$(s).pastezone({pasted:function(t){e._addFiles(t)}}),n&&this._velm.$(n).picker({multiple:!0,picked:function(t){e._addFiles(t)}})},_initUpoadHandler:function(){var e=this;this._handler=new n({url:this.options.uploadUrl,maxConnections:this.options.maxConnections,onProgress:function(t,i,s,n){e._onProgress(t,i,s,n)},onComplete:function(t,i,s){e._onComplete(t,i,s)},onCancel:function(t,i){e._onCancel(t,i)},onFailure:function(t,i,s){e._onFailure(t,i,s)}})},_initEventHandler:function(){var e=this,t=this.options.selectors,s=this.options.fileItem.selectors;this._listElement;this._velm.$(t.fileList).on("click",s.cancel,function(s){var n=i(this).closest(t.fileItem),o=n.data("fileId");e._handler.cancel(o),n.remove(),e._updateFileList()}),this._velm.$(t.fileList).on("click",s.clear,function(s){var n=i(this).closest(t.fileItem);n.data("fileId");n.remove(),e._updateFileList()}),this._velm.$(t.cancelUploads).click(function(){var s=e._velm.$(t.fileList).find(t.fileItem);s.forEach(function(t){var s=i(t),n=s.data("fileId");e._handler.cancel(n),s.remove()}),e._updateFileList()}),this._velm.$(t.startUploads).click(function(){var s=e._velm.$(t.fileList).find(t.fileItem);s.forEach(function(t){var s=i(t),n=s.data("fileId");s.data("status")||e._handler.send(n,e.options.params)})})},_onProgress:function(e,t,i,s){var n=this._getItemByFileId(e),o=parseInt(i/s*100,10),r=this._formatSize(i)+" of "+this._formatSize(s);n.data("status","running"),n.find(".progress").find(".bar").css("width",o+"%").parent().find(".progress-label").html(r),this._updateFile(n)},_onComplete:function(e,t,i){this._filesInProgress--;var s=this._getItemByFileId(e);s.data("status","done"),s.find(".message").html('<i class="icon-success"></i> '+(this.doneMsg||"Uploaded")),this._updateFile(s)},_onFailure:function(e,t,i){this._filesInProgress--;var s=this._getItemByFileId(e);s.data("status","error"),s.find(".message").html('<i class="icon-error"></i> '),this._updateFile(s)},_onCancel:function(e,t){this._filesInProgress--;var i=this._getItemByFileId(e);i.data("status","cancel"),this._updateFile(i)},_addToList:function(e,t){var t=this._handler.getName(e),s=this._handler.getSize(e),n=i(this.options.fileItem.template);n.data("fileId",e),n.find(this.options.fileItem.selectors.name).html(this._formatFileName(t)),n.find(this.options.fileItem.selectors.size).html(this._formatSize(s)),this._velm.$(this.options.selectors.fileList).append(n),this._updateFileList()},_updateFileList:function(){var e=this.options.selectors,t=(this.options.fileItem.selectors,this._velm.$(e.fileList).find(e.fileItem)),i=this._velm.$(e.cancelUploads+","+e.startUploads),s=this._velm.$(e.nodata);t.length>0?(i.removeClass("hidden"),s.addClass("hidden")):(i.addClass("hidden"),s.removeClass("hidden"))},_updateFile:function(e){var t=this.options.fileItem.selectors,i=e.find(t.size+","+t.cancel),s=e.find(t.progress+","+t.cancel),n=e.find(t.message+","+t.clear),o=e.data("status");"pending"==o?(s.add(n).addClass("hidden"),i.removeClass("hidden")):"running"==o?(i.add(n).addClass("hidden"),s.removeClass("hidden")):"done"!=o&&"error"!=o||(i.add(s).addClass("hidden"),n.removeClass("hidden"))},_getItemByFileId:function(e){for(var t,s=this.options.selectors,n=this._velm.$(s.fileList).find(s.fileItem),o=0;o<n.length;o++){var r=n[o];if(i(r).data("fileId")==e){t=r;break}}if(t)return i(t)},_addFiles:function(e){for(var t=0;t<e.length;t++)if(!this._validateFile(e[t]))return;for(var t=0;t<e.length;t++)this._addFile(e[t])},_addFile:function(e){var t=this._handler.add(e);this._filesInProgress++,this._addToList(t)},_validateFile:function(e){var t,i;return e.value?t=e.value.replace(/.*(\/|\\)/,""):(t=null!=e.fileName?e.fileName:e.name,i=null!=e.fileSize?e.fileSize:e.size),this._isAllowedExtension(t)?0===i?(this._error("emptyError",t),!1):i&&this.options.sizeLimit&&i>this.options.sizeLimit?(this._error("sizeError",t),!1):!(i&&i<this.options.minSizeLimit)||(this._error("minSizeError",t),!1):(this._error("typeError",t),!1)},_error:function(e,t){var i=this.options.messages[e];function s(e,t){i=i.replace(e,t)}s("{file}",this._formatFileName(t)),s("{extensions}",this.options.allowedExtensions.join(", ")),s("{sizeLimit}",this._formatSize(this.options.sizeLimit)),s("{minSizeLimit}",this._formatSize(this.options.minSizeLimit)),this.options.showMessage(i)},_formatFileName:function(e){return e.length>33&&(e=e.slice(0,19)+"..."+e.slice(-13)),e},_isAllowedExtension:function(e){var t=-1!==e.indexOf(".")?e.replace(/.*[.]/,"").toLowerCase():"",i=this.options.allowedExtensions;if(!i.length)return!0;for(var s=0;s<i.length;s++)if(i[s].toLowerCase()==t)return!0;return!1},_formatSize:function(e){var t=-1;do{e/=1024,t++}while(e>99);return Math.max(e,.1).toFixed(1)+["KB","MB","GB","TB","PB","EB"][t]}});return o.register(a),r.MultiUploader=a}),e("skylark-domx-plugins-uploads/main",["./uploads","./single-uploader","./multi-uploader"],function(e){return e}),e("skylark-domx-plugins-uploads",["skylark-domx-plugins-uploads/main"],function(e){return e})}(i),!s){var r=require("skylark-langx-ns");n?module.exports=r:t.skylarkjs=r}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-domx-plugins-uploads.js.map
