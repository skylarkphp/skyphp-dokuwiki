/**
 * skylark-domx-plugins-uploads - The file upload plugin library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.1
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-domx-query","skylark-domx-velm","skylark-net-http/Upload","skylark-domx-plugins-base","./uploads"],function(e,i,t,s,n,l,a){var o=l.Plugin.inherit({klassName:"MultiUploader",pluginName:"lark.uploads.multi",options:{uploadUrl:"/upload",params:{formParamName:"file"},maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,autoUpload:!1,selectors:{fileList:".file-list",fileItem:".file-item",nodata:".file-list .no-data",picker:".file-picker",dropzone:".file-dropzone",pastezone:".file-pastezone",startUploads:".start-uploads",cancelUploads:".cancel-uploads"},template:'<div class="lark-multiuploader">    <h3 class="popover-title">Upload files</h3>    <div class="popover-content container-fluid" class="file-list file-dropzone file-pastezone">        <div class="no-data"><em>Add files.</em></div>    </div>    <footer>        <button class="btn btn-warning pull-right btn-sm" id="cancel-uploads-button"><i class="icon-cancel"></i>Cancel uploads</button>        <span class="btn btn-success fileinput-button btn-sm" id="fileinput-button">            <i class="icon-plus"></i>            <span>Add files...</span>            <input id="fileupload" type="file" name="files[]" multiple="multiple">        </span>        <button class="btn btn-primary btn-sm" id="start-uploads-button"><i class="icon-start"></i>Start uploads</button>    </footer></div>',dataType:"json",fileItem:{selectors:{name:".name",size:".size",cancel:".cancel",clear:".clear",progress:".progress",message:".message"},template:'<div class="file-item row">   <div class="col-md-6"><span class="name"></span></div>   <div class="col-md-3">    <span class="size"></span>    <div class="progress hidden">        <div class="progress-label"></div>        <div class="bar"></div>    </div>    <span class="message hidden"></span>   </div>   <div class="col-md-3">    <button class="btn btn-warning btn-xs cancel"><i class="icon-remove"></i>Cancel</button>    <button class="btn btn-xs clear hidden">Clear</button>   </div></div>'}},_construct:function(e,i){this.overrided(e,i),this._velm=s(this._elm),this._initEventHandler(),this._initFileHandlers(),this._initUpoadHandler(),this._updateFileList()},_initFileHandlers:function(){var e=this,i=this.options.selectors,t=i.dropzone,s=i.pastezone,n=i.picker;t&&this._velm.$(t).dropzone({dropped:function(i){e._addFiles(i)}}),s&&this._velm.$(s).pastezone({pasted:function(i){e._addFiles(i)}}),n&&this._velm.$(n).picker({multiple:!0,picked:function(i){e._addFiles(i)}})},_initUpoadHandler:function(){var e=this;this._handler=new n({url:this.options.uploadUrl,maxConnections:this.options.maxConnections,onProgress:function(i,t,s,n){e._onProgress(i,t,s,n)},onComplete:function(i,t,s){e._onComplete(i,t,s)},onCancel:function(i,t){e._onCancel(i,t)},onFailure:function(i,t,s){e._onFailure(i,t,s)}})},_initEventHandler:function(){var e=this,i=this.options.selectors,s=this.options.fileItem.selectors;this._listElement;this._velm.$(i.fileList).on("click",s.cancel,function(s){var n=t(this).closest(i.fileItem),l=n.data("fileId");e._handler.cancel(l),n.remove(),e._updateFileList()}),this._velm.$(i.fileList).on("click",s.clear,function(s){var n=t(this).closest(i.fileItem);n.data("fileId");n.remove(),e._updateFileList()}),this._velm.$(i.cancelUploads).click(function(){e._velm.$(i.fileList).find(i.fileItem).forEach(function(i){var s=t(i),n=s.data("fileId");e._handler.cancel(n),s.remove()}),e._updateFileList()}),this._velm.$(i.startUploads).click(function(){e._velm.$(i.fileList).find(i.fileItem).forEach(function(i){var s=t(i),n=s.data("fileId");s.data("status")||e._handler.send(n,e.options.params)})})},_onProgress:function(e,i,t,s){var n=this._getItemByFileId(e),l=parseInt(t/s*100,10),a=this._formatSize(t)+" of "+this._formatSize(s);n.data("status","running"),n.find(".progress").find(".bar").css("width",l+"%").parent().find(".progress-label").html(a),this._updateFile(n)},_onComplete:function(e,i,t){this._filesInProgress--;var s=this._getItemByFileId(e);s.data("status","done"),s.find(".message").html('<i class="icon-success"></i> '+(this.doneMsg||"Uploaded")),this._updateFile(s)},_onFailure:function(e,i,t){this._filesInProgress--;var s=this._getItemByFileId(e);s.data("status","error"),s.find(".message").html('<i class="icon-error"></i> '),this._updateFile(s)},_onCancel:function(e,i){this._filesInProgress--;var t=this._getItemByFileId(e);t.data("status","cancel"),this._updateFile(t)},_addToList:function(e,i){i=this._handler.getName(e);var s=this._handler.getSize(e),n=t(this.options.fileItem.template);n.data("fileId",e),n.find(this.options.fileItem.selectors.name).html(this._formatFileName(i)),n.find(this.options.fileItem.selectors.size).html(this._formatSize(s)),this._velm.$(this.options.selectors.fileList).append(n),this._updateFileList()},_updateFileList:function(){var e=this.options.selectors,i=(this.options.fileItem.selectors,this._velm.$(e.fileList).find(e.fileItem)),t=this._velm.$(e.cancelUploads+","+e.startUploads),s=this._velm.$(e.nodata);i.length>0?(t.removeClass("hidden"),s.addClass("hidden")):(t.addClass("hidden"),s.removeClass("hidden"))},_updateFile:function(e){var i=this.options.fileItem.selectors,t=e.find(i.size+","+i.cancel),s=e.find(i.progress+","+i.cancel),n=e.find(i.message+","+i.clear),l=e.data("status");"pending"==l?(s.add(n).addClass("hidden"),t.removeClass("hidden")):"running"==l?(t.add(n).addClass("hidden"),s.removeClass("hidden")):"done"!=l&&"error"!=l||(t.add(s).addClass("hidden"),n.removeClass("hidden"))},_getItemByFileId:function(e){for(var i,s=this.options.selectors,n=this._velm.$(s.fileList).find(s.fileItem),l=0;l<n.length;l++){var a=n[l];if(t(a).data("fileId")==e){i=a;break}}if(i)return t(i)},_addFiles:function(e){for(var i=0;i<e.length;i++)if(!this._validateFile(e[i]))return;for(i=0;i<e.length;i++)this._addFile(e[i])},_addFile:function(e){var i=this._handler.add(e);this._filesInProgress++,this._addToList(i)},_validateFile:function(e){var i,t;return e.value?i=e.value.replace(/.*(\/|\\)/,""):(i=null!=e.fileName?e.fileName:e.name,t=null!=e.fileSize?e.fileSize:e.size),this._isAllowedExtension(i)?0===t?(this._error("emptyError",i),!1):t&&this.options.sizeLimit&&t>this.options.sizeLimit?(this._error("sizeError",i),!1):!(t&&t<this.options.minSizeLimit)||(this._error("minSizeError",i),!1):(this._error("typeError",i),!1)},_error:function(e,i){var t=this.options.messages[e];function s(e,i){t=t.replace(e,i)}s("{file}",this._formatFileName(i)),s("{extensions}",this.options.allowedExtensions.join(", ")),s("{sizeLimit}",this._formatSize(this.options.sizeLimit)),s("{minSizeLimit}",this._formatSize(this.options.minSizeLimit)),this.options.showMessage(t)},_formatFileName:function(e){return e.length>33&&(e=e.slice(0,19)+"..."+e.slice(-13)),e},_isAllowedExtension:function(e){var i=-1!==e.indexOf(".")?e.replace(/.*[.]/,"").toLowerCase():"",t=this.options.allowedExtensions;if(!t.length)return!0;for(var s=0;s<t.length;s++)if(t[s].toLowerCase()==i)return!0;return!1},_formatSize:function(e){var i=-1;do{e/=1024,i++}while(e>99);return Math.max(e,.1).toFixed(1)+["KB","MB","GB","TB","PB","EB"][i]}});return l.register(o),a.MultiUploader=o});
//# sourceMappingURL=sourcemaps/multi-uploader.js.map
