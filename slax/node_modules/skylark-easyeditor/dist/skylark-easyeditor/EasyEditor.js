/**
 * skylark-easyeditor - The skylark markdown editor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-easyeditor/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-domx-browser","skylark-domx-noder","skylark-domx-eventer","skylark-domx-finder","skylark-domx-data","skylark-domx-query","skylark-domx-plugins"],function(t,e,n,i,a,o,l,r,s){"use strict";var c=s.Plugin.inherit({klassName:"EasyEditor",_construct:function(t,e){this.elem=t,e=e||{},this.className=e.className||"easyeditor";this.buttons=e.buttons||["bold","italic","link","h2","h3","h4","alignleft","aligncenter","alignright"],this.buttonsHtml=e.buttonsHtml||null,this.overwriteButtonSettings=e.overwriteButtonSettings||null,this.css=e.css||null,this.onLoaded="function"==typeof e.onLoaded?e.onLoaded:null,this.randomString="cls"+Math.random().toString(36).substring(7),this.theme=e.theme||null,this.dropdown=e.dropdown||{},this.characterLimit=e.characterLimit||null,this.characterLimitText=e.characterLimitText||null,this.characterLimitPreventKeypress=e.characterLimitPreventKeypress||!1,this.attachEvents()},attachEvents:function(){this.bootstrap(),this.addToolbar(),this.handleKeypress(),this.handleResizeImage(),this.utils(),null!==this.onLoaded&&this.onLoaded.call(this,this),this.characterLimit&&this.enableCharacterLimit()},detachEvents:function(){r(this.elem).closest("."+this.className+"-wrapper").find("."+this.className+"-toolbar").remove(),r(this.elem).removeClass(this.className).removeAttr("contenteditable").unwrap()},bootstrap:function(){var t=r(this.elem).prop("tagName").toLowerCase();if("textarea"===t||"input"===t){var e=r(this.elem).attr("placeholder")||"",n=r(this.elem).css("marginTop")||0,i=r(this.elem).css("marginBottom")||0,a="";(n.length>0||i.length>0)&&(a=' style="margin-top: '+n+"; margin-bottom: "+i+'" '),r(this.elem).after('<div id="'+this.randomString+'-editor" placeholder="'+e+'">'+r(this.elem).val()+"</div>"),r(this.elem).hide().addClass(this.randomString+"-bind"),this.elem=document.getElementById(this.randomString+"-editor"),r(this.elem).attr("contentEditable",!0).addClass(this.className).wrap('<div class="'+this.className+'-wrapper"'+a+"></div>")}else r(this.elem).attr("contentEditable",!0).addClass(this.className).wrap('<div class="'+this.className+'-wrapper"></div>');this.$wrapperElem=r(this.elem).parent(),null!==this.css&&r(this.elem).css(this.css),this.containerClass="."+this.className+"-wrapper","string"==typeof this.elem&&(this.elem=r(this.elem).get(0)),null!==this.theme&&r(this.elem).closest(this.containerClass).addClass(this.theme)},handleKeypress:function(){var t=this;r(t.elem).keydown(function(e){if(13===e.keyCode&&!1===t.isSelectionInsideElement("li"))return e.preventDefault(),!0===e.shiftKey?document.execCommand("insertHTML",!1,"<br>"):document.execCommand("insertHTML",!1,"<br><br>"),!1}),t.elem.addEventListener("paste",function(t){t.preventDefault();var e=t.clipboardData.getData("text/plain").replace(/\n/gi,"<br>");document.execCommand("insertHTML",!1,e)})},isSelectionInsideElement:function(t){var e,n;for(t=t.toUpperCase(),window.getSelection?(e=window.getSelection()).rangeCount>0&&(n=e.getRangeAt(0).commonAncestorContainer):(e=document.selection)&&"Control"!=e.type&&(n=e.createRange().parentElement());n;){if(1==n.nodeType&&n.tagName==t)return!0;n=n.parentNode}return!1},addToolbar:function(){r(this.elem).before('<div class="'+this.className+'-toolbar"><ul></ul></div>'),this.$toolbarContainer=this.$wrapperElem.find("."+this.className+"-toolbar"),this.populateButtons()},injectButton:function(t){var n,i=this;if(null!==i.overwriteButtonSettings&&void 0!==i.overwriteButtonSettings[t.buttonIdentifier]){var a=e.extend({},t,i.overwriteButtonSettings[t.buttonIdentifier]);t=a}if(null!==i.buttonsHtml&&void 0!==i.buttonsHtml[t.buttonIdentifier]&&(t.buttonHtml=i.buttonsHtml[t.buttonIdentifier]),n=t.buttonTitle?t.buttonTitle:t.buttonIdentifier.replace(/\W/g," "),t.buttonHtml)if(void 0!==t.childOf){var o=i.$toolbarContainer.find(".toolbar-"+t.childOf).parent("li");0===o.find("ul").length&&o.append("<ul></ul>"),(o=o.find("ul")).append('<li><button type="button" class="toolbar-'+t.buttonIdentifier+'" title="'+n+'">'+t.buttonHtml+"</button></li>")}else i.$toolbarContainer.children("ul").append('<li><button type="button" class="toolbar-'+t.buttonIdentifier+'" title="'+n+'">'+t.buttonHtml+"</button></li>");"function"==typeof t.clickHandler&&r(i.elem).closest(i.containerClass).on("click",".toolbar-"+t.buttonIdentifier,function(e){void 0!==typeof t.hasChild&&!0===t.hasChild?e.stopPropagation():e.preventDefault(),t.clickHandler.call(this,this),r(i.elem).trigger("keyup")})},openDropdownOf:function(t){r(this.elem).closest(this.containerClass).find(".toolbar-"+t).parent().children("ul").show()},populateButtons:function(){var t=this;e.each(t.buttons,function(e,n){"function"==typeof t[n]&&t[n]()})},handleResizeImage:function(){var t=this;r("html").on("click",t.containerClass+" figure",function(t){t.stopPropagation(),r(this).addClass("is-resizable")}),r("html").on("mousemove",t.containerClass+" figure.is-resizable",function(t){r(this).find("img").css({width:r(this).width()+"px"})}),r(document).click(function(){r(t.elem).find("figure").removeClass("is-resizable")})},getSelection:function(){if(window.getSelection){var t=window.getSelection();if(t.rangeCount)return t}return!1},removeFormatting:function(t){var n=t.inFullArea;if(!0===this.isSelectionOutsideOfEditor())return!1;if(!1===n){var i=this.getSelection(),a=i.toString();if(i&&a.length>0){var o=i.getRangeAt(0),l=r(o.commonAncestorContainer.parentNode);if(l.attr("class")===this.className||l.attr("class")===this.className+"-wrapper"){var s=document.createElement("span");r(s).attr("data-value","temp").html(a.replace(/\n/gi,"<br>")),o.deleteContents(),o.insertNode(s),r('[data-value="temp"]').contents().unwrap()}else{var c,m=!1;e.each(l.parentsUntil(this.elem),function(t,e){c=e,m=!0}),!0===m?r(c).html(r(c).text().replace(/\n/gi,"<br>")).contents().unwrap():l.contents().unwrap()}}}else r(this.elem).html(r(this.elem).text().replace(/\n/gi,"<br>"))},removeEmptyTags:function(){r(this.elem).html(r(this.elem).html().replace(/(<(?!\/)[^>]+>)+(<\/[^>]+>)+/,""))},removeBlockElementFromSelection:function(t,e){var n="";!0===(e=void 0!==e&&e)&&(n=", br");var i=t.getRangeAt(0).cloneContents(),a=document.createElement("temp");return r(a).html(i),r(a).find("h1, h2, h3, h4, h5, h6, p, div"+n).each(function(){r(this).replaceWith(this.childNodes)}),r(a).html()},wrapSelectionWithNodeName:function(t){if(!0===this.isSelectionOutsideOfEditor())return!1;var e={name:"span",blockElement:!1,style:null,class:null,attribute:null,keepHtml:!1};"string"==typeof t?e.name=t:(e.name=t.nodeName||e.name,e.blockElement=t.blockElement||e.blockElement,e.style=t.style||e.style,e.class=t.class||e.class,e.attribute=t.attribute||e.attribute,e.keepHtml=t.keepHtml||e.keepHtml);var n=this.getSelection();if(n&&n.toString().length>0&&n.rangeCount){var i=this.isAlreadyWrapped(n,e),a=n.getRangeAt(0).cloneRange(),o=document.createElement(e.name);if(null===e.style&&null===e.class&&null===e.attribute||(o=this.addAttribute(o,e)),this.selectionContainsHtml(a)){if(a=n.getRangeAt(0),!0===e.keepHtml){var l=a.cloneContents(),s=document.createElement("div");s.appendChild(l),r(o).html(s.innerHTML)}else o.textContent=n.toString();a.deleteContents(),a.insertNode(o),a.commonAncestorContainer.localName===e.name&&(r(a.commonAncestorContainer).contents().unwrap(),this.removeEmptyTags())}else a.surroundContents(o),n.removeAllRanges(),n.addRange(a);!0===i&&this.removeWrappedDuplicateTag(o),this.removeEmptyTags(),n.removeAllRanges()}},wrapSelectionWithList:function(t){if(t=t||"ul",!0===this.isSelectionOutsideOfEditor())return!1;var n=this.getSelection();if(n&&n.toString().length>0&&n.rangeCount){var i=this.removeBlockElementFromSelection(n,!0).split("\n").filter(function(t){return""!==t}),a=e.map(i,function(t){return"<li>"+e.trim(t)+"</li>"}),o=document.createElement(t);r(o).html(a);var l=n.getRangeAt(0);l.deleteContents(),l.insertNode(o),n.removeAllRanges()}},selectionContainsHtml:function(t){return t.startContainer.parentNode.className!==this.className+"-wrapper"},isAlreadyWrapped:function(t,n){var i=t.getRangeAt(0),a=r(i.commonAncestorContainer),o=!1;return a.parent().prop("tagName").toLowerCase()===n.name&&!1===a.parent().hasClass(this.className)?o=!0:!0===n.blockElement?e.each(a.parentsUntil(this.elem),function(t,n){var i=n.tagName.toLowerCase();-1!==e.inArray(i,["h1","h2","h3","h4","h5","h6"])&&(o=!0)}):e.each(a.parentsUntil(this.elem),function(t,e){e.tagName.toLowerCase()===n.name&&(o=!0)}),o},removeWrappedDuplicateTag:function(t){var e=t.tagName;r(t).unwrap(),r(t).prop("tagName")===e&&!1===r(t).parent().hasClass(this.className)&&r(t).parent().hasClass(this.className+"-wrapper")&&r(t).unwrap()},addAttribute:function(t,n){return null!==n.style&&r(t).attr("style",n.style),null!==n.class&&r(t).addClass(n.class),null!==n.attribute&&(!0===e.isArray(n.attribute)?(!0!==e.isArray(n.attribute[0])&&(n.attribute[0]=[n.attribute[0],n.attribute[1]]),e.each(n.attribute,function(e,n){r(t).attr(n[0],n[1])})):r(t).attr(n.attribute)),t},insertAtCaret:function(t){if(!0===this.isSelectionOutsideOfEditor())return!1;this.getSelection()?this.getSelection().getRangeAt(0).insertNode(t):r(t).appendTo(this.elem)},isSelectionOutsideOfEditor:function(){return!this.elementContainsSelection(this.elem)},isActive:function(){return this.elementContainsSelection(this.elem)},readonly:function(t){return void 0===t?r(this.elem).attr("contentEditable"):(r(this.elem).attr("contentEditable",t&&!0),this)},isOrContains:function(t,e){for(;t;){if(t===e)return!0;t=t.parentNode}return!1},elementContainsSelection:function(t){var e;if(window.getSelection){if((e=window.getSelection()).rangeCount>0){for(var n=0;n<e.rangeCount;++n)if(!this.isOrContains(e.getRangeAt(n).commonAncestorContainer,t))return!1;return!0}}else if((e=document.selection)&&"Control"!==e.type)return this.isOrContains(e.createRange().parentElement(),t);return!1},insertHtml:function(t){r(this.elem).find("temp").html(t)},utils:function(){var t,e=this;(r("html").on("click","."+e.className+"-modal-close",function(t){t.preventDefault(),e.closeModal("#"+r(this).closest("."+e.className+"-modal").attr("id"))}),r("."+e.randomString+"-bind").length>0)&&r("html").on("click keyup",e.elem,function(){var n=e.elem;clearTimeout(t),t=setTimeout(function(){r("."+e.randomString+"-bind").html(r(n).html())},250)});r(document).click(function(t){r("."+e.className).closest("."+e.className+"-wrapper").find("."+e.className+"-toolbar > ul > li > ul").hide()})},getValue:function(){var t=r(this.elem).html(),e=r(this.elem).text();return{html:t,plainText:e,characterCount:e.length,wordCount:e.trim().split(/\s+/).length}},enableCharacterLimit:function(){var t=this,e=t.characterLimit-t.getValue().characterCount;r(t.elem).after('<div class="'+t.className+"-character-remaining "+(e<=0?"is-invalid":"is-valid")+'">'+(t.characterLimitText?t.characterLimitText+" "+e:e)+"</div>"),r("html").on("keyup",t.elem,function(){var e=t.getValue(),n=t.characterLimit-e.characterCount,i=r(t.containerClass).find('[class*="-character-remaining"]');t.characterLimitText?i.text(t.characterLimitText+" "+n):i.text(n),n<=0?i.removeClass("is-valid").addClass("is-invalid"):i.removeClass("is-invalid").addClass("is-valid")}),r("html").on("keypress",t.elem,function(){var e=t.getValue();if(t.characterLimitPreventKeypress&&t.characterLimit<=e.characterCount)return!1})},getYoutubeVideoIdFromUrl:function(t){if(0===t.length)return!1;return void 0!==(t=t.replace(/(>|<)/gi,"").split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/))[2]?t[2].split(/[^0-9a-z_\-]/i)[0]:t},openModal:function(t){var e=document.createElement("temp");e.textContent=".",this.insertAtCaret(e),r(t).removeClass("is-hidden")},closeModal:function(t){r(t).addClass("is-hidden").find("input").val(""),r(t).find("."+this.className+"-modal-content-body-loader").css("width","0");var e=r(this.elem).find("temp");"."===e.html()?e.remove():e.contents().unwrap(),r(this.elem).focus()},bold:function(){var t=this,e={buttonIdentifier:"bold",buttonHtml:"B",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"strong",keepHtml:!0})}};t.injectButton(e)},italic:function(){var t=this,e={buttonIdentifier:"italic",buttonHtml:"I",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"em",keepHtml:!0})}};t.injectButton(e)},h2:function(){var t=this,e={buttonIdentifier:"header-2",buttonHtml:"H2",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"h2",blockElement:!0})}};t.injectButton(e)},h3:function(){var t=this,e={buttonIdentifier:"header-3",buttonHtml:"H3",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"h3",blockElement:!0})}};t.injectButton(e)},h4:function(){var t=this,e={buttonIdentifier:"header-4",buttonHtml:"H4",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"h4",blockElement:!0})}};t.injectButton(e)},x:function(){var t=this,e={buttonIdentifier:"remove-formatting",buttonHtml:"x",clickHandler:function(){t.removeFormatting({inFullArea:!1})}};t.injectButton(e)},alignleft:function(){var t=this,e={buttonIdentifier:"align-left",buttonHtml:"Align left",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"p",style:"text-align: left",class:"text-left",keepHtml:!0})}};t.injectButton(e)},aligncenter:function(){var t=this,e={buttonIdentifier:"align-center",buttonHtml:"Align center",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"p",style:"text-align: center",class:"text-center",keepHtml:!0})}};t.injectButton(e)},alignright:function(){var t=this,e={buttonIdentifier:"align-right",buttonHtml:"Align right",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"p",style:"text-align: right",class:"text-right",keepHtml:!0})}};t.injectButton(e)},quote:function(){var t=this,e={buttonIdentifier:"quote",buttonHtml:"Quote",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"blockquote"})}};t.injectButton(e)},code:function(){var t=this,e={buttonIdentifier:"code",buttonHtml:"Code",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"pre"})}};t.injectButton(e)},link:function(){var t=this,e={buttonIdentifier:"link",buttonHtml:"Link",clickHandler:function(){t.wrapSelectionWithNodeName({nodeName:"a",attribute:["href",prompt("Insert link","")]})}};t.injectButton(e)},list:function(){var t=this,e={buttonIdentifier:"list",buttonHtml:"List",clickHandler:function(){t.wrapSelectionWithList()}};t.injectButton(e)},source:function(){var t=this,e={buttonIdentifier:"source",buttonHtml:"Source",clickHandler:function(e){var n,i=r(e).closest("."+t.className+"-wrapper").find("."+t.className);r(e).hasClass("is-view-source-mode")?(n=r("body > textarea."+t.className+"-temp"),i.css("visibility","visible"),n.remove(),r(e).removeClass("is-view-source-mode")):(r("body").append('<textarea class="'+t.className+'-temp" style="position: absolute; margin: 0;"></textarea>'),(n=r("body > textarea."+t.className+"-temp")).css({top:i.offset().top,left:i.offset().left,width:i.outerWidth(),height:i.outerHeight()}).html(i.html()),void 0!==i.css("border")&&n.css("border",i.css("border")),i.css("visibility","hidden"),r(e).addClass("is-view-source-mode"),n.on("keyup click change keypress",function(){i.html(r(this).val())}))}};t.injectButton(e)}});return r.fn.easyEditor=function(t){return this.each(function(){l.data(this,"plugin_easyEditor")||l.data(this,"plugin_easyEditor",new c(this,t))})},c});
//# sourceMappingURL=sourcemaps/EasyEditor.js.map
