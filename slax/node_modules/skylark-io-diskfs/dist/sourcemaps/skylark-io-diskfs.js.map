{"version":3,"sources":["skylark-io-diskfs.js"],"names":["define","skylark","diskfs","attach","types","downlad","data","name","window","navigator","msSaveBlob","isString","dataURItoBlob","a","document","createElement","Blob","URL","createObjectURL","href","setAttribute","click","Deferred","read","readFile","file","params","d","reader","FileReader","onload","evt","resolve","target","result","onerror","e","code","error","alert","asArrayBuffer","readAsArrayBuffer","asDataUrl","readAsDataURL","asText","readAsText","promise","readImage","fileObj","img","Image","reject","then","dataUrl","src","catch","fileInput","maxFileSize","select","directory","multiple","accept","title","fileSelected","picked","input","type","style","position","left","top","opacity","body","appendChild","selectFiles","pickedFiles","i","length","size","splice","onchange","entries","webkitEntries","webentry","all","files","Array","prototype","slice","call","value","webkitdirectory","arrays","concat","one","entry","path","onError","isFile","relativePath","isDirectory","dirReader","createReader","readEntries","map","apply","arguments","main"],"mappings":"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","file":"../skylark-io-diskfs.js","sourcesContent":["define('skylark-io-diskfs/diskfs',[\r\n    \"skylark-langx/skylark\"\r\n], function(skylark) {\r\n\r\n    function dataURLtoBlob(dataurl) {\r\n        var arr = dataurl.split(','),\r\n            mime = arr[0].match(/:(.*?);/)[1],\r\n            bstr = atob(arr[1]),\r\n            n = bstr.length,\r\n            u8arr = new Uint8Array(n);\r\n        while (n--) {\r\n            u8arr[n] = bstr.charCodeAt(n);\r\n        }\r\n        return new Blob([u8arr], { type: mime });\r\n    }\r\n\r\n\r\n    var diskfs = function() {\r\n        return diskfs;\r\n    };\r\n\r\n    return skylark.attach(\"storages.diskfs\", diskfs);\r\n});\ndefine('skylark-io-diskfs/download',[\r\n    \"skylark-langx/types\",\r\n    \"./diskfs\"\r\n],function(types,diskfs){\r\n\r\n    function downloadFile(data, name) {\r\n        if (window.navigator.msSaveBlob) {\r\n            if (types.isString(data)) {\r\n                data = dataURItoBlob(data);\r\n            }\r\n            window.navigator.msSaveBlob(data, name);\r\n        } else {\r\n            var a = document.createElement('a');\r\n            if (data instanceof Blob) {\r\n                data = URL.createObjectURL(data);\r\n            }\r\n            a.href = data;\r\n            a.setAttribute('download', name || 'noname');\r\n            //a.dispatchEvent(new CustomEvent('click'));\r\n            a.click();\r\n        }\r\n    }\r\n\r\n    return diskfs.downlad = downloadFile;\r\n\r\n});\r\n\ndefine('skylark-io-diskfs/read',[\r\n    \"skylark-langx-async/Deferred\",\r\n    \"./diskfs\"\r\n],function(Deferred, diskfs){\r\n\r\n    function readFile(file, params) {\r\n        params = params || {};\r\n        var d = new Deferred,\r\n            reader = new FileReader();\r\n\r\n        reader.onload = function(evt) {\r\n            d.resolve(evt.target.result);\r\n        };\r\n        reader.onerror = function(e) {\r\n            var code = e.target.error.code;\r\n            if (code === 2) {\r\n                alert('please don\\'t open this page using protocol fill:///');\r\n            } else {\r\n                alert('error code: ' + code);\r\n            }\r\n        };\r\n\r\n        if (params.asArrayBuffer) {\r\n            reader.readAsArrayBuffer(file);\r\n        } else if (params.asDataUrl) {\r\n            reader.readAsDataURL(file);\r\n        } else if (params.asText) {\r\n            reader.readAsText(file);\r\n        } else {\r\n            reader.readAsArrayBuffer(file);\r\n        }\r\n\r\n        return d.promise;\r\n    }\r\n\r\n    return diskfs.read = diskfs.readFile = readFile;\r\n    \r\n});\r\n\ndefine('skylark-io-diskfs/readImage',[\r\n    \"skylark-langx/Deferred\",\r\n    \"./diskfs\",\r\n    \"./read\"\r\n],function(Deferred, diskfs,read){\r\n\r\n\tfunction readImage(fileObj) {\r\n        var d = new Deferred,\r\n\t    \timg = new Image();\r\n\r\n\t    img.onload = function() {\r\n\t      d.resolve(img);\r\n\t    };\r\n\t    img.onerror = function(e) {\r\n\t      d.reject(e);\r\n\t    };\r\n\r\n\t    read(fileObj,{\r\n\t    \tasDataUrl : true\r\n\t    }).then(function(dataUrl){\r\n\t        img.src = dataUrl;\r\n\t    }).catch(function(e){\r\n\t    \td.reject(e);\r\n\t    });\r\n\r\n\t    return d.promise;\r\n\t}\r\n\r\n\treturn diskfs.readImage = readImage;\r\n\r\n});\ndefine('skylark-io-diskfs/select',[\r\n    \"./diskfs\"\r\n],function(diskfs){\r\n    var fileInput,\r\n        fileInputForm,\r\n        fileSelected,\r\n        maxFileSize = 1 / 0;\r\n\r\n    function select(params) {\r\n        params = params || {};\r\n        var directory = params.directory || false,\r\n            multiple = params.multiple || false,\r\n            accept = params.accept || \"\", //'image/gif,image/jpeg,image/jpg,image/png,image/svg'\r\n            title = params.title || \"\",\r\n            fileSelected = params.picked;\r\n        if (!fileInput) {\r\n            var input = fileInput = document.createElement(\"input\");\r\n\r\n            input.type = \"file\";\r\n            input.style.position = \"fixed\";\r\n            input.style.left = 0;\r\n            input.style.top = 0;\r\n            input.style.opacity = .001;\r\n            document.body.appendChild(input);\r\n\r\n        }\r\n\r\n        function selectFiles(pickedFiles) {\r\n            for (var i = pickedFiles.length; i--;) {\r\n                if (pickedFiles[i].size > maxFileSize) {\r\n                    pickedFiles.splice(i, 1);\r\n                }\r\n            }\r\n            fileSelected(pickedFiles);\r\n        }\r\n\r\n        fileInput.onchange = function(e) {\r\n            var entries = e.target.webkitEntries || e.target.entries;\r\n\r\n            if (entries && entries.length) {\r\n                webentry.all(entries).then(function(files) {\r\n                    selectFiles(files);\r\n                });\r\n            } else {\r\n                selectFiles(Array.prototype.slice.call(e.target.files));\r\n            }\r\n            // reset to \"\", so selecting the same file next time still trigger the change handler\r\n            fileInput.value = \"\";     \r\n            fileInput.onchange = null;\r\n        };\r\n        \r\n        fileInput.multiple = multiple;\r\n        fileInput.accept = accept;\r\n        fileInput.title = title;\r\n\r\n        fileInput.webkitdirectory = directory;\r\n        fileInput.click();\r\n    }\r\n\r\n    return diskfs.select = select;\r\n});\r\n\r\n\n define('skylark-io-diskfs/webentry',[\r\n    \"skylark-langx/arrays\",\r\n    \"skylark-langx/Deferred\",\r\n    \"./diskfs\"\r\n],function(arrays,Deferred, diskfs){\r\n    var concat = Array.prototype.concat;\r\n    var webentry = (function() {\r\n        function one(entry, path) {\r\n            var d = new Deferred(),\r\n                onError = function(e) {\r\n                    d.reject(e);\r\n                };\r\n\r\n            path = path || '';\r\n            if (entry.isFile) {\r\n                entry.file(function(file) {\r\n                    file.relativePath = path;\r\n                    d.resolve(file);\r\n                }, onError);\r\n            } else if (entry.isDirectory) {\r\n                var dirReader = entry.createReader();\r\n                dirReader.readEntries(function(entries) {\r\n                    all(\r\n                        entries,\r\n                        path + entry.name + '/'\r\n                    ).then(function(files) {\r\n                        d.resolve(files);\r\n                    }).catch(onError);\r\n                }, onError);\r\n            } else {\r\n                // Return an empy list for file system items\r\n                // other than files or directories:\r\n                d.resolve([]);\r\n            }\r\n            return d.promise;\r\n        }\r\n\r\n        function all(entries, path) {\r\n            return Deferred.all(\r\n                arrays.map(entries, function(entry) {\r\n                    return one(entry, path);\r\n                })\r\n            ).then(function() {\r\n                return concat.apply([], arguments);\r\n            });\r\n        }\r\n\r\n        return {\r\n            one: one,\r\n            all: all\r\n        };\r\n    })();\r\n\r\n    return diskfs.webentry = webentry;\r\n});\ndefine('skylark-io-diskfs/main',[\r\n\t\"./diskfs\",\r\n\t\"./download\",\r\n\t\"./read\",\r\n\t\"./readImage\",\r\n\t\"./select\",\r\n\t\"./webentry\"\r\n],function(diskfs){\r\n\treturn diskfs;\r\n});\ndefine('skylark-io-diskfs', ['skylark-io-diskfs/main'], function (main) { return main; });\n\n"]}