/**
 * skylark-io-streams - The stream features enhancement for skylark utils.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(t,e){var r=e.define,require=e.require,s="function"==typeof r&&r.amd,i=!s&&"undefined"!=typeof exports;if(!s&&!r){var n={};r=e.define=function(t,e,r){"function"==typeof r?(n[t]={factory:r,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var r=e.split("/"),s=t.split("/");r.pop();for(var i=0;i<s.length;i++)"."!=s[i]&&(".."==s[i]?r.pop():r.push(s[i]));return r.join("/")}(e,t)}),resolved:!1,exports:null},require(t)):n[t]={factory:null,resolved:!0,exports:r}},require=e.require=function(t){if(!n.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var module=n[t];if(!module.resolved){var r=[];module.deps.forEach(function(t){r.push(require(t))}),module.exports=module.factory.apply(e,r)||null,module.resolved=!0}return module.exports}}if(!r)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,require){t("skylark-io-streams/streams",["skylark-langx-ns"],function(t){return t.attach("io.streams")}),t("skylark-io-streams/decode-stream",["skylark-langx-events","skylark-langx-chars","./streams"],function(t,e,r){var s=new Uint8Array(0),i=t.Emitter.inherit({klassName:"DecodeStream",_construct:function(t){if(this._rawMinBufferLength=t||0,this.pos=0,this.bufferLength=0,this.eof=!1,this.buffer=s,this.minBufferLength=512,t)for(;this.minBufferLength<t;)this.minBufferLength*=2},length:{get:function(){throw new Error("Should not access DecodeStream.length")}},isEmpty:{get:function(){for(;!this.eof&&0===this.bufferLength;)this.readBlock();return 0===this.bufferLength}},ensureBuffer:function(t){var e=this.buffer;if(t<=e.byteLength)return e;for(var r=this.minBufferLength;r<t;)r*=2;var s=new Uint8Array(r);return s.set(e),this.buffer=s},getByte:function(){for(var t=this.pos;this.bufferLength<=t;){if(this.eof)return-1;this.readBlock()}return this.buffer[this.pos++]},getUint16:function(){var t=this.getByte(),e=this.getByte();return-1===t||-1===e?-1:(t<<8)+e},getInt32:function(){var t=this.getByte(),e=this.getByte(),r=this.getByte(),s=this.getByte();return(t<<24)+(e<<16)+(r<<8)+s},getBytes(t,e=!1){var r,s=this.pos;if(t){for(this.ensureBuffer(s+t),r=s+t;!this.eof&&this.bufferLength<r;)this.readBlock();var i=this.bufferLength;r>i&&(r=i)}else{for(;!this.eof;)this.readBlock();r=this.bufferLength}this.pos=r;const n=this.buffer.subarray(s,r);return!e||n instanceof Uint8ClampedArray?n:new Uint8ClampedArray(n)},peekByte:function(){var t=this.getByte();return-1!==t&&this.pos--,t},peekBytes(t,e=!1){var r=this.getBytes(t,e);return this.pos-=r.length,r},makeSubStream:function(t,e,r){for(var s=t+e;this.bufferLength<=s&&!this.eof;)this.readBlock();return new Stream(this.buffer,t,e,r)},getByteRange(t,e){throw new Error("Should not call DecodeStream.getByteRange")},skip:function(t){t||(t=1),this.pos+=t},reset:function(){this.pos=0},getBaseStreams:function(){return this.str&&this.str.getBaseStreams?this.str.getBaseStreams():[]}});return r.DecodeStream=i}),t("skylark-io-streams/ascii85-stream",["skylark-langx-chars","./streams","./decode-stream"],function(t,e,r){var s=r.inherit({klassName:"Ascii85Stream",_construct:function(t){this.str=t,this.dict=t.dict,this.input=new Uint8Array(5),maybeLength&&(maybeLength*=.8),r.prototype._construct.call(this,maybeLength)},readBlock:function(){for(var e=this.str,r=e.getByte();t.isWhiteSpace(r);)r=e.getByte();if(-1!==r&&126!==r){var s,i,n=this.bufferLength;if(122===r){for(s=this.ensureBuffer(n+4),i=0;i<4;++i)s[n+i]=0;this.bufferLength+=4}else{var a=this.input;for(a[0]=r,i=1;i<5;++i){for(r=e.getByte();t.isWhiteSpace(r);)r=e.getByte();if(a[i]=r,-1===r||126===r)break}if(s=this.ensureBuffer(n+i-1),this.bufferLength+=i-1,i<5){for(;i<5;++i)a[i]=117;this.eof=!0}var h=0;for(i=0;i<5;++i)h=85*h+(a[i]-33);for(i=3;i>=0;--i)s[n+i]=255&h,h>>=8}}else this.eof=!0}});return e.Ascii85Stream=s}),t("skylark-io-streams/ascii-hex-stream",["./streams","./decode-stream"],function(t,e){var r=e.inherit({klassName:"AsciiHexStream",_construct:function(t,r){this.str=t,this.dict=t.dict,this.firstDigit=-1,r&&(r*=.5),e.prototype._construct.call(this,r)},readBlock:function(){var t=this.str.getBytes(8e3);if(t.length){for(var e=t.length+1>>1,r=this.ensureBuffer(this.bufferLength+e),s=this.bufferLength,i=this.firstDigit,n=0,a=t.length;n<a;n++){var h,o=t[n];if(o>=48&&o<=57)h=15&o;else{if(!(o>=65&&o<=70||o>=97&&o<=102)){if(62===o){this.eof=!0;break}continue}h=9+(15&o)}i<0?i=h:(r[s++]=i<<4|h,i=-1)}i>=0&&this.eof&&(r[s++]=i<<4,i=-1),this.firstDigit=i,this.bufferLength=s}else this.eof=!0}});return t.AsciiHexStream=r}),t("skylark-io-streams/_stream",["skylark-langx-events","./streams"],function(t,e){var r=t.Emitter.inherit({klassName:"Stream",_construct:function(t,e,r,s){this.bytes=t instanceof Uint8Array?t:new Uint8Array(t),this.start=e||0,this.pos=this.start,this.end=e+r||this.bytes.length,this.dict=s},length:{get:function(){return this.end-this.start}},getByte:function(){return this.pos>=this.end?-1:this.bytes[this.pos++]},getUint16:function(){var t=this.getByte(),e=this.getByte();return-1===t||-1===e?-1:(t<<8)+e},getInt32:function(){var t=this.getByte(),e=this.getByte(),r=this.getByte(),s=this.getByte();return(t<<24)+(e<<16)+(r<<8)+s},getBytes(t,e=!1){var r=this.bytes,s=this.pos,i=this.end;if(!t){const t=r.subarray(s,i);return e?new Uint8ClampedArray(t):t}var n=s+t;n>i&&(n=i),this.pos=n;const a=r.subarray(s,n);return e?new Uint8ClampedArray(a):a},peekByte:function(){var t=this.getByte();return-1!==t&&this.pos--,t},peekBytes(t,e=!1){var r=this.getBytes(t,e);return this.pos-=r.length,r},getByteRange(t,e){return t<0&&(t=0),e>this.end&&(e=this.end),this.bytes.subarray(t,e)},skip:function(t){t||(t=1),this.pos+=t},reset:function(){this.pos=this.start},moveStart:function(){this.start=this.pos},makeSubStream:function(t,e,s){return new r(this.bytes.buffer,t,e,s)}});return e.Stream=r}),t("skylark-io-streams/chunked-stream",["./streams","./_stream"],function(t,e){var r=e.inherit({klassName:"ChunkedStream",numChunks:0,numChunksLoaded:0,_construct:function(t){for(var e=t.length,r=new Uint8Array(e),s=0;s<e;++s)r[s]=t.charCodeAt(s);DecodeStream.prototype._construct.call(r),this.dict=stream.dict},numChunks:function(){},getMissingChunks:function(){for(var t=[],e=0,r=this.numChunks;e<r;++e)e in this.loadedChunks||t.push(e);return t},getBaseStreams:function(){return[this]},allChunksLoaded:function(){var t=this._;return t.numChunksLoaded===t.numChunks},onReceiveData:function(t,e){var r=t+e.byteLength;assert(t%this.chunkSize==0,"Bad begin offset: "+t);var s=this.bytes.length;assert(r%this.chunkSize==0||r===s,"Bad end offset: "+r),this.bytes.set(new Uint8Array(e),t);for(var i=this.chunkSize,n=Math.floor(t/i),a=Math.floor((r-1)/i)+1,e=n;e<a;++e)e in this.loadedChunks||(this.loadedChunks[e]=!0,++this.numChunksLoaded)},onReceiveInitialData:function(t){this.bytes.set(t),this.initialDataLength=t.length;for(var e=this.end===t.length?this.numChunks:Math.floor(t.length/this.chunkSize),r=0;r<e;r++)this.loadedChunks[r]=!0,++this.numChunksLoaded},ensureRange:function(t,e){if(!(t>=e||e<=this.initialDataLength))for(var r=this.chunkSize,s=Math.floor(t/r),i=Math.floor((e-1)/r)+1,n=s;n<i;++n)if(!(n in this.loadedChunks))throw new MissingDataException(t,e)},nextEmptyChunk:function(t){for(var e=t,r=this.numChunks;e<r;++e)if(!(e in this.loadedChunks))return e;for(var e=0;e<t;++e)if(!(e in this.loadedChunks))return e;return null},hasChunk:function(t){return t in this._.loadedChunks},getByte:function(){var t=this.pos;return t>=this.end?-1:(this.ensureRange(t,t+1),this.bytes[this.pos++])},getBytes:function(t){var e=this.bytes,r=this.pos,s=this.end;if(!t)return this.ensureRange(r,s),e.subarray(r,s);var i=r+t;return i>s&&(i=s),this.ensureRange(r,i),this.pos=i,e.subarray(r,i)},peekBytes:function(t){var e=this.getBytes(t);return this.pos-=e.length,e},getByteRange:function(t,e){return this.ensureRange(t,e),this.bytes.subarray(t,e)},skip:function(t){t||(t=1),this.pos+=t},reset:function(){this.pos=this.start},moveStart:function(){this.start=this.pos},makeSubStream:function(t,e,r){function s(){}s.prototype=Object.create(this),s.prototype.getMissingChunks=function(){for(var t=this.chunkSize,e=Math.floor(this.start/t),r=Math.floor((this.end-1)/t)+1,s=[],i=e;i<r;++i)i in this.loadedChunks||s.push(i);return s};var i=new s;return i.pos=i.start=t,i.end=t+e||this.end,i.dict=r,i}});return t.ChunkedStream=r}),t("skylark-io-streams/decrypt-stream",["./streams","./decode-stream"],function(t,e){var r=e.inherit({klassName:"DecryptStream",_construct:function(t,r,s){this.str=t,this.dict=t.dict,this.decrypt=s,this.nextChunk=null,this.initialized=!1,e.prototype._construct.call(this,r)},readBlock:function(){var t;if(this.initialized?t=this.nextChunk:(t=this.str.getBytes(512),this.initialized=!0),t&&0!==t.length){this.nextChunk=this.str.getBytes(512);var e=this.nextChunk&&this.nextChunk.length>0,r=this.decrypt;t=r(t,!e);var s,i=this.bufferLength,n=t.length,a=this.ensureBuffer(i+n);for(s=0;s<n;s++)a[i++]=t[s];this.bufferLength=i}else this.eof=!0}});return t.DecryptStream=r}),t("skylark-io-streams/fake-stream",["./streams","./decode-stream"],function(t,e){var r=e.inherit({klassName:"FakeStream",_construct:function(t){this.dict=t.dict,e.prototype._construct.call(this)},readBlock:function(){var t=this.bufferLength;t+=1024;this.ensureBuffer(t);this.bufferLength=t},getBytes:function(t){var e,r=this.pos;if(t){for(this.ensureBuffer(r+t),e=r+t;!this.eof&&this.bufferLength<e;)this.readBlock();var s=this.bufferLength;e>s&&(e=s)}else this.eof=!0,e=this.bufferLength;return this.pos=e,this.buffer.subarray(r,e)}});return t.FakeStream=r}),t("skylark-io-streams/flate-stream",["./streams","./decode-stream"],function(t,e){var r=new Int32Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),s=new Int32Array([3,4,5,6,7,8,9,10,65547,65549,65551,65553,131091,131095,131099,131103,196643,196651,196659,196667,262211,262227,262243,262259,327811,327843,327875,327907,258,258,258]),i=new Int32Array([1,2,3,4,65541,65543,131081,131085,196625,196633,262177,262193,327745,327777,393345,393409,459009,459137,524801,525057,590849,591361,657409,658433,724993,727041,794625,798721,868353,876545]),n=[new Int32Array([459008,524368,524304,524568,459024,524400,524336,590016,459016,524384,524320,589984,524288,524416,524352,590048,459012,524376,524312,589968,459028,524408,524344,590032,459020,524392,524328,59e4,524296,524424,524360,590064,459010,524372,524308,524572,459026,524404,524340,590024,459018,524388,524324,589992,524292,524420,524356,590056,459014,524380,524316,589976,459030,524412,524348,590040,459022,524396,524332,590008,524300,524428,524364,590072,459009,524370,524306,524570,459025,524402,524338,590020,459017,524386,524322,589988,524290,524418,524354,590052,459013,524378,524314,589972,459029,524410,524346,590036,459021,524394,524330,590004,524298,524426,524362,590068,459011,524374,524310,524574,459027,524406,524342,590028,459019,524390,524326,589996,524294,524422,524358,590060,459015,524382,524318,589980,459031,524414,524350,590044,459023,524398,524334,590012,524302,524430,524366,590076,459008,524369,524305,524569,459024,524401,524337,590018,459016,524385,524321,589986,524289,524417,524353,590050,459012,524377,524313,589970,459028,524409,524345,590034,459020,524393,524329,590002,524297,524425,524361,590066,459010,524373,524309,524573,459026,524405,524341,590026,459018,524389,524325,589994,524293,524421,524357,590058,459014,524381,524317,589978,459030,524413,524349,590042,459022,524397,524333,590010,524301,524429,524365,590074,459009,524371,524307,524571,459025,524403,524339,590022,459017,524387,524323,589990,524291,524419,524355,590054,459013,524379,524315,589974,459029,524411,524347,590038,459021,524395,524331,590006,524299,524427,524363,590070,459011,524375,524311,524575,459027,524407,524343,590030,459019,524391,524327,589998,524295,524423,524359,590062,459015,524383,524319,589982,459031,524415,524351,590046,459023,524399,524335,590014,524303,524431,524367,590078,459008,524368,524304,524568,459024,524400,524336,590017,459016,524384,524320,589985,524288,524416,524352,590049,459012,524376,524312,589969,459028,524408,524344,590033,459020,524392,524328,590001,524296,524424,524360,590065,459010,524372,524308,524572,459026,524404,524340,590025,459018,524388,524324,589993,524292,524420,524356,590057,459014,524380,524316,589977,459030,524412,524348,590041,459022,524396,524332,590009,524300,524428,524364,590073,459009,524370,524306,524570,459025,524402,524338,590021,459017,524386,524322,589989,524290,524418,524354,590053,459013,524378,524314,589973,459029,524410,524346,590037,459021,524394,524330,590005,524298,524426,524362,590069,459011,524374,524310,524574,459027,524406,524342,590029,459019,524390,524326,589997,524294,524422,524358,590061,459015,524382,524318,589981,459031,524414,524350,590045,459023,524398,524334,590013,524302,524430,524366,590077,459008,524369,524305,524569,459024,524401,524337,590019,459016,524385,524321,589987,524289,524417,524353,590051,459012,524377,524313,589971,459028,524409,524345,590035,459020,524393,524329,590003,524297,524425,524361,590067,459010,524373,524309,524573,459026,524405,524341,590027,459018,524389,524325,589995,524293,524421,524357,590059,459014,524381,524317,589979,459030,524413,524349,590043,459022,524397,524333,590011,524301,524429,524365,590075,459009,524371,524307,524571,459025,524403,524339,590023,459017,524387,524323,589991,524291,524419,524355,590055,459013,524379,524315,589975,459029,524411,524347,590039,459021,524395,524331,590007,524299,524427,524363,590071,459011,524375,524311,524575,459027,524407,524343,590031,459019,524391,524327,589999,524295,524423,524359,590063,459015,524383,524319,589983,459031,524415,524351,590047,459023,524399,524335,590015,524303,524431,524367,590079]),9],a=[new Int32Array([327680,327696,327688,327704,327684,327700,327692,327708,327682,327698,327690,327706,327686,327702,327694,0,327681,327697,327689,327705,327685,327701,327693,327709,327683,327699,327691,327707,327687,327703,327695,0]),5],h=e.inherit({klassName:"FlateStream",_construct:function(t,r){this.str=t,this.dict=t.dict;var s=t.getByte(),i=t.getByte();if(-1===s||-1===i)throw new util.FormatError(`Invalid header in flate stream: ${s}, ${i}`);if(8!=(15&s))throw new util.FormatError(`Unknown compression method in flate stream: ${s}, ${i}`);if(((s<<8)+i)%31!=0)throw new util.FormatError(`Bad FCHECK in flate stream: ${s}, ${i}`);if(32&i)throw new util.FormatError(`FDICT bit set in flate stream: ${s}, ${i}`);this.codeSize=0,this.codeBuf=0,e.prototype._construct.call(this,r)},getBits:function(t){for(var e,r=this.str,s=this.codeSize,i=this.codeBuf;s<t;){if(-1===(e=r.getByte()))throw new util.FormatError("Bad encoding in flate stream");i|=e<<s,s+=8}return e=i&(1<<t)-1,this.codeBuf=i>>t,this.codeSize=s-=t,e},getCode:function(t){for(var e,r=this.str,s=t[0],i=t[1],n=this.codeSize,a=this.codeBuf;n<i&&-1!==(e=r.getByte());)a|=e<<n,n+=8;var h=s[a&(1<<i)-1],o=h>>16,f=65535&h;if(o<1||n<o)throw new util.FormatError("Bad encoding in flate stream");return this.codeBuf=a>>o,this.codeSize=n-o,f},generateHuffmanTable:function(t){var e,r=t.length,s=0;for(e=0;e<r;++e)t[e]>s&&(s=t[e]);for(var i=1<<s,n=new Int32Array(i),a=1,h=0,o=2;a<=s;++a,h<<=1,o<<=1)for(var f=0;f<r;++f)if(t[f]===a){var u=0,c=h;for(e=0;e<a;++e)u=u<<1|1&c,c>>=1;for(e=u;e<i;e+=o)n[e]=a<<16|f;++h}return[n,s]},readBlock:function(){var t,e,h=this.str,o=this.getBits(3);if(1&o&&(this.eof=!0),0!==(o>>=1)){var f,u;if(1===o)f=n,u=a;else{if(2!==o)throw new util.FormatError("Unknown block type in flate stream");var c,l=this.getBits(5)+257,g=this.getBits(5)+1,d=this.getBits(4)+4,m=new Uint8Array(r.length);for(c=0;c<d;++c)m[r[c]]=this.getBits(3);var y=this.generateHuffmanTable(m);e=0,c=0;for(var k,B,v,p=l+g,b=new Uint8Array(p);c<p;){var w=this.getCode(y);if(16===w)k=2,B=3,v=e;else if(17===w)k=3,B=3,v=e=0;else{if(18!==w){b[c++]=e=w;continue}k=7,B=11,v=e=0}for(var S=this.getBits(k)+B;S-- >0;)b[c++]=v}f=this.generateHuffmanTable(b.subarray(0,l)),u=this.generateHuffmanTable(b.subarray(l,p))}for(var L=(t=this.buffer)?t.length:0,C=this.bufferLength;;){var _=this.getCode(f);if(_<256)C+1>=L&&(t=this.ensureBuffer(C+1),L=t.length),t[C++]=_;else{if(256===_)return void(this.bufferLength=C);var A=(_=s[_-=257])>>16;A>0&&(A=this.getBits(A)),e=(65535&_)+A,_=this.getCode(u),_=i[_],(A=_>>16)>0&&(A=this.getBits(A));var x=(65535&_)+A;C+e>=L&&(t=this.ensureBuffer(C+e),L=t.length);for(var U=0;U<e;++U,++C)t[C]=t[C-x]}}}else{var E;if(-1===(E=h.getByte()))throw new util.FormatError("Bad block header in flate stream");var z=E;if(-1===(E=h.getByte()))throw new util.FormatError("Bad block header in flate stream");if(z|=E<<8,-1===(E=h.getByte()))throw new util.FormatError("Bad block header in flate stream");var D=E;if(-1===(E=h.getByte()))throw new util.FormatError("Bad block header in flate stream");if((D|=E<<8)!==(65535&~z)&&(0!==z||0!==D))throw new util.FormatError("Bad uncompressed block length in flate stream");this.codeBuf=0,this.codeSize=0;const e=this.bufferLength,r=e+z;if(t=this.ensureBuffer(r),this.bufferLength=r,0===z)-1===h.peekByte()&&(this.eof=!0);else{const r=h.getBytes(z);t.set(r,e),r.length<z&&(this.eof=!0)}}}});return t.FlateStream=h}),t("skylark-io-streams/lzw-stream",["./streams","./decode-stream"],function(t,e){var r=e.inherit({klassName:"LZWStream",_construct:function(t,r,s){this.str=t,this.dict=t.dict,this.cachedData=0,this.bitsCached=0;for(var i={earlyChange:s,codeLength:9,nextCode:258,dictionaryValues:new Uint8Array(4096),dictionaryLengths:new Uint16Array(4096),dictionaryPrevCodes:new Uint16Array(4096),currentSequence:new Uint8Array(4096),currentSequenceLength:0},n=0;n<256;++n)i.dictionaryValues[n]=n,i.dictionaryLengths[n]=1;this.lzwState=i,e.prototype._construct.call(this,r)},readBits:function(t){for(var e=this.bitsCached,r=this.cachedData;e<t;){var s=this.str.getByte();if(-1===s)return this.eof=!0,null;r=r<<8|s,e+=8}return this.bitsCached=e-=t,this.cachedData=r,this.lastCode=null,r>>>e&(1<<t)-1},readBlock:function(){var t,e,r,s=1024,i=this.lzwState;if(i){var n=i.earlyChange,a=i.nextCode,h=i.dictionaryValues,o=i.dictionaryLengths,f=i.dictionaryPrevCodes,u=i.codeLength,c=i.prevCode,l=i.currentSequence,g=i.currentSequenceLength,d=0,m=this.bufferLength,y=this.ensureBuffer(this.bufferLength+s);for(t=0;t<512;t++){var k=this.readBits(u),B=g>0;if(k<256)l[0]=k,g=1;else{if(!(k>=258)){if(256===k){u=9,a=258,g=0;continue}this.eof=!0,delete this.lzwState;break}if(k<a)for(g=o[k],e=g-1,r=k;e>=0;e--)l[e]=h[r],r=f[r];else l[g++]=l[0]}if(B&&(f[a]=c,o[a]=o[c]+1,h[a]=l[0],u=++a+n&a+n-1?u:0|Math.min(Math.log(a+n)/.6931471805599453+1,12)),c=k,s<(d+=g)){do{s+=512}while(s<d);y=this.ensureBuffer(this.bufferLength+s)}for(e=0;e<g;e++)y[m++]=l[e]}i.nextCode=a,i.codeLength=u,i.prevCode=c,i.currentSequenceLength=g,this.bufferLength=m}}});return t.LZWStream=r}),t("skylark-io-streams/null-stream",["./streams","./_stream"],function(t,e){var r=e.inherit({klassName:"NullStream",_construct:function(){e.prototype._construct.call(this,new Uint8Array(0))}});return t.NullStream=r}),t("skylark-io-streams/predictor-stream",["./streams","./decode-stream"],function(t,e){var r=e.inherit({klassName:"PredictorStream",_construct:function(t,r,s){if(!primitives.isDict(s))return t;var i=this.predictor=s.get("Predictor")||1;if(i<=1)return t;if(2!==i&&(i<10||i>15))throw new Error(`Unsupported predictor: ${i}`);this.readBlock=2===i?this.readBlockTiff:this.readBlockPng,this.str=t,this.dict=t.dict;var n=this.colors=s.get("Colors")||1,a=this.bits=s.get("BitsPerComponent")||8,h=this.columns=s.get("Columns")||1;return this.pixBytes=n*a+7>>3,this.rowBytes=h*n*a+7>>3,e.call(this,r),this},readBlockTiff:function(){var t=this.rowBytes,e=this.bufferLength,r=this.ensureBuffer(e+t),s=this.bits,i=this.colors,n=this.str.getBytes(t);if(this.eof=!n.length,!this.eof){var a,h=0,o=0,f=0,u=0,c=e;if(1===s&&1===i)for(a=0;a<t;++a){var l=n[a]^h;l^=l>>1,l^=l>>2,h=(1&(l^=l>>4))<<7,r[c++]=l}else if(8===s){for(a=0;a<i;++a)r[c++]=n[a];for(;a<t;++a)r[c]=r[c-i]+n[a],c++}else if(16===s){var g=2*i;for(a=0;a<g;++a)r[c++]=n[a];for(;a<t;a+=2){var d=((255&n[a])<<8)+(255&n[a+1])+((255&r[c-g])<<8)+(255&r[c-g+1]);r[c++]=d>>8&255,r[c++]=255&d}}else{var m=new Uint8Array(i+1),y=(1<<s)-1,k=0,B=e,v=this.columns;for(a=0;a<v;++a)for(var p=0;p<i;++p)f<s&&(h=h<<8|255&n[k++],f+=8),m[p]=m[p]+(h>>f-s)&y,f-=s,o=o<<s|m[p],(u+=s)>=8&&(r[B++]=o>>u-8&255,u-=8);u>0&&(r[B++]=(o<<8-u)+(h&(1<<8-u)-1))}this.bufferLength+=t}},readBlockPng:function(){var t=this.rowBytes,e=this.pixBytes,r=this.str.getByte(),s=this.str.getBytes(t);if(this.eof=!s.length,!this.eof){var i=this.bufferLength,n=this.ensureBuffer(i+t),a=n.subarray(i-t,i);0===a.length&&(a=new Uint8Array(t));var h,o,f,u=i;switch(r){case 0:for(h=0;h<t;++h)n[u++]=s[h];break;case 1:for(h=0;h<e;++h)n[u++]=s[h];for(;h<t;++h)n[u]=n[u-e]+s[h]&255,u++;break;case 2:for(h=0;h<t;++h)n[u++]=a[h]+s[h]&255;break;case 3:for(h=0;h<e;++h)n[u++]=(a[h]>>1)+s[h];for(;h<t;++h)n[u]=(a[h]+n[u-e]>>1)+s[h]&255,u++;break;case 4:for(h=0;h<e;++h)o=a[h],f=s[h],n[u++]=o+f;for(;h<t;++h){o=a[h];var c=a[h-e],l=n[u-e],g=l+o-c,d=g-l;d<0&&(d=-d);var m=g-o;m<0&&(m=-m);var y=g-c;y<0&&(y=-y),f=s[h],n[u++]=d<=m&&d<=y?l+f:m<=y?o+f:c+f}break;default:throw new Error(`Unsupported predictor: ${r}`)}this.bufferLength+=t}}});return t.PredictorStream=r}),t("skylark-io-streams/run-length-stream",["skylark-langx-chars","./streams","./decode-stream"],function(t,e,r){var s=r.inherit({klassName:"RunLengthStream",_construct:function(t,e){this.str=t,this.dict=t.dict,r.prototype._construct.call(this,e)},readBlock:function(){var t=this.str.getBytes(2);if(!t||t.length<2||128===t[0])this.eof=!0;else{var e,r=this.bufferLength,s=t[0];if(s<128){if((e=this.ensureBuffer(r+s+1))[r++]=t[1],s>0){var i=this.str.getBytes(s);e.set(i,r),r+=s}}else{s=257-s;var n=t[1];e=this.ensureBuffer(r+s+1);for(var a=0;a<s;a++)e[r++]=n}this.bufferLength=r}}});return e.RunLengthStream=s}),t("skylark-io-streams/streams-sequence-stream",["skylark-langx-chars","./streams","./decode-stream"],function(t,e,r){var s=r.inherit({klassName:"StreamsSequenceStream",_construct:function(t){this.streams=t;let e=0;for(let s=0,i=t.length;s<i;s++){const i=t[s];e+=i instanceof r?i._rawMinBufferLength:i.length}r.prototype._construct.call(this,e)},readBlock:function(){var t=this.streams;if(0!==e.length){t.shift();var r=t.getBytes(),s=this.bufferLength,i=s+r.length,n=this.ensureBuffer(i);n.set(r,s),this.bufferLength=i}else this.eof=!0},getBaseStreams:function(){for(var t=[],e=0,r=this.streams.length;e<r;e++){var s=this.streams[e];s.getBaseStreams&&t.push(...s.getBaseStreams())}return t}});return e.StreamsSequenceStream=s}),t("skylark-io-streams/string-stream",["./streams","./_stream"],function(t,e){var r=e.inherit({klassName:"StringStream",_construct:function(t){for(var r=t.length,s=new Uint8Array(r),i=0;i<r;++i)s[i]=t.charCodeAt(i);e.prototype._construct.call(this,s)}});return t.StringStream=r}),t("skylark-io-streams/main",["./streams","./ascii85-stream","./ascii-hex-stream","./chunked-stream","./decode-stream","./decrypt-stream","./fake-stream","./flate-stream","./lzw-stream","./null-stream","./predictor-stream","./run-length-stream","./_stream","./streams-sequence-stream","./string-stream"],function(t){return t}),t("skylark-io-streams",["skylark-io-streams/main"],function(t){return t})}(r),!s){var a=require("skylark-langx-ns");i?module.exports=a:e.skylarkjs=a}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-io-streams.js.map
