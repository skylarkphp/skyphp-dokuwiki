/**
 * skylark-io-streams - The stream features enhancement for skylark utils.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./streams","./decode-stream"],function(r,t){var e=t.inherit({klassName:"PredictorStream",_construct:function(r,e,s){if(!primitives.isDict(s))return r;var i=this.predictor=s.get("Predictor")||1;if(i<=1)return r;if(2!==i&&(i<10||i>15))throw new Error(`Unsupported predictor: ${i}`);this.readBlock=2===i?this.readBlockTiff:this.readBlockPng,this.str=r,this.dict=r.dict;var o=this.colors=s.get("Colors")||1,f=this.bits=s.get("BitsPerComponent")||8,a=this.columns=s.get("Columns")||1;return this.pixBytes=o*f+7>>3,this.rowBytes=a*o*f+7>>3,t.call(this,e),this},readBlockTiff:function(){var r=this.rowBytes,t=this.bufferLength,e=this.ensureBuffer(t+r),s=this.bits,i=this.colors,o=this.str.getBytes(r);if(this.eof=!o.length,!this.eof){var f,a=0,h=0,n=0,c=0,u=t;if(1===s&&1===i)for(f=0;f<r;++f){var l=o[f]^a;l^=l>>1,l^=l>>2,a=(1&(l^=l>>4))<<7,e[u++]=l}else if(8===s){for(f=0;f<i;++f)e[u++]=o[f];for(;f<r;++f)e[u]=e[u-i]+o[f],u++}else if(16===s){var d=2*i;for(f=0;f<d;++f)e[u++]=o[f];for(;f<r;f+=2){var v=((255&o[f])<<8)+(255&o[f+1])+((255&e[u-d])<<8)+(255&e[u-d+1]);e[u++]=v>>8&255,e[u++]=255&v}}else{var g=new Uint8Array(i+1),B=(1<<s)-1,b=0,k=t,p=this.columns;for(f=0;f<p;++f)for(var y=0;y<i;++y)n<s&&(a=a<<8|255&o[b++],n+=8),g[y]=g[y]+(a>>n-s)&B,n-=s,h=h<<s|g[y],(c+=s)>=8&&(e[k++]=h>>c-8&255,c-=8);c>0&&(e[k++]=(h<<8-c)+(a&(1<<8-c)-1))}this.bufferLength+=r}},readBlockPng:function(){var r=this.rowBytes,t=this.pixBytes,e=this.str.getByte(),s=this.str.getBytes(r);if(this.eof=!s.length,!this.eof){var i=this.bufferLength,o=this.ensureBuffer(i+r),f=o.subarray(i-r,i);0===f.length&&(f=new Uint8Array(r));var a,h,n,c=i;switch(e){case 0:for(a=0;a<r;++a)o[c++]=s[a];break;case 1:for(a=0;a<t;++a)o[c++]=s[a];for(;a<r;++a)o[c]=o[c-t]+s[a]&255,c++;break;case 2:for(a=0;a<r;++a)o[c++]=f[a]+s[a]&255;break;case 3:for(a=0;a<t;++a)o[c++]=(f[a]>>1)+s[a];for(;a<r;++a)o[c]=(f[a]+o[c-t]>>1)+s[a]&255,c++;break;case 4:for(a=0;a<t;++a)h=f[a],n=s[a],o[c++]=h+n;for(;a<r;++a){h=f[a];var u=f[a-t],l=o[c-t],d=l+h-u,v=d-l;v<0&&(v=-v);var g=d-h;g<0&&(g=-g);var B=d-u;B<0&&(B=-B),n=s[a],o[c++]=v<=g&&v<=B?l+n:g<=B?h+n:u+n}break;default:throw new Error(`Unsupported predictor: ${e}`)}this.bufferLength+=r}}});return r.PredictorStream=e});
//# sourceMappingURL=sourcemaps/predictor-stream.js.map
