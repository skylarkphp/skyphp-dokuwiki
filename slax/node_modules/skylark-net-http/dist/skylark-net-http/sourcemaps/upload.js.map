{"version":3,"sources":["upload.js"],"names":["define","types","objects","arrays","Deferred","Evented","Xhr","http","blobSlice","Blob","prototype","slice","webkitSlice","mozSlice","Upload","inherit","klassName","_construct","options","this","_options","mixin","debug","url","headers","maxConnections","maxChunkSize","undefined","onProgress","id","fileName","loaded","total","onComplete","result","status","xhr","onCancel","onFailure","e","_queue","_params","_files","_xhrs","_loaded","add","file","push","send","params","indexOf","len","copy","clone","_send","sendAll","length","cancel","_cancel","_dequeue","cancelAll","i","getName","name","getSize","fileSize","size","getLoaded","curUploadingSize","chunkSize","curLoadedSize","args","data","call","type","formParamName","formData","FormData","append","self","post","progress","lengthComputable","then","catch","abort","getQueue","inArray","splice","max","nextId","uploader","files"],"mappings":"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","file":"../upload.js","sourcesContent":["define([\r\n    \"skylark-langx-types\",\r\n    \"skylark-langx-objects\",\r\n    \"skylark-langx-arrays\",\r\n    \"skylark-langx-async/deferred\",\r\n    \"skylark-langx-emitter/evented\",    \r\n    \"./xhr\",\r\n    \"./http\"\r\n],function(types, objects, arrays, Deferred, Evented,Xhr, http){\r\n\r\n    var blobSlice = Blob.prototype.slice || Blob.prototype.webkitSlice || Blob.prototype.mozSlice;\r\n\r\n\r\n    /*\r\n     *Class for uploading files using xhr.\r\n     */\r\n    var Upload = Evented.inherit({\r\n        klassName : \"Upload\",\r\n\r\n        _construct : function(options) {\r\n            this._options = objects.mixin({\r\n                debug: false,\r\n                url: '/upload',\r\n                headers : {\r\n\r\n                },\r\n                // maximum number of concurrent uploads\r\n                maxConnections: 999,\r\n                // To upload large files in smaller chunks, set the following option\r\n                // to a preferred maximum chunk size. If set to 0, null or undefined,\r\n                // or the browser does not support the required Blob API, files will\r\n                // be uploaded as a whole.\r\n                maxChunkSize: undefined,\r\n\r\n                onProgress: function(id, fileName, loaded, total){\r\n                },\r\n                onComplete: function(id, fileName,result,status,xhr){\r\n                },\r\n                onCancel: function(id, fileName){\r\n                },\r\n                onFailure : function(id,fileName,e) {                    \r\n                }\r\n            },options);\r\n\r\n            this._queue = [];\r\n            // params for files in queue\r\n            this._params = [];\r\n\r\n            this._files = [];\r\n            this._xhrs = [];\r\n\r\n            // current loaded size in bytes for each file\r\n            this._loaded = [];\r\n\r\n        },\r\n\r\n        /**\r\n         * Adds file to the queue\r\n         * Returns id to use with upload, cancel\r\n         **/\r\n        add: function(file){\r\n            return this._files.push(file) - 1;\r\n        },\r\n\r\n        /**\r\n         * Sends the file identified by id and additional query params to the server.\r\n         */\r\n        send: function(id, params){\r\n            if (!this._files[id]) {\r\n                // Already sended or canceled\r\n                return ;\r\n            }\r\n            if (this._queue.indexOf(id)>-1) {\r\n                // Already in the queue\r\n                return;\r\n            }\r\n            var len = this._queue.push(id);\r\n\r\n            var copy = objects.clone(params);\r\n\r\n            this._params[id] = copy;\r\n\r\n            // if too many active uploads, wait...\r\n            if (len <= this._options.maxConnections){\r\n                this._send(id, this._params[id]);\r\n            }     \r\n        },\r\n\r\n        /**\r\n         * Sends all files  and additional query params to the server.\r\n         */\r\n        sendAll: function(params){\r\n           for( var id = 0; id <this._files.length; id++) {\r\n                this.send(id,params);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cancels file upload by id\r\n         */\r\n        cancel: function(id){\r\n            this._cancel(id);\r\n            this._dequeue(id);\r\n        },\r\n\r\n        /**\r\n         * Cancells all uploads\r\n         */\r\n        cancelAll: function(){\r\n            for (var i=0; i<this._queue.length; i++){\r\n                this._cancel(this._queue[i]);\r\n            }\r\n            this._queue = [];\r\n        },\r\n\r\n        getName: function(id){\r\n            var file = this._files[id];\r\n            return file.fileName != null ? file.fileName : file.name;\r\n        },\r\n\r\n        getSize: function(id){\r\n            var file = this._files[id];\r\n            return file.fileSize != null ? file.fileSize : file.size;\r\n        },\r\n\r\n        /**\r\n         * Returns uploaded bytes for file identified by id\r\n         */\r\n        getLoaded: function(id){\r\n            return this._loaded[id] || 0;\r\n        },\r\n\r\n\r\n        /**\r\n         * Sends the file identified by id and additional query params to the server\r\n         * @param {Object} params name-value string pairs\r\n         */\r\n        _send: function(id, params){\r\n            var options = this._options,\r\n                name = this.getName(id),\r\n                size = this.getSize(id),\r\n                chunkSize = options.maxChunkSize || 0,\r\n                curUploadingSize,\r\n                curLoadedSize = 0,\r\n                file = this._files[id],\r\n                args = {\r\n                    headers : objects.clone(options.headers)                    \r\n                };\r\n\r\n            this._loaded[id] = this._loaded[id] || 0;\r\n\r\n            var xhr = this._xhrs[id] = new Xhr({\r\n                url : options.url\r\n            });\r\n\r\n            if (chunkSize)  {\r\n\r\n                args.data = blobSlice.call(\r\n                    file,\r\n                    this._loaded[id],\r\n                    this._loaded[id] + chunkSize,\r\n                    file.type\r\n                );\r\n                // Store the current chunk size, as the blob itself\r\n                // will be dereferenced after data processing:\r\n                curUploadingSize = args.data.size;\r\n                // Expose the chunk bytes position range:\r\n                args.headers[\"content-range\"] = 'bytes ' + this._loaded[id] + '-' +\r\n                    (this._loaded[id] + curUploadingSize - 1) + '/' + size;\r\n                args.headers[\"Content-Type\"] = \"application/octet-stream\";\r\n            }  else {\r\n                curUploadingSize = size;\r\n                var formParamName =  params.formParamName,\r\n                    formData = params.formData;\r\n\r\n                if (formParamName) {\r\n                    if (!formData) {\r\n                        formData = new FormData();\r\n                    }\r\n                    formData.append(formParamName,file);\r\n                    args.data = formData;\r\n    \r\n                } else {\r\n                    args.headers[\"Content-Type\"] = file.type || \"application/octet-stream\";\r\n                    args.data = file;\r\n                }\r\n            }\r\n\r\n\r\n            var self = this;\r\n            xhr.post(\r\n                args\r\n            ).progress(function(e){\r\n                if (e.lengthComputable){\r\n                    curLoadedSize = curLoadedSize + e.loaded;\r\n                    self._loaded[id] = self._loaded[id] + e.loaded;\r\n                    self._options.onProgress(id, name, self._loaded[id], size);\r\n                }\r\n            }).then(function(result,status,xhr){\r\n                if (!self._files[id]) {\r\n                    // the request was aborted/cancelled\r\n                    return;\r\n                }\r\n\r\n                if (curLoadedSize < curUploadingSize) {\r\n                    // Create a progress event if no final progress event\r\n                    // with loaded equaling total has been triggered\r\n                    // for this chunk:\r\n                    self._loaded[id] = self._loaded[id] + curUploadingSize - curLoadedSize;\r\n                    self._options.onProgress(id, name, self._loaded[id], size);                    \r\n                }\r\n\r\n                if (self._loaded[id] <size) {\r\n                    // File upload not yet complete,\r\n                    // continue with the next chunk:\r\n                    self._send(id,params);\r\n                } else {\r\n                    self._options.onComplete(id,name,result,status,xhr);\r\n\r\n                    self._files[id] = null;\r\n                    self._xhrs[id] = null;\r\n                    self._dequeue(id);\r\n                }\r\n\r\n\r\n            }).catch(function(e){\r\n                self._options.onFailure(id,name,e);\r\n\r\n                self._files[id] = null;\r\n                self._xhrs[id] = null;\r\n                self._dequeue(id);\r\n            });\r\n        },\r\n\r\n        _cancel: function(id){\r\n            this._options.onCancel(id, this.getName(id));\r\n\r\n            this._files[id] = null;\r\n\r\n            if (this._xhrs[id]){\r\n                this._xhrs[id].abort();\r\n                this._xhrs[id] = null;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Returns id of files being uploaded or\r\n         * waiting for their turn\r\n         */\r\n        getQueue: function(){\r\n            return this._queue;\r\n        },\r\n\r\n\r\n        /**\r\n         * Removes element from queue, starts upload of next\r\n         */\r\n        _dequeue: function(id){\r\n            var i = arrays.inArray(id,this._queue);\r\n            this._queue.splice(i, 1);\r\n\r\n            var max = this._options.maxConnections;\r\n\r\n            if (this._queue.length >= max && i < max){\r\n                var nextId = this._queue[max-1];\r\n                this._send(nextId, this._params[nextId]);\r\n            }\r\n        }\r\n    });\r\n\r\n\r\n  Upload.send = function(file, options) {\r\n    var uploader = new Upload(options);\r\n    var id = uploader.add(file);\r\n    return uploader.send(id,options);\r\n  };\r\n\r\n  Upload.sendAll = function(files,options) {\r\n      var uploader = new Upload(options);\r\n      for (var i = 0, len = files.length; i < len; i++) {\r\n        this.add(file[i]);\r\n      }\r\n      return uploader.send(options);\r\n  };\r\n\r\n    return http.Upload = Upload;    \r\n});"]}