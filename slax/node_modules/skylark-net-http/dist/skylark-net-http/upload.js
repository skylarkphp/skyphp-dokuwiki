/**
 * skylark-net-http - The skylark http  library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-types","skylark-langx-objects","skylark-langx-arrays","skylark-langx-async/deferred","skylark-langx-emitter/evented","./xhr","./http"],function(e,t,n,i,s,a,o){var l=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice,r=s.inherit({klassName:"Upload",_construct:function(e){this._options=t.mixin({debug:!1,url:"/upload",headers:{},maxConnections:999,maxChunkSize:void 0,onProgress:function(e,t,n,i){},onComplete:function(e,t,n,i,s){},onCancel:function(e,t){},onFailure:function(e,t,n){}},e),this._queue=[],this._params=[],this._files=[],this._xhrs=[],this._loaded=[]},add:function(e){return this._files.push(e)-1},send:function(e,n){if(this._files[e]&&!(this._queue.indexOf(e)>-1)){var i=this._queue.push(e),s=t.clone(n);this._params[e]=s,i<=this._options.maxConnections&&this._send(e,this._params[e])}},sendAll:function(e){for(var t=0;t<this._files.length;t++)this.send(t,e)},cancel:function(e){this._cancel(e),this._dequeue(e)},cancelAll:function(){for(var e=0;e<this._queue.length;e++)this._cancel(this._queue[e]);this._queue=[]},getName:function(e){var t=this._files[e];return null!=t.fileName?t.fileName:t.name},getSize:function(e){var t=this._files[e];return null!=t.fileSize?t.fileSize:t.size},getLoaded:function(e){return this._loaded[e]||0},_send:function(e,n){var i,s=this._options,o=this.getName(e),r=this.getSize(e),u=s.maxChunkSize||0,h=0,d=this._files[e],_={headers:t.clone(s.headers)};this._loaded[e]=this._loaded[e]||0;var c=this._xhrs[e]=new a({url:s.url});if(u)_.data=l.call(d,this._loaded[e],this._loaded[e]+u,d.type),i=_.data.size,_.headers["content-range"]="bytes "+this._loaded[e]+"-"+(this._loaded[e]+i-1)+"/"+r,_.headers["Content-Type"]="application/octet-stream";else{i=r;var f=n.formParamName,p=n.formData;f?(p||(p=new FormData),p.append(f,d),_.data=p):(_.headers["Content-Type"]=d.type||"application/octet-stream",_.data=d)}var m=this;c.post(_).progress(function(t){t.lengthComputable&&(h+=t.loaded,m._loaded[e]=m._loaded[e]+t.loaded,m._options.onProgress(e,o,m._loaded[e],r))}).then(function(t,s,a){m._files[e]&&(h<i&&(m._loaded[e]=m._loaded[e]+i-h,m._options.onProgress(e,o,m._loaded[e],r)),m._loaded[e]<r?m._send(e,n):(m._options.onComplete(e,o,t,s,a),m._files[e]=null,m._xhrs[e]=null,m._dequeue(e)))}).catch(function(t){m._options.onFailure(e,o,t),m._files[e]=null,m._xhrs[e]=null,m._dequeue(e)})},_cancel:function(e){this._options.onCancel(e,this.getName(e)),this._files[e]=null,this._xhrs[e]&&(this._xhrs[e].abort(),this._xhrs[e]=null)},getQueue:function(){return this._queue},_dequeue:function(e){var t=n.inArray(e,this._queue);this._queue.splice(t,1);var i=this._options.maxConnections;if(this._queue.length>=i&&t<i){var s=this._queue[i-1];this._send(s,this._params[s])}}});return r.send=function(e,t){var n=new r(t),i=n.add(e);return n.send(i,t)},r.sendAll=function(e,t){for(var n=new r(t),i=0,s=e.length;i<s;i++)this.add(file[i]);return n.send(t)},o.Upload=r});
//# sourceMappingURL=sourcemaps/upload.js.map
