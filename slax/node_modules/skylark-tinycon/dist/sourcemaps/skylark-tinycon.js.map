{"version":3,"sources":["skylark-tinycon.js"],"names":["define","skylark","agent","Tinycon","currentFavicon","originalFavicon","faviconImage","canvas","options","r","window","devicePixelRatio","size","defaults","width","height","font","color","background","fallback","crossOrigin","abbreviate","ua","navigator","userAgent","toLowerCase","browser","indexOf","ie","chrome","webkit","safari","mozilla","getCurrentFavicon","tag","links","document","getElementsByTagName","i","len","length","getAttribute","match","getFaviconTag","getCanvas","createElement","setFaviconTag","url","head","exists","removeChild","removeFaviconTag","link","type","rel","href","appendChild","updateTitle","label","originalTitle","title","slice","drawBubble","context","abbreviateNumber","top","left","bottom","right","radius","fillStyle","strokeStyle","lineWidth","beginPath","moveTo","quadraticCurveTo","lineTo","closePath","fill","stroke","textAlign","textBaseline","fillText","refreshFavicon","getContext","toDataURL","metricPrefixes","round","value","precision","number","Number","toFixed","setOptions","custom","key","colour","hasOwnProperty","this","setImage","setBubble","src","onload","clearRect","drawImage","drawFavicon","reset","attach","tinycon","main"],"mappings":"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","file":"../skylark-tinycon.js","sourcesContent":["define('skylark-tinycon/tinycon',[\n  \"skylark-langx-ns\"\n],function(skylark) {\n  var Tinycon = {};\n  var currentFavicon = null;\n  var originalFavicon = null;\n  var faviconImage = null;\n  var canvas = null;\n  var options = {};\n  var r = window.devicePixelRatio || 1;\n  var size = 16 * r;\n  var defaults = {\n    width: 7,\n    height: 9,\n    font: 10 * r + 'px arial',\n    color: '#ffffff',\n    background: '#F03D25',\n    fallback: true,\n    crossOrigin: true,\n    abbreviate: true\n  };\n\n  var ua = (function () {\n    var agent = navigator.userAgent.toLowerCase();\n    // New function has access to 'agent' via closure\n    return function (browser) {\n      return agent.indexOf(browser) !== -1;\n    };\n  }());\n\n  var browser = {\n    ie: ua('trident'),\n    chrome: ua('chrome'),\n    webkit: ua('chrome') || ua('safari'),\n    safari: ua('safari') && !ua('chrome'),\n    mozilla: ua('mozilla') && !ua('chrome') && !ua('safari')\n  };\n\n  // private methods\n  var getFaviconTag = function(){\n\n    var links = document.getElementsByTagName('link');\n\n    for(var i=0, len=links.length; i < len; i++) {\n      if ((links[i].getAttribute('rel') || '').match(/\\bicon\\b/i)) {\n        return links[i];\n      }\n    }\n\n    return false;\n  };\n\n  var removeFaviconTag = function(){\n\n    var links = document.getElementsByTagName('link');\n    var head = document.getElementsByTagName('head')[0];\n\n    for(var i=0, len=links.length; i < len; i++) {\n      var exists = (typeof(links[i]) !== 'undefined');\n      if (exists && (links[i].getAttribute('rel') || '').match(/\\bicon\\b/i)) {\n        head.removeChild(links[i]);\n      }\n    }\n  };\n\n  var getCurrentFavicon = function(){\n\n    if (!originalFavicon || !currentFavicon) {\n      var tag = getFaviconTag();\n      currentFavicon = tag ? tag.getAttribute('href') : '/favicon.ico';\n      if (!originalFavicon) {\n        originalFavicon = currentFavicon;\n      }\n    }\n\n    return currentFavicon;\n  };\n\n  var getCanvas = function (){\n\n    if (!canvas) {\n      canvas = document.createElement(\"canvas\");\n      canvas.width = size;\n      canvas.height = size;\n    }\n\n    return canvas;\n  };\n\n  var setFaviconTag = function(url){\n    if(url){\n      removeFaviconTag();\n\n      var link = document.createElement('link');\n      link.type = 'image/x-icon';\n      link.rel = 'icon';\n      link.href = url;\n      document.getElementsByTagName('head')[0].appendChild(link);\n    }\n  };\n\n  var log = function(message){\n    if (window.console) window.console.log(message);\n  };\n\n  var drawFavicon = function(label, color) {\n\n    // fallback to updating the browser title if unsupported\n    if (!getCanvas().getContext || browser.ie || browser.safari || options.fallback === 'force') {\n      return updateTitle(label);\n    }\n\n    var context = getCanvas().getContext(\"2d\");\n    var color = color || '#000000';\n    var src = getCurrentFavicon();\n\n    faviconImage = document.createElement('img');\n    faviconImage.onload = function() {\n\n      // clear canvas\n      context.clearRect(0, 0, size, size);\n\n      // draw the favicon\n      context.drawImage(faviconImage, 0, 0, faviconImage.width, faviconImage.height, 0, 0, size, size);\n\n      // draw bubble over the top\n      if ((label + '').length > 0) drawBubble(context, label, color);\n\n      // refresh tag in page\n      refreshFavicon();\n    };\n\n    // allow cross origin resource requests if the image is not a data:uri\n    // as detailed here: https://github.com/mrdoob/three.js/issues/1305\n    if (!src.match(/^data/) && options.crossOrigin) {\n      faviconImage.crossOrigin = 'anonymous';\n    }\n\n    faviconImage.src = src;\n  };\n\n  var updateTitle = function(label) {\n\n    if (options.fallback) {\n      // Grab the current title that we can prefix with the label\n      var originalTitle = document.title;\n\n      // Strip out the old label if there is one\n      if (originalTitle[0] === '(') {\n        originalTitle = originalTitle.slice(originalTitle.indexOf(' '));\n      }\n\n      if ((label + '').length > 0) {\n        document.title = '(' + label + ') ' + originalTitle;\n      } else {\n        document.title = originalTitle;\n      }\n    }\n  };\n\n  var drawBubble = function(context, label, color) {\n\n    // automatic abbreviation for long (>2 digits) numbers\n    if (typeof label == 'number' && label > 99 && options.abbreviate) {\n      label = abbreviateNumber(label);\n    }\n\n    // bubble needs to be larger for double digits\n    var len = (label + '').length-1;\n\n    var width = options.width * r + (6 * r * len),\n      height = options.height * r;\n\n    var top = size - height,\n            left = size - width - r,\n            bottom = 16 * r,\n            right = 16 * r,\n            radius = 2 * r;\n\n    // webkit seems to render fonts lighter than firefox\n    context.font = (browser.webkit ? 'bold ' : '') + options.font;\n    context.fillStyle = options.background;\n    context.strokeStyle = options.background;\n    context.lineWidth = r;\n\n    // bubble\n    context.beginPath();\n        context.moveTo(left + radius, top);\n    context.quadraticCurveTo(left, top, left, top + radius);\n    context.lineTo(left, bottom - radius);\n        context.quadraticCurveTo(left, bottom, left + radius, bottom);\n        context.lineTo(right - radius, bottom);\n        context.quadraticCurveTo(right, bottom, right, bottom - radius);\n        context.lineTo(right, top + radius);\n        context.quadraticCurveTo(right, top, right - radius, top);\n        context.closePath();\n        context.fill();\n\n    // bottom shadow\n    context.beginPath();\n    context.strokeStyle = \"rgba(0,0,0,0.3)\";\n    context.moveTo(left + radius / 2.0, bottom);\n    context.lineTo(right - radius / 2.0, bottom);\n    context.stroke();\n\n    // label\n    context.fillStyle = options.color;\n    context.textAlign = \"right\";\n    context.textBaseline = \"top\";\n\n    // unfortunately webkit/mozilla are a pixel different in text positioning\n    context.fillText(label, r === 2 ? 29 : 15, browser.mozilla ? 7*r : 6*r);\n  };\n\n  var refreshFavicon = function(){\n    // check support\n    if (!getCanvas().getContext) return;\n\n    setFaviconTag(getCanvas().toDataURL());\n  };\n\n  var abbreviateNumber = function(label) {\n    var metricPrefixes = [\n      ['G', 1000000000],\n      ['M',    1000000],\n      ['k',       1000]\n    ];\n\n    for(var i = 0; i < metricPrefixes.length; ++i) {\n      if (label >= metricPrefixes[i][1]) {\n        label = round(label / metricPrefixes[i][1]) + metricPrefixes[i][0];\n        break;\n      }\n    }\n\n    return label;\n  };\n\n  var round = function (value, precision) {\n    var number = new Number(value);\n    return number.toFixed(precision);\n  };\n\n  // public methods\n  Tinycon.setOptions = function(custom){\n    options = {};\n\n    // account for deprecated UK English spelling\n    if (custom.colour) {\n      custom.color = custom.colour;\n    }\n\n    for(var key in defaults){\n      options[key] = custom.hasOwnProperty(key) ? custom[key] : defaults[key];\n    }\n    return this;\n  };\n\n  Tinycon.setImage = function(url){\n    currentFavicon = url;\n    refreshFavicon();\n    return this;\n  };\n\n  Tinycon.setBubble = function(label, color) {\n    label = label || '';\n    drawFavicon(label, color);\n    return this;\n  };\n\n  Tinycon.reset = function(){\n    currentFavicon = originalFavicon;\n    setFaviconTag(originalFavicon);\n  };\n\n  Tinycon.setOptions(defaults);\n\n  return skylark.attach(\"itg.tinycon\",Tinycon);\n});\n\ndefine('skylark-tinycon/main',[\r\n\t\"./tinycon\"\r\n],function(tinycon){\r\n\treturn tinycon;\r\n});\ndefine('skylark-tinycon', ['skylark-tinycon/main'], function (main) { return main; });\n\n"]}