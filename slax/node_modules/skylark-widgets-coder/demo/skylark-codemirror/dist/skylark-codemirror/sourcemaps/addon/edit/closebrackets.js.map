{"version":3,"sources":["addon/edit/closebrackets.js"],"names":["define","CodeMirror","defaults","pairs","closeBefore","triples","explode","Pos","getOption","conf","name","defineOption","cm","val","old","Init","removeKeyMap","keyMap","state","closeBrackets","ensureBound","addKeyMap","Backspace","getConfig","Pass","ranges","listSelections","i","length","empty","around","charsAround","head","indexOf","cur","replaceRange","line","ch","Enter","operation","linesep","lineSeparator","replaceSelection","execCommand","indentLine","chars","charAt","key","handler","pos","type","identical","opening","curType","range","next","getRange","test","getTokenTypeAt","prev","isWordChar","stringStartsAfter","left","right","sels","getSelections","replaceSelections","slice","sel","inverted","cmpPos","anchor","setSelections","triggerElectric","handleChar","deflt","override","getModeAt","getCursor","str","token","getTokenAt","start"],"mappings":"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","file":"../../../addon/edit/closebrackets.js","sourcesContent":["// CodeMirror, copyright (c) by Marijn Haverbeke and others\n// Distributed under an MIT license: https://codemirror.net/LICENSE\n\ndefine([\"../../CodeMirror\"], function(CodeMirror) {\n  var defaults = {\n    pairs: \"()[]{}''\\\"\\\"\",\n    closeBefore: \")]}'\\\":;>\",\n    triples: \"\",\n    explode: \"[]{}\"\n  };\n\n  var Pos = CodeMirror.Pos;\n\n  CodeMirror.defineOption(\"autoCloseBrackets\", false, function(cm, val, old) {\n    if (old && old != CodeMirror.Init) {\n      cm.removeKeyMap(keyMap);\n      cm.state.closeBrackets = null;\n    }\n    if (val) {\n      ensureBound(getOption(val, \"pairs\"))\n      cm.state.closeBrackets = val;\n      cm.addKeyMap(keyMap);\n    }\n  });\n\n  function getOption(conf, name) {\n    if (name == \"pairs\" && typeof conf == \"string\") return conf;\n    if (typeof conf == \"object\" && conf[name] != null) return conf[name];\n    return defaults[name];\n  }\n\n  var keyMap = {Backspace: handleBackspace, Enter: handleEnter};\n  function ensureBound(chars) {\n    for (var i = 0; i < chars.length; i++) {\n      var ch = chars.charAt(i), key = \"'\" + ch + \"'\"\n      if (!keyMap[key]) keyMap[key] = handler(ch)\n    }\n  }\n  ensureBound(defaults.pairs + \"`\")\n\n  function handler(ch) {\n    return function(cm) { return handleChar(cm, ch); };\n  }\n\n  function getConfig(cm) {\n    var deflt = cm.state.closeBrackets;\n    if (!deflt || deflt.override) return deflt;\n    var mode = cm.getModeAt(cm.getCursor());\n    return mode.closeBrackets || deflt;\n  }\n\n  function handleBackspace(cm) {\n    var conf = getConfig(cm);\n    if (!conf || cm.getOption(\"disableInput\")) return CodeMirror.Pass;\n\n    var pairs = getOption(conf, \"pairs\");\n    var ranges = cm.listSelections();\n    for (var i = 0; i < ranges.length; i++) {\n      if (!ranges[i].empty()) return CodeMirror.Pass;\n      var around = charsAround(cm, ranges[i].head);\n      if (!around || pairs.indexOf(around) % 2 != 0) return CodeMirror.Pass;\n    }\n    for (var i = ranges.length - 1; i >= 0; i--) {\n      var cur = ranges[i].head;\n      cm.replaceRange(\"\", Pos(cur.line, cur.ch - 1), Pos(cur.line, cur.ch + 1), \"+delete\");\n    }\n  }\n\n  function handleEnter(cm) {\n    var conf = getConfig(cm);\n    var explode = conf && getOption(conf, \"explode\");\n    if (!explode || cm.getOption(\"disableInput\")) return CodeMirror.Pass;\n\n    var ranges = cm.listSelections();\n    for (var i = 0; i < ranges.length; i++) {\n      if (!ranges[i].empty()) return CodeMirror.Pass;\n      var around = charsAround(cm, ranges[i].head);\n      if (!around || explode.indexOf(around) % 2 != 0) return CodeMirror.Pass;\n    }\n    cm.operation(function() {\n      var linesep = cm.lineSeparator() || \"\\n\";\n      cm.replaceSelection(linesep + linesep, null);\n      cm.execCommand(\"goCharLeft\");\n      ranges = cm.listSelections();\n      for (var i = 0; i < ranges.length; i++) {\n        var line = ranges[i].head.line;\n        cm.indentLine(line, null, true);\n        cm.indentLine(line + 1, null, true);\n      }\n    });\n  }\n\n  function contractSelection(sel) {\n    var inverted = CodeMirror.cmpPos(sel.anchor, sel.head) > 0;\n    return {anchor: new Pos(sel.anchor.line, sel.anchor.ch + (inverted ? -1 : 1)),\n            head: new Pos(sel.head.line, sel.head.ch + (inverted ? 1 : -1))};\n  }\n\n  function handleChar(cm, ch) {\n    var conf = getConfig(cm);\n    if (!conf || cm.getOption(\"disableInput\")) return CodeMirror.Pass;\n\n    var pairs = getOption(conf, \"pairs\");\n    var pos = pairs.indexOf(ch);\n    if (pos == -1) return CodeMirror.Pass;\n\n    var closeBefore = getOption(conf,\"closeBefore\");\n\n    var triples = getOption(conf, \"triples\");\n\n    var identical = pairs.charAt(pos + 1) == ch;\n    var ranges = cm.listSelections();\n    var opening = pos % 2 == 0;\n\n    var type;\n    for (var i = 0; i < ranges.length; i++) {\n      var range = ranges[i], cur = range.head, curType;\n      var next = cm.getRange(cur, Pos(cur.line, cur.ch + 1));\n      if (opening && !range.empty()) {\n        curType = \"surround\";\n      } else if ((identical || !opening) && next == ch) {\n        if (identical && stringStartsAfter(cm, cur))\n          curType = \"both\";\n        else if (triples.indexOf(ch) >= 0 && cm.getRange(cur, Pos(cur.line, cur.ch + 3)) == ch + ch + ch)\n          curType = \"skipThree\";\n        else\n          curType = \"skip\";\n      } else if (identical && cur.ch > 1 && triples.indexOf(ch) >= 0 &&\n                 cm.getRange(Pos(cur.line, cur.ch - 2), cur) == ch + ch) {\n        if (cur.ch > 2 && /\\bstring/.test(cm.getTokenTypeAt(Pos(cur.line, cur.ch - 2)))) return CodeMirror.Pass;\n        curType = \"addFour\";\n      } else if (identical) {\n        var prev = cur.ch == 0 ? \" \" : cm.getRange(Pos(cur.line, cur.ch - 1), cur)\n        if (!CodeMirror.isWordChar(next) && prev != ch && !CodeMirror.isWordChar(prev)) curType = \"both\";\n        else return CodeMirror.Pass;\n      } else if (opening && (next.length === 0 || /\\s/.test(next) || closeBefore.indexOf(next) > -1)) {\n        curType = \"both\";\n      } else {\n        return CodeMirror.Pass;\n      }\n      if (!type) type = curType;\n      else if (type != curType) return CodeMirror.Pass;\n    }\n\n    var left = pos % 2 ? pairs.charAt(pos - 1) : ch;\n    var right = pos % 2 ? ch : pairs.charAt(pos + 1);\n    cm.operation(function() {\n      if (type == \"skip\") {\n        cm.execCommand(\"goCharRight\");\n      } else if (type == \"skipThree\") {\n        for (var i = 0; i < 3; i++)\n          cm.execCommand(\"goCharRight\");\n      } else if (type == \"surround\") {\n        var sels = cm.getSelections();\n        for (var i = 0; i < sels.length; i++)\n          sels[i] = left + sels[i] + right;\n        cm.replaceSelections(sels, \"around\");\n        sels = cm.listSelections().slice();\n        for (var i = 0; i < sels.length; i++)\n          sels[i] = contractSelection(sels[i]);\n        cm.setSelections(sels);\n      } else if (type == \"both\") {\n        cm.replaceSelection(left + right, null);\n        cm.triggerElectric(left + right);\n        cm.execCommand(\"goCharLeft\");\n      } else if (type == \"addFour\") {\n        cm.replaceSelection(left + left + left + left, \"before\");\n        cm.execCommand(\"goCharRight\");\n      }\n    });\n  }\n\n  function charsAround(cm, pos) {\n    var str = cm.getRange(Pos(pos.line, pos.ch - 1),\n                          Pos(pos.line, pos.ch + 1));\n    return str.length == 2 ? str : null;\n  }\n\n  function stringStartsAfter(cm, pos) {\n    var token = cm.getTokenAt(Pos(pos.line, pos.ch + 1))\n    return /\\bstring/.test(token.type) && token.start == pos.ch &&\n      (pos.ch == 0 || !/\\bstring/.test(cm.getTokenTypeAt(pos)))\n  }\n});\n"]}