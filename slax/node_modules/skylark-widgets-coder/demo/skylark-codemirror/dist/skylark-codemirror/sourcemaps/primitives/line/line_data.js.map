{"version":3,"sources":["primitives/line/line_data.js"],"names":["define","bidi","browser","dom","events","feature_detection","misc","highlight","spans","m_utils_line","Line","[object Object]","text","markedSpans","estimateHeight","this","attachMarkedSpans","height","lineNo","eventMixin","styleToClassCache","styleToClassCacheWithMode","interpretTokenStyle","style","options","test","cache","addModeClass","replace","buildToken","builder","startStyle","endStyle","css","attributes","content","displayText","splitSpaces","trailingBefore","length","spaceBefore","result","i","ch","charAt","charCodeAt","trailingSpace","special","cm","state","specialChars","mustWrap","document","createDocumentFragment","pos","lastIndex","txt","m","exec","skipped","index","createTextNode","slice","ie","ie_version","appendChild","elt","map","push","col","tabSize","tabWidth","spaceStr","setAttribute","specialCharPlaceholder","fullStyle","token","attr","hasOwnProperty","buildTokenBadBidi","inner","order","start","end","part","to","from","buildCollapsedSpan","size","marker","ignoreWidget","widget","widgetNode","display","input","needsContentAttribute","createElement","id","setUneditable","insertLineContent","line","styles","allText","at","addToken","spanStyle","spanEndStyle","spanStartStyle","collapsed","len","nextChange","Infinity","endStyles","foundBookmarks","j","sp","type","className","title","compareCollapsedMarkers","upto","Math","min","tokenText","LineView","doc","lineN","rest","visualLineContinued","lst","node","hidden","lineIsHidden","updateLine","stateAfter","detachMarkedSpans","estHeight","updateLineHeight","cleanUpLine","parent","buildLineContent","lineView","eltP","webkit","pre","getOption","measure","hasBadBidiRects","getOrder","direction","allowFrontierUpdate","externalMeasured","getLineStyles","styleClasses","bgClass","joinClasses","textClass","zeroWidthElement","maps","caches","last","lastChild","querySelector","signal","defaultSpecialCharPlaceholder","toString","buildViewArray","nextPos","array","view","getLine"],"mappings":"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","file":"../../../primitives/line/line_data.js","sourcesContent":["define([\n    '../util/bidi',\n    '../util/browser',\n    '../util/dom',\n    '../util/event',\n    '../util/feature_detection',\n    '../util/misc',\n    './highlight',\n    './spans',\n    './utils_line'\n], function (bidi, browser, dom, events, feature_detection, misc, highlight, spans, m_utils_line) {\n    'use strict';\n    class Line {\n        constructor(text, markedSpans, estimateHeight) {\n            this.text = text;\n            spans.attachMarkedSpans(this, markedSpans);\n            this.height = estimateHeight ? estimateHeight(this) : 1;\n        }\n        lineNo() {\n            return m_utils_line.lineNo(this);\n        }\n    }\n    events.eventMixin(Line);\n    function updateLine(line, text, markedSpans, estimateHeight) {\n        line.text = text;\n        if (line.stateAfter)\n            line.stateAfter = null;\n        if (line.styles)\n            line.styles = null;\n        if (line.order != null)\n            line.order = null;\n        spans.detachMarkedSpans(line);\n        spans.attachMarkedSpans(line, markedSpans);\n        let estHeight = estimateHeight ? estimateHeight(line) : 1;\n        if (estHeight != line.height)\n            m_utils_line.updateLineHeight(line, estHeight);\n    }\n    function cleanUpLine(line) {\n        line.parent = null;\n        spans.detachMarkedSpans(line);\n    }\n    let styleToClassCache = {}, styleToClassCacheWithMode = {};\n    function interpretTokenStyle(style, options) {\n        if (!style || /^\\s*$/.test(style))\n            return null;\n        let cache = options.addModeClass ? styleToClassCacheWithMode : styleToClassCache;\n        return cache[style] || (cache[style] = style.replace(/\\S+/g, 'cm-$&'));\n    }\n    function buildLineContent(cm, lineView) {\n        let content = dom.eltP('span', null, null, browser.webkit ? 'padding-right: .1px' : null);\n        let builder = {\n            pre: dom.eltP('pre', [content], 'CodeMirror-line'),\n            content: content,\n            col: 0,\n            pos: 0,\n            cm: cm,\n            trailingSpace: false,\n            splitSpaces: cm.getOption('lineWrapping')\n        };\n        lineView.measure = {};\n        for (let i = 0; i <= (lineView.rest ? lineView.rest.length : 0); i++) {\n            let line = i ? lineView.rest[i - 1] : lineView.line, order;\n            builder.pos = 0;\n            builder.addToken = buildToken;\n            if (feature_detection.hasBadBidiRects(cm.display.measure) && (order = bidi.getOrder(line, cm.doc.direction)))\n                builder.addToken = buildTokenBadBidi(builder.addToken, order);\n            builder.map = [];\n            let allowFrontierUpdate = lineView != cm.display.externalMeasured && m_utils_line.lineNo(line);\n            insertLineContent(line, builder, highlight.getLineStyles(cm, line, allowFrontierUpdate));\n            if (line.styleClasses) {\n                if (line.styleClasses.bgClass)\n                    builder.bgClass = dom.joinClasses(line.styleClasses.bgClass, builder.bgClass || '');\n                if (line.styleClasses.textClass)\n                    builder.textClass = dom.joinClasses(line.styleClasses.textClass, builder.textClass || '');\n            }\n            if (builder.map.length == 0)\n                builder.map.push(0, 0, builder.content.appendChild(feature_detection.zeroWidthElement(cm.display.measure)));\n            if (i == 0) {\n                lineView.measure.map = builder.map;\n                lineView.measure.cache = {};\n            } else {\n                ;\n                (lineView.measure.maps || (lineView.measure.maps = [])).push(builder.map);\n                (lineView.measure.caches || (lineView.measure.caches = [])).push({});\n            }\n        }\n        if (browser.webkit) {\n            let last = builder.content.lastChild;\n            if (/\\bcm-tab\\b/.test(last.className) || last.querySelector && last.querySelector('.cm-tab'))\n                builder.content.className = 'cm-tab-wrap-hack';\n        }\n        events.signal(cm, 'renderLine', cm, lineView.line, builder.pre);\n        if (builder.pre.className)\n            builder.textClass = dom.joinClasses(builder.pre.className, builder.textClass || '');\n        return builder;\n    }\n    function defaultSpecialCharPlaceholder(ch) {\n        let token = dom.elt('span', '\\u2022', 'cm-invalidchar');\n        token.title = '\\\\u' + ch.charCodeAt(0).toString(16);\n        token.setAttribute('aria-label', token.title);\n        return token;\n    }\n    function buildToken(builder, text, style, startStyle, endStyle, css, attributes) {\n        if (!text)\n            return;\n        let displayText = builder.splitSpaces ? splitSpaces(text, builder.trailingSpace) : text;\n        let special = builder.cm.state.specialChars, mustWrap = false;\n        let content;\n        if (!special.test(text)) {\n            builder.col += text.length;\n            content = document.createTextNode(displayText);\n            builder.map.push(builder.pos, builder.pos + text.length, content);\n            if (browser.ie && browser.ie_version < 9)\n                mustWrap = true;\n            builder.pos += text.length;\n        } else {\n            content = document.createDocumentFragment();\n            let pos = 0;\n            while (true) {\n                special.lastIndex = pos;\n                let m = special.exec(text);\n                let skipped = m ? m.index - pos : text.length - pos;\n                if (skipped) {\n                    let txt = document.createTextNode(displayText.slice(pos, pos + skipped));\n                    if (browser.ie && browser.ie_version < 9)\n                        content.appendChild(dom.elt('span', [txt]));\n                    else\n                        content.appendChild(txt);\n                    builder.map.push(builder.pos, builder.pos + skipped, txt);\n                    builder.col += skipped;\n                    builder.pos += skipped;\n                }\n                if (!m)\n                    break;\n                pos += skipped + 1;\n                let txt;\n                if (m[0] == '\\t') {\n                    let tabSize = builder.cm.options.tabSize, tabWidth = tabSize - builder.col % tabSize;\n                    txt = content.appendChild(dom.elt('span', misc.spaceStr(tabWidth), 'cm-tab'));\n                    txt.setAttribute('role', 'presentation');\n                    txt.setAttribute('cm-text', '\\t');\n                    builder.col += tabWidth;\n                } else if (m[0] == '\\r' || m[0] == '\\n') {\n                    txt = content.appendChild(dom.elt('span', m[0] == '\\r' ? '\\u240D' : '\\u2424', 'cm-invalidchar'));\n                    txt.setAttribute('cm-text', m[0]);\n                    builder.col += 1;\n                } else {\n                    txt = builder.cm.options.specialCharPlaceholder(m[0]);\n                    txt.setAttribute('cm-text', m[0]);\n                    if (browser.ie && browser.ie_version < 9)\n                        content.appendChild(dom.elt('span', [txt]));\n                    else\n                        content.appendChild(txt);\n                    builder.col += 1;\n                }\n                builder.map.push(builder.pos, builder.pos + 1, txt);\n                builder.pos++;\n            }\n        }\n        builder.trailingSpace = displayText.charCodeAt(text.length - 1) == 32;\n        if (style || startStyle || endStyle || mustWrap || css) {\n            let fullStyle = style || '';\n            if (startStyle)\n                fullStyle += startStyle;\n            if (endStyle)\n                fullStyle += endStyle;\n            let token = dom.elt('span', [content], fullStyle, css);\n            if (attributes) {\n                for (let attr in attributes)\n                    if (attributes.hasOwnProperty(attr) && attr != 'style' && attr != 'class')\n                        token.setAttribute(attr, attributes[attr]);\n            }\n            return builder.content.appendChild(token);\n        }\n        builder.content.appendChild(content);\n    }\n    function splitSpaces(text, trailingBefore) {\n        if (text.length > 1 && !/  /.test(text))\n            return text;\n        let spaceBefore = trailingBefore, result = '';\n        for (let i = 0; i < text.length; i++) {\n            let ch = text.charAt(i);\n            if (ch == ' ' && spaceBefore && (i == text.length - 1 || text.charCodeAt(i + 1) == 32))\n                ch = '\\xA0';\n            result += ch;\n            spaceBefore = ch == ' ';\n        }\n        return result;\n    }\n    function buildTokenBadBidi(inner, order) {\n        return (builder, text, style, startStyle, endStyle, css, attributes) => {\n            style = style ? style + ' cm-force-border' : 'cm-force-border';\n            let start = builder.pos, end = start + text.length;\n            for (;;) {\n                let part;\n                for (let i = 0; i < order.length; i++) {\n                    part = order[i];\n                    if (part.to > start && part.from <= start)\n                        break;\n                }\n                if (part.to >= end)\n                    return inner(builder, text, style, startStyle, endStyle, css, attributes);\n                inner(builder, text.slice(0, part.to - start), style, startStyle, null, css, attributes);\n                startStyle = null;\n                text = text.slice(part.to - start);\n                start = part.to;\n            }\n        };\n    }\n    function buildCollapsedSpan(builder, size, marker, ignoreWidget) {\n        let widget = !ignoreWidget && marker.widgetNode;\n        if (widget)\n            builder.map.push(builder.pos, builder.pos + size, widget);\n        if (!ignoreWidget && builder.cm.display.input.needsContentAttribute) {\n            if (!widget)\n                widget = builder.content.appendChild(document.createElement('span'));\n            widget.setAttribute('cm-marker', marker.id);\n        }\n        if (widget) {\n            builder.cm.display.input.setUneditable(widget);\n            builder.content.appendChild(widget);\n        }\n        builder.pos += size;\n        builder.trailingSpace = false;\n    }\n    function insertLineContent(line, builder, styles) {\n        let spans = line.markedSpans, allText = line.text, at = 0;\n        if (!spans) {\n            for (let i = 1; i < styles.length; i += 2)\n                builder.addToken(builder, allText.slice(at, at = styles[i]), interpretTokenStyle(styles[i + 1], builder.cm.options));\n            return;\n        }\n        let len = allText.length, pos = 0, i = 1, text = '', style, css;\n        let nextChange = 0, spanStyle, spanEndStyle, spanStartStyle, collapsed, attributes;\n        for (;;) {\n            if (nextChange == pos) {\n                spanStyle = spanEndStyle = spanStartStyle = css = '';\n                attributes = null;\n                collapsed = null;\n                nextChange = Infinity;\n                let foundBookmarks = [], endStyles;\n                for (let j = 0; j < spans.length; ++j) {\n                    let sp = spans[j], m = sp.marker;\n                    if (m.type == 'bookmark' && sp.from == pos && m.widgetNode) {\n                        foundBookmarks.push(m);\n                    } else if (sp.from <= pos && (sp.to == null || sp.to > pos || m.collapsed && sp.to == pos && sp.from == pos)) {\n                        if (sp.to != null && sp.to != pos && nextChange > sp.to) {\n                            nextChange = sp.to;\n                            spanEndStyle = '';\n                        }\n                        if (m.className)\n                            spanStyle += ' ' + m.className;\n                        if (m.css)\n                            css = (css ? css + ';' : '') + m.css;\n                        if (m.startStyle && sp.from == pos)\n                            spanStartStyle += ' ' + m.startStyle;\n                        if (m.endStyle && sp.to == nextChange)\n                            (endStyles || (endStyles = [])).push(m.endStyle, sp.to);\n                        if (m.title)\n                            (attributes || (attributes = {})).title = m.title;\n                        if (m.attributes) {\n                            for (let attr in m.attributes)\n                                (attributes || (attributes = {}))[attr] = m.attributes[attr];\n                        }\n                        if (m.collapsed && (!collapsed || spans.compareCollapsedMarkers(collapsed.marker, m) < 0))\n                            collapsed = sp;\n                    } else if (sp.from > pos && nextChange > sp.from) {\n                        nextChange = sp.from;\n                    }\n                }\n                if (endStyles)\n                    for (let j = 0; j < endStyles.length; j += 2)\n                        if (endStyles[j + 1] == nextChange)\n                            spanEndStyle += ' ' + endStyles[j];\n                if (!collapsed || collapsed.from == pos)\n                    for (let j = 0; j < foundBookmarks.length; ++j)\n                        buildCollapsedSpan(builder, 0, foundBookmarks[j]);\n                if (collapsed && (collapsed.from || 0) == pos) {\n                    buildCollapsedSpan(builder, (collapsed.to == null ? len + 1 : collapsed.to) - pos, collapsed.marker, collapsed.from == null);\n                    if (collapsed.to == null)\n                        return;\n                    if (collapsed.to == pos)\n                        collapsed = false;\n                }\n            }\n            if (pos >= len)\n                break;\n            let upto = Math.min(len, nextChange);\n            while (true) {\n                if (text) {\n                    let end = pos + text.length;\n                    if (!collapsed) {\n                        let tokenText = end > upto ? text.slice(0, upto - pos) : text;\n                        builder.addToken(builder, tokenText, style ? style + spanStyle : spanStyle, spanStartStyle, pos + tokenText.length == nextChange ? spanEndStyle : '', css, attributes);\n                    }\n                    if (end >= upto) {\n                        text = text.slice(upto - pos);\n                        pos = upto;\n                        break;\n                    }\n                    pos = end;\n                    spanStartStyle = '';\n                }\n                text = allText.slice(at, at = styles[i++]);\n                style = interpretTokenStyle(styles[i++], builder.cm.options);\n            }\n        }\n    }\n    function LineView(doc, line, lineN) {\n        this.line = line;\n        this.rest = spans.visualLineContinued(line);\n        this.size = this.rest ? m_utils_line.lineNo(misc.lst(this.rest)) - lineN + 1 : 1;\n        this.node = this.text = null;\n        this.hidden = spans.lineIsHidden(doc, line);\n    }\n    function buildViewArray(cm, from, to) {\n        let array = [], nextPos;\n        for (let pos = from; pos < to; pos = nextPos) {\n            let view = new LineView(cm.doc, m_utils_line.getLine(cm.doc, pos), pos);\n            nextPos = pos + view.size;\n            array.push(view);\n        }\n        return array;\n    }\n    return {\n        Line: Line,\n        updateLine: updateLine,\n        cleanUpLine: cleanUpLine,\n        buildLineContent: buildLineContent,\n        defaultSpecialCharPlaceholder: defaultSpecialCharPlaceholder,\n        LineView: LineView,\n        buildViewArray: buildViewArray\n    };\n});"]}