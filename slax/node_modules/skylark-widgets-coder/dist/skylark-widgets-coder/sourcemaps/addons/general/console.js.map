{"version":3,"sources":["addons/general/console.js"],"names":["define","langx","styler","Addon","util","Coder","AddonConsole","options","autoClear","[object Object]","super","_init","coder","this","logCaptureSnippet","capture","toString","$nav","document","createElement","addClass","innerHTML","$pane","_velm","append","find","$container","querySelector","$output","$input","$inputForm","$clear","addEventListener","submit","bind","history","clear","on","priority","change","window","getMessage","$coderContainer","historyIndex","contentCache","html","css","js","getIframe","e","source","contentWindow","data","JSON","parse","err","type","log","message","params","callback","snippetlessContent","content","replace","forceRender","indexOf","console","oldConsoleLog","Function","prototype","call","slice","arguments","forEach","parent","postMessage","stringify","apply","$log","appendChild","inputValue","value","trim","preventDefault","push","length","scriptOutput","eval","scrollTop","scrollHeight","gotHistory","selectionStart","keyCode","categoryName","addonName","register"],"mappings":";;;;;;;AAAAA,QACI,sBACA,sBACA,cACA,aACA,eACD,SAAUC,EAAMC,EAAOC,EAAMC,EAAKC,GACjC,mBAEMC,UAAsBH,EAGxBI,cACI,OACGC,WAAW,GAIlBC,QACIC,MAAMC,QACN,IAAIC,EAAQC,KAAKD,MACbL,EAAUM,KAAKN,QAKfO,eAAkCD,KAAKE,QAAQC,iBAM/CC,EAAOC,SAASC,cAAc,MAClCjB,EAAOkB,SAASH,EAAM,yCACtBA,EAAKI,UAAY,uDACjB,IAAIC,EAAQJ,SAASC,cAAc,OACnCjB,EAAOkB,SAASE,EAAO,iCACvBA,EAAMD,UAAY,uVAUlBT,EAAMW,MAAMC,OAAOF,GACnBV,EAAMW,MAAME,KAAK,cAAcD,OAAOP,GACtC,IAAIS,EAAad,EAAMc,WAAWC,cAAc,4BAC5CC,EAAUhB,EAAMc,WAAWC,cAAc,yBACzCE,EAASjB,EAAMc,WAAWC,cAAc,8BACxCG,EAAalB,EAAMc,WAAWC,cAAc,wBAC5CI,EAASnB,EAAMc,WAAWC,cAAc,wBAC5CG,EAAWE,iBAAiB,SAAUnB,KAAKoB,OAAOC,KAAKrB,OACvDgB,EAAOG,iBAAiB,UAAWnB,KAAKsB,QAAQD,KAAKrB,OACrDkB,EAAOC,iBAAiB,QAASnB,KAAKuB,MAAMF,KAAKrB,QACvB,IAAtBN,EAAQC,WACRI,EAAMyB,GAAG,SAAUxB,KAAKL,UAAU0B,KAAKrB,MAAOyB,IAElD1B,EAAMyB,GAAG,SAAUxB,KAAK0B,OAAOL,KAAKrB,MArCrB,IAsCf2B,OAAOR,iBAAiB,UAAWnB,KAAK4B,WAAWP,KAAKrB,OACxDA,KAAK6B,gBAAkB9B,EAAMc,WAC7Bb,KAAKa,WAAaA,EAClBb,KAAKgB,OAASA,EACdhB,KAAKe,QAAUA,EACff,KAAKsB,WACLtB,KAAK8B,aA1Cc,EA2CnB9B,KAAKC,kBAAoBA,EACzBD,KAAK+B,cAzCDC,KAAM,GACNC,IAAK,GACLC,GAAI,IAwCRlC,KAAKmC,UAAYnC,KAAKmC,UAAUd,KAAKrB,MAEzCJ,YACI,OAAOI,KAAK6B,gBAAgBf,cAAc,6BAE9ClB,WAAWwC,GACP,GAAIA,EAAEC,SAAWrC,KAAKmC,YAAYG,cAAlC,CAGA,IAAIC,KACJ,IACIA,EAAOC,KAAKC,MAAML,EAAEG,MACtB,MAAOG,IAES,sBAAdH,EAAKI,MACL3C,KAAK4C,IAAIL,EAAKM,UAGtBjD,UAAUkD,EAAQC,GACd,IAAIC,EAAqBF,EAAOG,QACZ,OAAhBH,EAAOH,OACPK,EAAqBA,EAAmBE,QAAQlD,KAAKC,kBAAmB,MAEjD,IAAvB6C,EAAOK,aAAwBnD,KAAK+B,aAAae,EAAOH,QAAUK,GAClEhD,KAAKuB,QAETvB,KAAK+B,aAAae,EAAOH,MAAQK,EAGrCpD,OAAOwC,GACH,IAAIU,EAASV,EAAEG,KACK,OAAhBO,EAAOH,OAG6C,IAApDG,EAAOG,QAAQG,QAAQpD,KAAKC,qBAC5B6C,EAAOG,WAAcjD,KAAKC,oBAAsB6C,EAAOG,WAI/DrD,eACkC,IAAnB+B,OAAO0B,cAAyD,IAAvB1B,OAAO0B,QAAQT,MAC/DjB,OAAO0B,SACHT,IAAK,eAIb,IAAIU,EAAgBC,SAASC,UAAUnC,KAAKoC,KAAK9B,OAAO0B,QAAQT,IAAKjB,OAAO0B,SAC5E1B,OAAO0B,QAAQT,IAAM,cACdc,MAAMD,KAAKE,WAAWC,QAAQ,SAAUf,GACvClB,OAAOkC,OAAOC,YAAYtB,KAAKuB,WAC3BpB,KAAM,oBACNE,QAASA,IACT,OAERS,EAAcU,MAAMV,EAAeK,YAG3C/D,IAAIiD,EAAU,GAAIF,GACd,IAAIsB,EAAO5D,SAASC,cAAc,MAClCjB,EAAOkB,SAAS0D,EAAM,0BACF,IAATtB,GACPtD,EAAOkB,SAAS0D,uBAA4BtB,KAEhDsB,EAAKzD,UAAYqC,EACjB7C,KAAKe,QAAQmD,YAAYD,GAE7BrE,OAAOwC,GACH,IAAI+B,EAAanE,KAAKgB,OAAOoD,MAAMC,OACnC,GAAmB,KAAfF,EACA,OAAO/B,EAAEkC,iBAEbtE,KAAKsB,QAAQiD,KAAKJ,GAClBnE,KAAK8B,aAAe9B,KAAKsB,QAAQkD,OACjCxE,KAAK4C,IAAIuB,EAAY,WACgB,IAAjCA,EAAWf,QAAQ,YACnBe,EAAa,UAAYA,GAE7B,IACI,IAAIM,EAAezE,KAAKmC,YAAYG,cAAcoC,qBAAsBP,SACxEnE,KAAK4C,IAAI6B,GACX,MAAO/B,GACL1C,KAAK4C,IAAIF,EAAK,SAElB1C,KAAKgB,OAAOoD,MAAQ,GACpBpE,KAAKa,WAAW8D,UAAY3E,KAAKa,WAAW+D,aAC5CxC,EAAEkC,iBAEN1E,QACII,KAAKe,QAAQP,UAAY,GAE7BZ,QAAQwC,GACJ,IAEIyC,GAAa,EACbC,EAAiB9E,KAAKgB,OAAO8D,eAHxB,KAIL1C,EAAE2C,SAAwC,IAAtB/E,KAAK8B,cAAyC,IAAnBgD,IAC/C9E,KAAK8B,eACL+C,GAAa,GALN,KAOPzC,EAAE2C,SAAoB/E,KAAK8B,eAAiB9B,KAAKsB,QAAQkD,OAAS,GAAKM,IAAmB9E,KAAKgB,OAAOoD,MAAMI,SAC5GxE,KAAK8B,eACL+C,GAAa,GAEbA,IACA7E,KAAKgB,OAAOoD,MAAQpE,KAAKsB,QAAQtB,KAAK8B,eAI9CkD,0BACI,MAAO,UAGXC,uBACI,MAAO,WAOf,OAFAxF,EAAayF,SAAS1F,GAEfC","file":"../../../addons/general/console.js","sourcesContent":["define([\n    'skylark-langx/langx',\n    \"skylark-domx-styler\",\n    \"../../Addon\",\n    '../../util',\n    \"../../Coder\"\n], function (langx,styler,Addon,util,Coder) {\n    'use strict';\n    \n    class AddonConsole  extends Addon{\n        //constructor(coder, options) \n\n        get options() {\n            return {\n               autoClear: false \n            }\n        }\n\n        _init() {\n            super._init();\n            var coder = this.coder,\n                options = this.options;\n            \n            var priority = 30;\n            var history = [];\n            var historyIndex = 0;\n            var logCaptureSnippet = `(function ${ this.capture.toString() })();`;\n            var contentCache = {\n                html: '',\n                css: '',\n                js: ''\n            };\n            var $nav = document.createElement('li');\n            styler.addClass($nav, 'coder-nav-item coder-nav-item-console');\n            $nav.innerHTML = '<a href=\"#\" data-coder-type=\"console\">JS Console</a>';\n            var $pane = document.createElement('div');\n            styler.addClass($pane, 'coder-pane coder-pane-console');\n            $pane.innerHTML = `\n              <div class=\"coder-console-container\">\n                <ul class=\"coder-console-output\"></ul>\n                <form class=\"coder-console-input\">\n                  <input type=\"text\">\n                </form>\n              </div>\n              <button class=\"coder-button coder-console-clear\">Clear</button>\n            `;\n\n            coder._velm.append($pane);\n            coder._velm.find('.coder-nav').append($nav);\n            var $container = coder.$container.querySelector('.coder-console-container');\n            var $output = coder.$container.querySelector('.coder-console-output');\n            var $input = coder.$container.querySelector('.coder-console-input input');\n            var $inputForm = coder.$container.querySelector('.coder-console-input');\n            var $clear = coder.$container.querySelector('.coder-console-clear');\n            $inputForm.addEventListener('submit', this.submit.bind(this));\n            $input.addEventListener('keydown', this.history.bind(this));\n            $clear.addEventListener('click', this.clear.bind(this));\n            if (options.autoClear === true) {\n                coder.on('change', this.autoClear.bind(this), priority - 1);\n            }\n            coder.on('change', this.change.bind(this), priority);\n            window.addEventListener('message', this.getMessage.bind(this));\n            this.$coderContainer = coder.$container;\n            this.$container = $container;\n            this.$input = $input;\n            this.$output = $output;\n            this.history = history;\n            this.historyIndex = historyIndex;\n            this.logCaptureSnippet = logCaptureSnippet;\n            this.contentCache = contentCache;\n            this.getIframe = this.getIframe.bind(this);\n        }\n        getIframe() {\n            return this.$coderContainer.querySelector('.coder-pane-result iframe');\n        }\n        getMessage(e) {\n            if (e.source !== this.getIframe().contentWindow) {\n                return;\n            }\n            var data = {};\n            try {\n                data = JSON.parse(e.data);\n            } catch (err) {\n            }\n            if (data.type === 'coder-console-log') {\n                this.log(data.message);\n            }\n        }\n        autoClear(params, callback) {\n            var snippetlessContent = params.content;\n            if (params.type === 'js') {\n                snippetlessContent = snippetlessContent.replace(this.logCaptureSnippet, '');\n            }\n            if (params.forceRender === true || this.contentCache[params.type] !== snippetlessContent) {\n                this.clear();\n            }\n            this.contentCache[params.type] = snippetlessContent;\n            //callback(null, params);\n        }\n        change(e) {\n            var params = e.data;\n            if (params.type !== 'js') {\n                return //callback(null, params);\n            }\n            if (params.content.indexOf(this.logCaptureSnippet) === -1) {\n                params.content = `${ this.logCaptureSnippet }${ params.content }`;\n            }\n            //callback(null, params);\n        }\n        capture() {\n            if (typeof window.console === 'undefined' || typeof window.console.log === 'undefined') {\n                window.console = {\n                    log: function () {\n                    }\n                };\n            }\n            var oldConsoleLog = Function.prototype.bind.call(window.console.log, window.console);\n            window.console.log = function () {\n                [].slice.call(arguments).forEach(function (message) {\n                    window.parent.postMessage(JSON.stringify({\n                        type: 'coder-console-log',\n                        message: message\n                    }), '*');\n                });\n                oldConsoleLog.apply(oldConsoleLog, arguments);\n            };\n        }\n        log(message = '', type) {\n            var $log = document.createElement('li');\n            styler.addClass($log, 'coder-console-log');\n            if (typeof type !== 'undefined') {\n                styler.addClass($log, `coder-console-log-${ type }`);\n            }\n            $log.innerHTML = message;\n            this.$output.appendChild($log);\n        }\n        submit(e) {\n            var inputValue = this.$input.value.trim();\n            if (inputValue === '') {\n                return e.preventDefault();\n            }\n            this.history.push(inputValue);\n            this.historyIndex = this.history.length;\n            this.log(inputValue, 'history');\n            if (inputValue.indexOf('return') !== 0) {\n                inputValue = 'return ' + inputValue;\n            }\n            try {\n                var scriptOutput = this.getIframe().contentWindow.eval(`(function() {${ inputValue }})()`);\n                this.log(scriptOutput);\n            } catch (err) {\n                this.log(err, 'error');\n            }\n            this.$input.value = '';\n            this.$container.scrollTop = this.$container.scrollHeight;\n            e.preventDefault();\n        }\n        clear() {\n            this.$output.innerHTML = '';\n        }\n        history(e) {\n            var UP = 38;\n            var DOWN = 40;\n            var gotHistory = false;\n            var selectionStart = this.$input.selectionStart;\n            if (e.keyCode === UP && this.historyIndex !== 0 && selectionStart === 0) {\n                this.historyIndex--;\n                gotHistory = true;\n            }\n            if (e.keyCode === DOWN && this.historyIndex !== this.history.length - 1 && selectionStart === this.$input.value.length) {\n                this.historyIndex++;\n                gotHistory = true;\n            }\n            if (gotHistory) {\n                this.$input.value = this.history[this.historyIndex];\n            }\n        }\n\n        static get categoryName() {\n            return \"general\";\n        }\n\n        static get addonName(){\n            return \"console\";\n        }\n        \n    };\n\n    AddonConsole.register(Coder);\n\n    return AddonConsole;\n});"]}