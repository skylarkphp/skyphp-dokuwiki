/**
 * skylark-widgets-textpad - The skylark text editor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-textpad/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query","skylark-widgets-base/Widget","skylark-codemirror/CodeMirror","skylark-easyeditor/EasyEditor","./textpad","./Preview","./helper"],function(t,e,i,o,r,n,s,l){var a=i.inherit({options:{addons:[],iframe:!1,mode:"split",markdown:!1,autocomplete:!0,height:500,maxsplitsize:1e3,codemirror:{mode:"htmlmixed",lineWrapping:!0,dragDrop:!1,autoCloseTags:!0,matchTags:!0,autoCloseBrackets:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!1,tabSize:4,hintOptions:{completionSingle:!1}},toolbar:["bold","italic","strike","link","image","blockquote","listUl","listOl"],lblPreview:"Preview",lblCodeview:"HTML",lblMarkedview:"Markdown",template:['<div class="uk-htmleditor uk-clearfix" data-mode="split">','<div class="uk-htmleditor-navbar">','<ul class="uk-htmleditor-navbar-nav uk-htmleditor-toolbar"></ul>','<div class="uk-htmleditor-navbar-flip">','<ul class="uk-htmleditor-navbar-nav">','<li class="uk-htmleditor-button-code"><a>{:lblCodeview}</a></li>','<li class="uk-htmleditor-button-preview"><a>{:lblPreview}</a></li>','<li><a data-htmleditor-button="fullscreen"><i class="fa fa-expand"></i></a></li>',"</ul>","</div>","</div>",'<div class="uk-htmleditor-content">','<div class="uk-htmleditor-code"></div>','<div class="uk-htmleditor-preview"><div></div></div>',"</div>","</div>"].join("")},_init:function(){var t=this,i=this.options.template;this.element=e(this._elm),this.options.iframe=!0,this.CodeMirror=this.options.CodeMirror||o,this.buttons={},this.addButtons({fullscreen:{title:"Fullscreen",label:'<i class="fa fa-expand"></i>'},bold:{title:"Bold",label:'<i class="fa fa-bold"></i>'},italic:{title:"Italic",label:'<i class="fa fa-italic"></i>'},strike:{title:"Strikethrough",label:'<i class="fa fa-strikethrough"></i>'},blockquote:{title:"Blockquote",label:'<i class="fa fa-quote-right"></i>'},link:{title:"Link",label:'<i class="fa fa-link"></i>'},image:{title:"Image",label:'<i class="fa fa-image"></i>'},listUl:{title:"Unordered List",label:'<i class="fa fa-list-ul"></i>'},listOl:{title:"Ordered List",label:'<i class="fa fa-list-ol"></i>'}}),i=(i=i.replace(/\{:lblPreview}/g,this.options.lblPreview)).replace(/\{:lblCodeview}/g,this.options.lblCodeview),this.htmleditor=e(i),this.content=this.htmleditor.find(".uk-htmleditor-content"),this.toolbar=this.htmleditor.find(".uk-htmleditor-toolbar"),e(this.toolbar).attr("unselectable","on").css("user-select","none").on("selectstart",!1),this.preview=this.htmleditor.find(".uk-htmleditor-preview").children().eq(0),this.code=this.htmleditor.find(".uk-htmleditor-code"),this.element.before(this.htmleditor).appendTo(this.code),this.editor=this.CodeMirror.fromTextArea(this.element[0],this.options.codemirror),this.editor.htmleditor=this,this.editor.on("change",l.debounce(function(){t.render()},150)),this.editor.on("change",function(){t.editor.save(),t.element.trigger("input")}),this.code.find(".CodeMirror").css("height",this.options.height),this.options.iframe?(this.iframe=e('<iframe class="uk-htmleditor-iframe" frameborder="0" scrolling="auto" height="100" width="100%"></iframe>'),this.preview.append(this.iframe),this.iframe[0].contentWindow.document.open(),this.iframe[0].contentWindow.document.close(),this.preview.container=e(this.iframe[0].contentWindow.document).find("body"),"string"==typeof this.options.iframe&&this.preview.container.parent().append('<link rel="stylesheet" href="'+this.options.iframe+'">')):this.preview.container=this.preview,this.previewer=this.preview.container.plugin("lark.codeeditor.preview"),e(window).on("resize load",l.debounce(function(){t.fit()},200));var r=this.iframe?this.preview.container:t.preview.parent(),n=this.code.find(".CodeMirror-sizer"),s=this.code.find(".CodeMirror-scroll").on("scroll",l.debounce(function(){if("tab"!=t.htmleditor.attr("data-mode")){var e=n.height()-s.height(),i=(r[0].scrollHeight-(t.iframe?t.iframe.height():r.height()))/e,o=s.scrollTop()*i;r.scrollTop(o)}},10));this.htmleditor.on("click",".uk-htmleditor-button-code, .uk-htmleditor-button-preview",function(i){i.preventDefault(),"tab"==t.htmleditor.attr("data-mode")&&(t.htmleditor.find(".uk-htmleditor-button-code, .uk-htmleditor-button-preview").removeClass("uk-active").filter(this).addClass("uk-active"),t.activetab=e(this).hasClass("uk-htmleditor-button-code")?"code":"preview","code"==t.activetab&&t.editor.setValue(t.previewer.toMd()),t.htmleditor.attr("data-active-tab",t.activetab),t.editor.refresh())}),this.htmleditor.on("click","a[data-htmleditor-button]",function(){t.code.is(":visible")?t.trigger("action."+e(this).data("htmleditor-button"),[t.editor]):t.previewer[e(this).data("htmleditor-button")]()}),this.preview.parent().css("height",this.code.height()),this.options.autocomplete&&this.CodeMirror.showHint&&this.CodeMirror.hint&&this.CodeMirror.hint.html&&this.editor.on("inputRead",l.debounce(function(){var e=t.editor.getDoc().getCursor();if("xml"==t.CodeMirror.innerMode(t.editor.getMode(),t.editor.getTokenAt(e).state).mode.name){var i=t.editor.getCursor(),o=t.editor.getTokenAt(i);"<"!=o.string.charAt(0)&&"attribute"!=o.type||t.CodeMirror.showHint(t.editor,t.CodeMirror.hint.html,{completeSingle:!1})}},100)),this.addons=[],(this.options.addons.length?this.options.addons:Object.keys(d)).forEach(function(e){d[e].init&&(d[e].init(t),t.addons[e]=!0)}),this.debouncedRedraw=l.debounce(function(){t.redraw()},5),t.debouncedRedraw(),this.element.attr("data-uk-check-display",1).on("display.uk.check",function(t){this.htmleditor.is(":visible")&&this.fit()}.bind(this))},addButton:function(t,e){this.buttons[t]=e},addButtons:function(e){t.extend(this.buttons,e)},replaceInPreview:function(t,e){var i=this.editor,o=[],r=i.getValue(),n=-1,s=0;function l(t){var e=i.getValue().substring(0,t).split("\n");return{line:e.length-1,ch:e[e.length-1].length}}return this.currentvalue=this.currentvalue.replace(t,function(){var t={matches:arguments,from:l(n=r.indexOf(arguments[0],++n)),to:l(n+arguments[0].length),replace:function(e){i.replaceRange(e,t.from,t.to)},inRange:function(e){return e.line===t.from.line&&e.line===t.to.line?e.ch>=t.from.ch&&e.ch<t.to.ch:e.line===t.from.line&&e.ch>=t.from.ch||e.line>t.from.line&&e.line<t.to.line||e.line===t.to.line&&e.ch<t.to.ch}},a="string"==typeof e?e:e(t,s);return a||""===a?(s++,o.push(t),a):arguments[0]}),o},_buildtoolbar:function(){if(this.options.toolbar&&this.options.toolbar.length){var t=this,e=[];this.toolbar.empty(),this.options.toolbar.forEach(function(i){if(t.buttons[i]){var o=t.buttons[i].title?t.buttons[i].title:i;e.push('<li><a data-htmleditor-button="'+i+'" title="'+o+'" data-uk-tooltip>'+t.buttons[i].label+"</a></li>")}}),this.toolbar.html(e.join("\n"))}},fit:function(){var t=this.options.mode;"split"==t&&this.htmleditor.width()<this.options.maxsplitsize&&(t="tab"),"tab"==t&&(this.activetab||(this.activetab="code",this.htmleditor.attr("data-active-tab",this.activetab)),this.htmleditor.find(".uk-htmleditor-button-code, .uk-htmleditor-button-preview").removeClass("uk-active").filter("code"==this.activetab?".uk-htmleditor-button-code":".uk-htmleditor-button-preview").addClass("uk-active")),this.previewer.readonly("tab"==t),this.editor.refresh(),this.preview.parent().css("height",this.code.height()),this.htmleditor.attr("data-mode",t)},redraw:function(){this._buildtoolbar(),this.render(),this.fit()},getMode:function(){return this.editor.getOption("mode")},getCursorMode:function(){var t={mode:"html"};return this.trigger("cursorMode",[t]),t.mode},render:function(){if(this.currentvalue=this.editor.getValue(),!this.currentvalue)return this.element.val(""),void this.preview.container.html("");this.trigger("render",[this]),this.trigger("renderLate",[this]),this.preview.container.html(this.currentvalue)},addShortcut:function(e,i){var o={};return t.isArray(e)||(e=[e]),e.forEach(function(t){o[t]=i}),this.editor.addKeyMap(o),o},addShortcutAction:function(t,e){var i=this;this.addShortcut(e,function(){i.element.trigger("action."+t,[i.editor])})},insertImage:function(t,i){if(this.code.is(":visible")){i="\n!["+i+"]("+t+")\n";this.replaceSelection(i)}else{var o='<img src="'+t+'" alt="'+i+'">';this.previewer.insertAtCaret(e(o)[0])}},replaceSelection:function(t){var e=this.editor.getSelection();if(!e.length){for(var i=this.editor.getCursor(),o=this.editor.getLine(i.line),r=i.ch,n=r;n<o.length&&/[\w$]+/.test(o.charAt(n));)++n;for(;r&&/[\w$]+/.test(o.charAt(r-1));)--r;var s=r!=n&&o.slice(r,n);s&&(this.editor.setSelection({line:i.line,ch:r},{line:i.line,ch:n}),e=s)}var l=t.replace("$1",e);this.editor.replaceSelection(l,"end"),this.editor.focus()},replaceLine:function(t){var e=this.editor.getDoc().getCursor(),i=this.editor.getLine(e.line),o=t.replace("$1",i);this.editor.replaceRange(o,{line:e.line,ch:0},{line:e.line,ch:i.length}),this.editor.setCursor({line:e.line,ch:o.length}),this.editor.focus()},save:function(){this.editor.save()},_setPreviewFocus:function(){this.previewr.win.focus();var t=this.range;t?(t.select(),t=this.range=null):editor.doc.selection&&(t=editor.doc.selection.createRange())}}),d={};return a.addon=function(t,e){d[t]=e},n.Editor=a});
//# sourceMappingURL=sourcemaps/Editor.js.map
