/**
 * skylark-widgets-textpad - The skylark text editor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-textpad/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-browser","skylark-domx-data","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-velm","skylark-domx-query","skylark-widgets-base/widget"],function(e,t,n,i,s,a,o,l,r){"use strict";return r.inherit({klassName:"Preview",pluginName:"lark.codeeditor.preview",options:{className:"easyeditor",css:null,onLoaded:null,theme:null},_init:function(){this.elem=this._elm,this.className=this.options.className,this.css=this.options.css,this.onLoaded=this.options.onLoaded,this.randomString="Cls"+Math.random().toString(36).substring(7),this.theme=this.options.theme;var e=this.doc=this._elm.ownerDocument;this.win=e.defaultView||e.parentWindow,this.attachEvents()},attachEvents:function(){this.bootstrap(),this.handleKeypress(),this.handleResizeImage(),this.utils(),null!==this.onLoaded&&this.onLoaded.call(this)},detachEvents:function(){l(this.elem).removeClass(this.className).removeAttr("contenteditable").unwrap()},bootstrap:function(){l(this.elem).attr("contentEditable",!0).addClass(this.className).wrap('<div class="'+this.className+'-wrapper"></div>'),this.$wrapperElem=l(this.elem).parent(),null!==this.css&&l(this.elem).css(this.css),this.containerClass="."+this.className+"-wrapper","string"==typeof this.elem&&(this.elem=l(this.elem).get(0)),null!==this.theme&&l(this.elem).closest(this.containerClass).addClass(this.theme)},handleKeypress:function(){var e=this;l(e.elem).keydown(function(t){13===t.keyCode&&e.isSelectionInsideElement("li")}),e.elem.addEventListener("paste",function(t){t.preventDefault();var n=t.clipboardData.getData("text/plain").replace(/\n/gi,"<br>");e.doc.execCommand("insertHTML",!1,n)})},isSelectionInsideElement:function(e){var t,n,i=this.win,s=this.doc;for(e=e.toUpperCase(),i.getSelection?(t=i.getSelection()).rangeCount>0&&(n=t.getRangeAt(0).commonAncestorContainer):(t=s.selection)&&"Control"!=t.type&&(n=t.createRange().parentElement());n;){if(1==n.nodeType&&n.tagName==e)return!0;n=n.parentNode}return!1},handleResizeImage:function(){var e=this;l("html").on(e.containerClass+" figure","click",function(e){e.stopPropagation(),l(this).addClass("is-resizable")}),l("html").on(e.containerClass+" figure.is-resizable","mousemove",function(e){l(this).find("img").css({width:l(this).width()+"px"})}),l(e.doc).click(function(){l(e.elem).find("figure").removeClass("is-resizable")})},getSelection:function(){if(this.win.getSelection){var e=this.win.getSelection();if(e.rangeCount)return e}return!1},removeFormatting:function(e){var t=e.inFullArea;if(!0===this.isSelectionOutsideOfEditor())return!1;if(!1===t){var n=this.getSelection(),i=n.toString();if(n&&i.length>0){var s=n.getRangeAt(0),a=l(s.commonAncestorContainer.parentNode);if(a.attr("class")===this.className||a.attr("class")===this.className+"-wrapper"){var o=this.doc.createElement("span");l(o).attr("data-value","temp").html(i.replace(/\n/gi,"<br>")),s.deleteContents(),s.insertNode(o),l('[data-value="temp"]').contents().unwrap()}else{var r,c=!1;l.each(a.parentsUntil(this.elem),function(e,t){r=t,c=!0}),!0===c?l(r).html(l(r).text().replace(/\n/gi,"<br>")).contents().unwrap():a.contents().unwrap()}}}else l(this.elem).html(l(this.elem).text().replace(/\n/gi,"<br>"))},removeEmptyTags:function(){l(this.elem).html(l(this.elem).html().replace(/(<(?!\/)[^>]+>)+(<\/[^>]+>)+/,""))},removeBlockElementFromSelection:function(e,t){var n="";!0===(t=void 0!==t&&t)&&(n=", br");var i=e.getRangeAt(0).cloneContents(),s=this.doc.createElement("temp");return l(s).html(i),l(s).find("h1, h2, h3, h4, h5, h6, p, div"+n).each(function(){l(this).replaceWith(this.childNodes)}),l(s).html()},wrapSelectionWithNodeName:function(e){if(!0===this.isSelectionOutsideOfEditor())return!1;var t={name:"span",blockElement:!1,style:null,class:null,attribute:null,keepHtml:!1};"string"==typeof e?t.name=e:(t.name=e.nodeName||t.name,t.blockElement=e.blockElement||t.blockElement,t.style=e.style||t.style,t.class=e.class||t.class,t.attribute=e.attribute||t.attribute,t.keepHtml=e.keepHtml||t.keepHtml);var n=this.getSelection();if(n&&n.toString().length>0&&n.rangeCount){var i=this.isAlreadyWrapped(n,t),s=n.getRangeAt(0).cloneRange(),a=this.doc.createElement(t.name);if(null===t.style&&null===t.class&&null===t.attribute||(a=this.addAttribute(a,t)),this.selectionContainsHtml(s)){if(s=n.getRangeAt(0),!0===t.keepHtml){var o=s.cloneContents(),r=this.doc.createElement("div");r.appendChild(o),l(a).html(r.innerHTML)}else a.textContent=n.toString();s.deleteContents(),s.insertNode(a),s.commonAncestorContainer.localName===t.name&&(l(s.commonAncestorContainer).contents().unwrap(),this.removeEmptyTags())}else s.surroundContents(a),n.removeAllRanges(),n.addRange(s);!0===i&&this.removeWrappedDuplicateTag(a),this.removeEmptyTags(),n.select(),s.select()}},wrapSelectionWithList:function(e){if(e=e||"ul",!0===this.isSelectionOutsideOfEditor())return!1;var t=this.getSelection();if(t&&t.toString().length>0&&t.rangeCount){var n=this.removeBlockElementFromSelection(t,!0).split("\n").filter(function(e){return""!==e}),i=l.map(n,function(e){return"<li>"+l.trim(e)+"</li>"}),s=this.doc.createElement(e);l(s).html(i);var a=t.getRangeAt(0);a.deleteContents(),a.insertNode(s),t.removeAllRanges()}},selectionContainsHtml:function(e){return e.startContainer.parentNode.className!==this.className+"-wrapper"},isAlreadyWrapped:function(e,t){var n=e.getRangeAt(0),i=l(n.commonAncestorContainer),s=!1;return i.parent().prop("tagName").toLowerCase()===t.name&&!1===i.parent().hasClass(this.className)?s=!0:!0===t.blockElement?l.each(i.parentsUntil(this.elem),function(e,t){var n=t.tagName.toLowerCase();-1!==l.inArray(n,["h1","h2","h3","h4","h5","h6"])&&(s=!0)}):l.each(i.parentsUntil(this.elem),function(e,n){n.tagName.toLowerCase()===t.name&&(s=!0)}),s},removeWrappedDuplicateTag:function(e){var t=e.tagName;l(e).unwrap(),l(e).prop("tagName")===t&&!1===l(e).parent().hasClass(this.className)&&l(e).parent().hasClass(this.className+"-wrapper")&&l(e).unwrap()},addAttribute:function(e,t){return null!==t.style&&l(e).attr("style",t.style),null!==t.class&&l(e).addClass(t.class),null!==t.attribute&&(!0===l.isArray(t.attribute)?l(e).attr(t.attribute[0],t.attribute[1]):l(e).attr(t.attribute)),e},insertAtCaret:function(e){if(!0===this.isSelectionOutsideOfEditor())return!1;this.getSelection()?this.getSelection().getRangeAt(0).insertNode(e):l(e).appendTo(this.elem)},isSelectionOutsideOfEditor:function(){return!this.elementContainsSelection(this.elem)},isActive:function(){return this.elementContainsSelection(this.elem)},readonly:function(e){return void 0===e?l(this.elem).attr("contentEditable"):(l(this.elem).attr("contentEditable",e&&!0),this)},isOrContains:function(e,t){for(;e;){if(e===t)return!0;e=e.parentNode}return!1},elementContainsSelection:function(e){var t;if(this.win.getSelection){if((t=this.win.getSelection()).rangeCount>0){for(var n=0;n<t.rangeCount;++n)if(!this.isOrContains(t.getRangeAt(n).commonAncestorContainer,e))return!1;return!0}}else if((t=this.doc.selection)&&"Control"!==t.type)return this.isOrContains(t.createRange().parentElement(),e);return!1},insertHtml:function(e){l(this.elem).find("temp").html(e)},utils:function(){var e,t=this;(l("html").on("."+t.className+"-modal-close","click",function(e){e.preventDefault(),t.closeModal("#"+l(this).closest("."+t.className+"-modal").attr("id"))}),l("."+t.randomString+"-bind").length>0)&&l("html").on(t.elem,"click keyup",function(){var n=t.elem;clearTimeout(e),e=setTimeout(function(){l("."+t.randomString+"-bind").html(l(n).html())},250)});l(t.doc).click(function(e){l("."+t.className).closest("."+t.className+"-wrapper").find("."+t.className+"-toolbar > ul > li > ul").hide()})},getYoutubeVideoIdFromUrl:function(e){if(0===e.length)return!1;return void 0!==(e=e.replace(/(>|<)/gi,"").split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/))[2]?e[2].split(/[^0-9a-z_\-]/i)[0]:e},openModal:function(e){var t=this.doc.createElement("temp");t.textContent=".",this.insertAtCaret(t),l(e).removeClass("is-hidden")},closeModal:function(e){l(e).addClass("is-hidden").find("input").val(""),l(e).find("."+this.className+"-modal-content-body-loader").css("width","0");var t=l(this.elem).find("temp");"."===t.html()?t.remove():t.contents().unwrap(),l(this.elem).focus()},bold:function(){this.doc.execCommand("Bold")},italic:function(){this.doc.execCommand("Italic")},strike:function(){this.doc.execCommand("strikethrough")},listOl:function(){this.doc.execCommand("insertorderedlist")},listUl:function(){this.doc.execCommand("insertunorderedlist")},h2:function(){this.doc.execCommand("h2")},h3:function(){this.doc.execCommand("h3")},h4:function(){this.doc.execCommand("h4")},x:function(){this.doc.execCommand("h4")},alignleft:function(){this.doc.execCommand("justifyleft")},aligncenter:function(){this.doc.execCommand("justifycenter")},alignright:function(){this.doc.execCommand("justifyright")},alignfull:function(){this.doc.execCommand("justifyfull")},blockquote:function(){this.doc.execCommand("blockquote")},code:function(){this.doc.execCommand("p")},inserthorizontalrule:function(){this.doc.execCommand("inserthorizontalrule")},image:function(){var e=prompt("Insert Image URL","http://"),t=new RegExp("^((http|https)://|(mailto:)|(//))[a-z0-9]","i");null!==e&&""!==e&&"http://"!==e&&t.test(e)&&this.doc.execCommand("insertimage",!1,e)},link:function(){var e=prompt("Insert URL","http://"),t=new RegExp("^((http|https)://|(mailto:)|(//))[a-z0-9]","i");null!==e&&""!==e&&"http://"!==e&&t.test(e)&&this.doc.execCommand("createlink",!1,e)},indent:function(){this.doc.execCommand("indent")},outdent:function(){this.doc.execCommand("outdent")},toMd:function(){return toMarkdown(this.elem.innerHTML)}})});
//# sourceMappingURL=sourcemaps/preview.js.map
