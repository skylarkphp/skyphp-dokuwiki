{"version":3,"sources":["addons/AutoSave.js"],"names":["define","$","Addon","Wordpad","i18n","AutoSave","inherit","needFocus","_init","link","name","val","_this","this","editor","_module","opts","autosave","autosavePath","path","href","location","textarea","data","pathname","replace","on","storage","set","getValue","el","closest","id","e","remove","get","is","confirm","setValue","categoryName","addonName","prototype","supported","localStorage","setItem","removeItem","_error","key","session","sessionStorage","addons","general","autoSave"],"mappings":";;;;;;;AAAAA,QACE,qBACA,6BACA,aACA,WACA,SAASC,EAAEC,EAAOC,EAAQC,GAG1B,IAAIC,EAAWH,EAAMI,SACnBC,WAAY,EAEZC,MAAQ,WAEP,IAAgBC,EAAMC,EAAMC,EAkBaC,EAhBzC,IADAC,KAAKC,OAASD,KAAKE,QACdF,KAAKG,KAAKC,YAGfJ,KAAKH,KAAqC,iBAAvBG,KAAKG,KAAKC,SAAwBJ,KAAKG,KAAKC,SAAW,WACtEJ,KAAKG,KAAKE,aACZL,KAAKM,KAAON,KAAKG,KAAKE,cAEtBT,EAAOR,EAAE,QACPmB,KAAMC,SAASD,OAEjBV,EAAOG,KAAKC,OAAOQ,SAASC,KAAK,aAAeV,KAAKH,KACrDG,KAAKM,KAAO,IAAOV,EAAK,GAAGe,SAASC,QAAQ,OAAQ,IAAIA,QAAQ,OAAQ,IAAO,aAAef,EAAO,KAElGG,KAAKM,OAGVN,KAAKC,OAAOY,GAAG,gBAA0Bd,EAItCC,KAHM,WACL,OAAOD,EAAMe,QAAQC,IAAIhB,EAAMO,KAAMP,EAAME,OAAOe,eAGtDhB,KAAKC,OAAOgB,GAAGC,QAAQ,QAAQL,GAAG,yBAA2Bb,KAAKC,OAAOkB,GAAI,SAAUpB,GACrF,OAAO,SAASqB,GACd,OAAOrB,EAAMe,QAAQO,OAAOtB,EAAMO,OAFuC,CAI1EN,QACHF,EAAME,KAAKc,QAAQQ,IAAItB,KAAKM,QAKxBR,IADSE,KAAKC,OAAOQ,SAASX,QAIlC,OAAIE,KAAKC,OAAOQ,SAASc,GAAG,2BACtBC,QAAQxB,KAAKC,OAAOQ,SAASC,KAAK,qBAAuB,4CACpDV,KAAKC,OAAOwB,SAAS3B,GAErBE,KAAKc,QAAQO,OAAOrB,KAAKM,MAG3BN,KAAKC,OAAOwB,SAAS3B,MAgEjC,OAxDAN,EAASkC,aAAe,UACxBlC,EAASmC,UAAY,WAErBnC,EAASoC,UAAUzB,MACjBC,UAAU,EACVC,aAAc,MAIhBb,EAASoC,UAAUd,SACjBe,UAAW,WAET,IAGE,OAFAC,aAAaC,QAAQ,oBAAqB,OAC1CD,aAAaE,WAAW,sBACjB,EACP,MAAOC,GAEP,OADQA,GACD,IAGXlB,IAAK,SAASmB,EAAKpC,EAAKqC,GAKtB,GAHe,MAAXA,IACFA,GAAU,GAEPnC,KAAK6B,YAIV,OADUM,EAAUC,eAAiBN,cACtBC,QAAQG,EAAKpC,IAE9BwB,IAAK,SAASY,EAAKC,GAKjB,GAHe,MAAXA,IACFA,GAAU,GAEPnC,KAAK6B,YAIV,OADUM,EAAUC,eAAiBN,cACtBI,IAEjBb,OAAQ,SAASa,EAAKC,GAKpB,GAHe,MAAXA,IACFA,GAAU,GAEPnC,KAAK6B,YAIV,OADUM,EAAUC,eAAiBN,cACtBE,WAAWE,KAIvB5C,EAAQ+C,OAAOC,QAAQC,SAAW/C","file":"../../addons/AutoSave.js","sourcesContent":["define([\r\n  \"skylark-domx-query\",\r\n  \"skylark-widgets-base/Addon\",\r\n  \"../Wordpad\",\r\n  \"../i18n\"\r\n],function($,Addon, Wordpad,i18n){ \r\n\r\n\r\n  var AutoSave = Addon.inherit({\r\n    needFocus : false,\r\n\r\n    _init : function() {\r\n\r\n\t    var currentVal, link, name, val;\r\n\t    this.editor = this._module;\r\n\t    if (!this.opts.autosave) {\r\n\t      return;\r\n\t    }\r\n\t    this.name = typeof this.opts.autosave === 'string' ? this.opts.autosave : 'simditor';\r\n\t    if (this.opts.autosavePath) {\r\n\t      this.path = this.opts.autosavePath;\r\n\t    } else {\r\n\t      link = $(\"<a/>\", {\r\n\t        href: location.href\r\n\t      });\r\n\t      name = this.editor.textarea.data('autosave') || this.name;\r\n\t      this.path = \"/\" + (link[0].pathname.replace(/\\/$/g, \"\").replace(/^\\//g, \"\")) + \"/autosave/\" + name + \"/\";\r\n\t    }\r\n\t    if (!this.path) {\r\n\t      return;\r\n\t    }\r\n\t    this.editor.on(\"valuechanged\", (function(_this) {\r\n\t      return function() {\r\n\t        return _this.storage.set(_this.path, _this.editor.getValue());\r\n\t      };\r\n\t    })(this));\r\n\t    this.editor.el.closest('form').on('ajax:success.simditor-' + this.editor.id, (function(_this) {\r\n\t      return function(e) {\r\n\t        return _this.storage.remove(_this.path);\r\n\t      };\r\n\t    })(this));\r\n\t    val = this.storage.get(this.path);\r\n\t    if (!val) {\r\n\t      return;\r\n\t    }\r\n\t    currentVal = this.editor.textarea.val();\r\n\t    if (val === currentVal) {\r\n\t      return;\r\n\t    }\r\n\t    if (this.editor.textarea.is('[data-autosave-confirm]')) {\r\n\t      if (confirm(this.editor.textarea.data('autosave-confirm') || 'Are you sure to restore unsaved changes?')) {\r\n\t        return this.editor.setValue(val);\r\n\t      } else {\r\n\t        return this.storage.remove(this.path);\r\n\t      }\r\n\t    } else {\r\n\t      return this.editor.setValue(val);\r\n\t    }\r\n\r\n    }\r\n\r\n  });\r\n\r\n\r\n  AutoSave.categoryName = \"general\";\r\n  AutoSave.addonName = 'autosave';\r\n\r\n  AutoSave.prototype.opts = {\r\n    autosave: true,\r\n    autosavePath: null\r\n  };\r\n\r\n\r\n  AutoSave.prototype.storage = {\r\n    supported: function() {\r\n      var error;\r\n      try {\r\n        localStorage.setItem('_storageSupported', 'yes');\r\n        localStorage.removeItem('_storageSupported');\r\n        return true;\r\n      } catch (_error) {\r\n        error = _error;\r\n        return false;\r\n      }\r\n    },\r\n    set: function(key, val, session) {\r\n      var storage;\r\n      if (session == null) {\r\n        session = false;\r\n      }\r\n      if (!this.supported()) {\r\n        return;\r\n      }\r\n      storage = session ? sessionStorage : localStorage;\r\n      return storage.setItem(key, val);\r\n    },\r\n    get: function(key, session) {\r\n      var storage;\r\n      if (session == null) {\r\n        session = false;\r\n      }\r\n      if (!this.supported()) {\r\n        return;\r\n      }\r\n      storage = session ? sessionStorage : localStorage;\r\n      return storage[key];\r\n    },\r\n    remove: function(key, session) {\r\n      var storage;\r\n      if (session == null) {\r\n        session = false;\r\n      }\r\n      if (!this.supported()) {\r\n        return;\r\n      }\r\n      storage = session ? sessionStorage : localStorage;\r\n      return storage.removeItem(key);\r\n    }\r\n  };\r\n\r\n  return Wordpad.addons.general.autoSave = AutoSave;\r\n\r\n});"]}